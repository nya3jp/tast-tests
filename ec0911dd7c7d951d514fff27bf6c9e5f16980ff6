{
  "comments": [
    {
      "unresolved": true,
      "key": {
        "uuid": "28731a75_47e4ed50",
        "filename": "src/chromiumos/tast/remote/wificell/fixture.go",
        "patchSetId": 3
      },
      "lineNbr": 34,
      "author": {
        "id": 1115919
      },
      "writtenOn": "2022-07-19T13:55:49Z",
      "side": 1,
      "message": "so instead this should be reduced?",
      "revId": "ec0911dd7c7d951d514fff27bf6c9e5f16980ff6",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "5ef791dd_2ca3fc09",
        "filename": "src/chromiumos/tast/remote/wificell/fixture.go",
        "patchSetId": 3
      },
      "lineNbr": 34,
      "author": {
        "id": 1530777
      },
      "writtenOn": "2022-07-19T18:52:58Z",
      "side": 1,
      "message": "Possibly, though I\u0027m not sure what to reduce it to. Before this the reboot was not there and I\u0027m not sure how much time it takes for the `tf.WifiClient().ReinitTestState` call to complete. Though, 10s is not really that much time and unless it becomes a problem later I think we should be fine leaving it as-is. If you disagree let me know and I can look more into it to find a more appropriate timeout.",
      "parentUuid": "28731a75_47e4ed50",
      "revId": "ec0911dd7c7d951d514fff27bf6c9e5f16980ff6",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "d83145bd_4ce30207",
        "filename": "src/chromiumos/tast/remote/wificell/fixture.go",
        "patchSetId": 3
      },
      "lineNbr": 34,
      "author": {
        "id": 1115919
      },
      "writtenOn": "2022-07-20T05:28:00Z",
      "side": 1,
      "message": "Oh I misread that resetTimeout was 10 mins.\n\nThus, this CL adds 10+ mins for each test, which sounds too huge.\nDo you have any estimation of total testing time added by this CL?\nAny chance to reduce the cost?",
      "parentUuid": "5ef791dd_2ca3fc09",
      "revId": "ec0911dd7c7d951d514fff27bf6c9e5f16980ff6",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "34ecc22f_15cf4067",
        "filename": "src/chromiumos/tast/remote/wificell/fixture.go",
        "patchSetId": 3
      },
      "lineNbr": 34,
      "author": {
        "id": 1530777
      },
      "writtenOn": "2022-07-21T18:50:25Z",
      "side": 1,
      "message": "I believe this is answered in my other comment as the reset timeout seems fine for now (please correct me if I misunderstood that).",
      "parentUuid": "d83145bd_4ce30207",
      "revId": "ec0911dd7c7d951d514fff27bf6c9e5f16980ff6",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "edb24ea6_d27c459e",
        "filename": "src/chromiumos/tast/remote/wificell/test_fixture.go",
        "patchSetId": 3
      },
      "lineNbr": 673,
      "author": {
        "id": 1115919
      },
      "writtenOn": "2022-07-19T13:55:49Z",
      "side": 1,
      "message": "instead of sleep, can we poll the condition that reconncting can be done?",
      "range": {
        "startLine": 671,
        "startChar": 1,
        "endLine": 673,
        "endChar": 2
      },
      "revId": "ec0911dd7c7d951d514fff27bf6c9e5f16980ff6",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "cb2749b7_b5e4f804",
        "filename": "src/chromiumos/tast/remote/wificell/test_fixture.go",
        "patchSetId": 3
      },
      "lineNbr": 673,
      "author": {
        "id": 1530777
      },
      "writtenOn": "2022-07-19T18:52:58Z",
      "side": 1,
      "message": "Unfortunately I have not yet found a reliable metric on these routers that can be checked to see if they are fully rebooted. I did poll originally for just ssh connectivity (which took about 45s-1m) but it didn\u0027t seem as reliable as what I have here. I do think this can be optimized, but I\u0027d rather handle that as a separate issue as with the timeout I have set now, an arbitrary 2m, my test results have remained consistent. Prior to the reboot it varied a lot and each time it was hard to decipher the problem (some were driver bugs, but other issues existed too we did not want to deal with fixing).\n\nI do want to optimize this down if possible as 2m per test is a long time so I\u0027ve created https://buganizer.corp.google.com/issues/239583375 to track that work.",
      "parentUuid": "edb24ea6_d27c459e",
      "range": {
        "startLine": 671,
        "startChar": 1,
        "endLine": 673,
        "endChar": 2
      },
      "revId": "ec0911dd7c7d951d514fff27bf6c9e5f16980ff6",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "ef315521_ed5681cb",
        "filename": "src/chromiumos/tast/remote/wificell/test_fixture.go",
        "patchSetId": 3
      },
      "lineNbr": 673,
      "author": {
        "id": 1115919
      },
      "writtenOn": "2022-07-20T05:28:00Z",
      "side": 1,
      "message": "45s for each test and 2m for each test have a huge gap.\nIf you work on it immediately after this CL is landed as P0 and prioritize it to any other work, landing this CL would be fine in the sense to prioritize the fix of the current issue for very short term.\nHowever, otherwise this code costs a lot to the infra, and keeping that does not sound like an option to me. Thoughts?",
      "parentUuid": "cb2749b7_b5e4f804",
      "range": {
        "startLine": 671,
        "startChar": 1,
        "endLine": 673,
        "endChar": 2
      },
      "revId": "ec0911dd7c7d951d514fff27bf6c9e5f16980ff6",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "cb008f21_d8a57fc5",
        "filename": "src/chromiumos/tast/remote/wificell/test_fixture.go",
        "patchSetId": 3
      },
      "lineNbr": 673,
      "author": {
        "id": 1530777
      },
      "writtenOn": "2022-07-21T18:50:25Z",
      "side": 1,
      "message": "Yeah it\u0027s not that I like this solution, it\u0027s just that currently it\u0027s the only thing we\u0027ve got to make OpenWrt reliably stable right now. We went through a lot of other attempts to make the OpenWrt routers more stable between tests without rebooting, but they did not reliably work so this is where we are now. This will only affect OpenWrt router testbeds, which are currently only deployed in dev labs. It will not affect our current Gale (\"Legacy\") routers.\n\nThis is also a similar solution to other OpenWrt router testing. For example, I believe Android tests actually re-image the OpenWrt router each time between tests in addition to rebooting it. I haven\u0027t seen the need for us to make it that granular (we create our test images differently) but it is more evidence that the reboot is likely a necessity.\n\nThe cost vs. benefit analysis is more of a question of do we fix all of the routers we will test with (the point of OpenWrt is to open that up), which is expensive in work time and mostly out of our control, or do we allow these wifi tests to take longer, which is expensive in infra processing time. For now, at least in our OpenWrt testing, we are leaning towards rebooting.\n\nFor the 45s-2m gap, that is to be optimized with b:239583375, which IMO would be a blocker prior to widespread rollout of OpenWrt in the lab. We just aren\u0027t there yet, we are focusing on functionality support right now.",
      "parentUuid": "ef315521_ed5681cb",
      "range": {
        "startLine": 671,
        "startChar": 1,
        "endLine": 673,
        "endChar": 2
      },
      "revId": "ec0911dd7c7d951d514fff27bf6c9e5f16980ff6",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "3ef85923_9565369d",
        "filename": "src/chromiumos/tast/remote/wificell/test_fixture.go",
        "patchSetId": 3
      },
      "lineNbr": 673,
      "author": {
        "id": 1115919
      },
      "writtenOn": "2022-07-22T14:18:07Z",
      "side": 1,
      "message": "Do you have resource estimation? How many minutes will you add by this change? And eventually reduced to some?\n\n\u003e b:239583375\n\nOk, so this is the blocker to add any other tests. Then I think this is P1.\nAlso, could you add TODOs to fixtures commenting that no more tests should use this fixture unless the bug is resolved?",
      "parentUuid": "cb008f21_d8a57fc5",
      "range": {
        "startLine": 671,
        "startChar": 1,
        "endLine": 673,
        "endChar": 2
      },
      "revId": "ec0911dd7c7d951d514fff27bf6c9e5f16980ff6",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "c035bf94_2c77e97d",
        "filename": "src/chromiumos/tast/remote/wificell/test_fixture.go",
        "patchSetId": 3
      },
      "lineNbr": 673,
      "author": {
        "id": 1530777
      },
      "writtenOn": "2022-07-22T20:49:28Z",
      "side": 1,
      "message": "I\u0027ll add a TODO for that bug, but this is *not* a blocker for using this fixture nor writing tests that use it. This only effects wificells that have OpenWrt routers, which we have none of in the general test pool. We only have them in our dev wificells and they are not yet approved to replace those in the pool, nor will they be without b:239583375 being addressed. Without this change we have no reliable way to even use OpenWrt routers, so it\u0027s necessary to include for our continued development of OpenWrt router support.\n\nThis test fixture is handles all router types, including OpenWrt but also Gale (Legacy) and Asus AX routers. However, rebooting is limited to just OpenWrt routers and Gale and Asus AX routers will not be notably affected by this change.\n\nAs far as estimation goes, it\u0027s approximately 2m more per test/subtest. But again, this is only a for OpenWrt wificells so the general pool\u0027s time will not be affected.",
      "parentUuid": "3ef85923_9565369d",
      "range": {
        "startLine": 671,
        "startChar": 1,
        "endLine": 673,
        "endChar": 2
      },
      "revId": "ec0911dd7c7d951d514fff27bf6c9e5f16980ff6",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "e4f4721c_7e8cde1b",
        "filename": "src/chromiumos/tast/remote/wificell/test_fixture.go",
        "patchSetId": 3
      },
      "lineNbr": 673,
      "author": {
        "id": 1115919
      },
      "writtenOn": "2022-07-25T14:22:19Z",
      "side": 1,
      "message": "OK, could you add the comment that this shouldn\u0027t be used except wificells, just to clarify any code readers?",
      "parentUuid": "c035bf94_2c77e97d",
      "range": {
        "startLine": 671,
        "startChar": 1,
        "endLine": 673,
        "endChar": 2
      },
      "revId": "ec0911dd7c7d951d514fff27bf6c9e5f16980ff6",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "e967135c_14da6d5b",
        "filename": "src/chromiumos/tast/remote/wificell/test_fixture.go",
        "patchSetId": 3
      },
      "lineNbr": 673,
      "author": {
        "id": 1530777
      },
      "writtenOn": "2022-07-25T17:57:19Z",
      "side": 1,
      "message": "I\u0027m not sure what you mean, this test fixture is used only with wificells as those are the only ones with routers set up for this and all wificells use this fixture for testing. Everything in this file is for wificells.",
      "parentUuid": "e4f4721c_7e8cde1b",
      "range": {
        "startLine": 671,
        "startChar": 1,
        "endLine": 673,
        "endChar": 2
      },
      "revId": "ec0911dd7c7d951d514fff27bf6c9e5f16980ff6",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "eba7bd96_bec51b27",
        "filename": "src/chromiumos/tast/remote/wificell/test_fixture.go",
        "patchSetId": 3
      },
      "lineNbr": 685,
      "author": {
        "id": 1115919
      },
      "writtenOn": "2022-07-19T13:55:49Z",
      "side": 1,
      "message": "if newRouter fails, rd.host and rd.object holds inconsistent data.\nCan we avoid such cases?",
      "range": {
        "startLine": 676,
        "startChar": 1,
        "endLine": 685,
        "endChar": 101
      },
      "revId": "ec0911dd7c7d951d514fff27bf6c9e5f16980ff6",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "b8382a88_5cb56af5",
        "filename": "src/chromiumos/tast/remote/wificell/test_fixture.go",
        "patchSetId": 3
      },
      "lineNbr": 685,
      "author": {
        "id": 1530777
      },
      "writtenOn": "2022-07-19T18:52:58Z",
      "side": 1,
      "message": "I don\u0027t think we really can, as the ssh connection used by the previous router controller instance is already closed so it would not work either. I did actually try replacing the ssh connection within the same router controller instance first, but that proved to be more complex and error prone than simply recreating the instance.\n\nThat error should stop the testing though, and it does the same thing if it failed the first time the router was created. If the router controller fails to initialize then we can\u0027t continue the test.",
      "parentUuid": "eba7bd96_bec51b27",
      "range": {
        "startLine": 676,
        "startChar": 1,
        "endLine": 685,
        "endChar": 101
      },
      "revId": "ec0911dd7c7d951d514fff27bf6c9e5f16980ff6",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "7195bad0_6ad6550d",
        "filename": "src/chromiumos/tast/remote/wificell/test_fixture.go",
        "patchSetId": 3
      },
      "lineNbr": 685,
      "author": {
        "id": 1115919
      },
      "writtenOn": "2022-07-20T05:28:00Z",
      "side": 1,
      "message": "Could you invalidate (e.g. assign nil) object and host at least on closing?\nThen, you can hold host/object on local var first, then assign them to the member of rd when both succeeds, or discard it.\n\nif err :\u003d rd.object.Close(...); err !\u003d nil {\n  ...\n}\nif err :\u003d rd.object.StartReboot(...); err !\u003d nil {\n  ...\n}\nrd.host.Close(...)\n\n// Invalidate rd.object/host here.\n\n// Wait for the condition that reboot completed.\n\nhost, err :\u003d tf.connectCompanion(...)\nif err !\u003d nil {\n  return ...\n}\nobj, err :\u003d newRouter(...)\nif err !\u003d nil {\n  // teardown host ...\n  return ...\n}\nrd.host \u003d host\nrd.object \u003d object\n\nreturn ...",
      "parentUuid": "b8382a88_5cb56af5",
      "range": {
        "startLine": 676,
        "startChar": 1,
        "endLine": 685,
        "endChar": 101
      },
      "revId": "ec0911dd7c7d951d514fff27bf6c9e5f16980ff6",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "c8c33c33_298f8a54",
        "filename": "src/chromiumos/tast/remote/wificell/test_fixture.go",
        "patchSetId": 3
      },
      "lineNbr": 685,
      "author": {
        "id": 1530777
      },
      "writtenOn": "2022-07-21T18:50:25Z",
      "side": 1,
      "message": "I would actually rather prefer to keep the instances alive so that we don\u0027t have to check for nil everywhere before using rd.object and rd.host (it would be a substantial refactor). That way, if they are used after the reboot but before they are overwitten, which would only happen in error cleanup anyways, the user would get a nicer error message saying that connection has already been closed rather than a NPE panic that would not have error handling around it.",
      "parentUuid": "7195bad0_6ad6550d",
      "range": {
        "startLine": 676,
        "startChar": 1,
        "endLine": 685,
        "endChar": 101
      },
      "revId": "ec0911dd7c7d951d514fff27bf6c9e5f16980ff6",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "6b522549_300875fe",
        "filename": "src/chromiumos/tast/remote/wificell/test_fixture.go",
        "patchSetId": 3
      },
      "lineNbr": 685,
      "author": {
        "id": 1115919
      },
      "writtenOn": "2022-07-22T14:18:07Z",
      "side": 1,
      "message": "Crashing early is much better than running wrongly.\nSpecifically, this is the test, so crash cost is smaller than investing cost after running the program wrongly.",
      "parentUuid": "c8c33c33_298f8a54",
      "range": {
        "startLine": 676,
        "startChar": 1,
        "endLine": 685,
        "endChar": 101
      },
      "revId": "ec0911dd7c7d951d514fff27bf6c9e5f16980ff6",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "5ebf3c4a_c43f79ef",
        "filename": "src/chromiumos/tast/remote/wificell/test_fixture.go",
        "patchSetId": 3
      },
      "lineNbr": 685,
      "author": {
        "id": 1530777
      },
      "writtenOn": "2022-07-22T20:49:28Z",
      "side": 1,
      "message": "Okay you\u0027ve sold me lol. I\u0027ve done as suggested.\n\nI did keep the new host instance even if the router instance creation fails though, as that is still a valid thing to have separate from the router instance.",
      "parentUuid": "6b522549_300875fe",
      "range": {
        "startLine": 676,
        "startChar": 1,
        "endLine": 685,
        "endChar": 101
      },
      "revId": "ec0911dd7c7d951d514fff27bf6c9e5f16980ff6",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    }
  ]
}