<!DOCTYPE html>
<html>
<head><title>WebCodecs Encode test</title></head>
<body>
  <script src="third_party/mp4/mp4box.all.min.js"></script>
  <script src="third_party/mp4/mp4_demuxer.js"></script>
  <script src="webcodecs_common.js"></script>
  <script type="text/javascript">
    'use strict';

    let bitstreamSaver = new BitstreamSaver();

    let encoderInputFrames = [];
    async function DecodeFrames(videoURL, numFrames) {
      encoderInputFrames = await decodeVideoInURL(videoURL, numFrames);
      TEST.expect(encoderInputFrames.length == numFrames,
                  'Encode frames mismatch: ' + encoderInputFrames.length);
      return encoderInputFrames.length == numFrames;
    }
    async function EncodeAndSave(codec, acceleration, width, height, bitrate,
                                 framerate) {
      let encoder = await CreateEncoder(codec, acceleration, width, height,
                                        bitrate, framerate, bitstreamSaver);
      if (!encoder) {
        TEST.failExit();
        return;
      }

      for (let i = 0; i < encoderInputFrames.length; i++) {
        let frame = encoderInputFrames[i];
        if (!frame) {
          break;
        }
        encoder.encode(frame, { keyFrame: false });
        frame.close();
      }

      await encoder.flush();
      await encoder.close();

      TEST.expect(
        TEST.numEncodedFrames == encoderInputFrames.length,
        'Encode frames mismatch: ' + TEST.numEncodedFrames);
      TEST.expect(
        TEST.encoderError == 0,
        'Encoding errors occurred during the test');
      TEST.exit();
    }
  </script>
</body>
</html>
