<!DOCTYPE html>
<html>
<head><title>WebCodecs Encode test</title></head>
<body>
  <script src="third_party/mp4/mp4box.all.min.js"></script>
  <script src="third_party/mp4/mp4_demuxer.js"></script>
  <script src="webcodecs_common.js"></script>
  <script type="text/javascript">
    'use strict';

    let bitstreamSaver = new BitstreamSaver();

    async function EncodeAndSave(codec, acceleration, width, height, bitrate,
                                 framerate, numFrames, videoURL) {
      let encoder = await CreateEncoder(codec, acceleration, width, height,
                                        bitrate, framerate, bitstreamSaver);
      if (!encoder) {
        TEST.failExit();
        return;
      }

      let source = await createVideoSource(videoURL, framerate, numFrames);
      if (!source) {
        TEST.failExit();
        return;
      }
      for (let i = 0; i < numFrames; i++) {
        let frame = await source.getNextFrame();
        if (!frame) {
          break;
        }
        encoder.encode(frame, { keyFrame: false });
        frame.close();
      }

      await encoder.flush();
      await encoder.close();

      TEST.expect(
        TEST.numEncodedFrames == numFrames,
        'Encode frames mismatch: ' + TEST.numEncodedFrames);
      TEST.expect(
        TEST.encoderError == 0,
        'Encoding errors occurred during the test');
      TEST.exit();
    }
  </script>
</body>
</html>
