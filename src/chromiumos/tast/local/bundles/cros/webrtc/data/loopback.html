<!DOCTYPE html>
<html>
<head><title>RTCPeerConnection Loopback test</title></head>
<body>
  <video id="remoteVideo" autoplay muted style="max-width:100%;max-height:100%"></video>
<script src="third_party/munge_sdp.js"></script>
<script>

let localPeerConnection = new RTCPeerConnection();
let remotePeerConnection = new RTCPeerConnection();

function start(profile, width = 1280, height = 720) {
  return new Promise((resolve, reject) => {

    localPeerConnection.onicecandidate = e => remotePeerConnection.addIceCandidate(e.candidate).catch(e => reject(e.toString()));
    remotePeerConnection.onicecandidate = e => localPeerConnection.addIceCandidate(e.candidate).catch(e => reject(e.toString()));
    remotePeerConnection.ontrack = e => {
      let remoteVideo = document.getElementById('remoteVideo');
      remoteVideo.srcObject = e.streams[0];
      resolve();
    };

    const offerOptions = {
      offerToReceiveAudio: 1,
      offerToReceiveVideo: 1
    };
    const constraints =  {
      audio: false,
      video: {
        mandatory: {
          minWidth: width,
          maxWidth: width,
          minHeight: height,
          maxHeight: height
        }
      },
    };

    navigator.mediaDevices.getUserMedia(constraints)
    .then(stream => stream.getTracks().forEach(track => localPeerConnection.addTrack(track, stream)))
    .then(() => localPeerConnection.createOffer(offerOptions))
    .then(offer => {
      if (profile) {
        offer.sdp = setSdpDefaultVideoCodec(offer.sdp, profile, false, "");
      }
      localPeerConnection.setLocalDescription(offer)
    })
    .then(() => remotePeerConnection.setRemoteDescription(localPeerConnection.localDescription))
    .then(() => remotePeerConnection.createAnswer())
    .then(offer => remotePeerConnection.setLocalDescription(offer))
    .then(() => localPeerConnection.setRemoteDescription(remotePeerConnection.localDescription))
    .catch(e => reject(e.toString()));
  });
}

</script>
</body>
</html>
