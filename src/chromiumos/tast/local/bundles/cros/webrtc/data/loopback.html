<!DOCTYPE html>
<html>
<head><title>RTCPeerConnection Loopback test</title></head>
<body>
  <video id="remoteVideo" autoplay muted></video>
<script>

let localPeerConnection = new RTCPeerConnection();
let remotePeerConnection = new RTCPeerConnection();

let streamReady = false;
let error = '';

async function start() {
  localPeerConnection.onicecandidate = async e => {
    try {
      await remotePeerConnection.addIceCandidate(e.candidate);
    } catch (e) {
      error = e;
    }
  }
  remotePeerConnection.onicecandidate = async e => {
    try {
      await localPeerConnection.addIceCandidate(e.candidate);
    } catch (e) {
      error = e;
    }
  }
  remotePeerConnection.ontrack = e => {
    document.getElementById('remoteVideo').srcObject = e.streams[0];
    streamReady = true;
  };

  const offerOptions = {
    offerToReceiveAudio: 1,
    offerToReceiveVideo: 1
  };
  const constraints =  {
    audio: false,
    video: {
      width: {min: 1280},
      height: {min: 720},
    },
  };

  try {
    let stream = await navigator.mediaDevices.getUserMedia(constraints);
    stream.getTracks().forEach(track => localPeerConnection.addTrack(track, stream))

    let offer = await localPeerConnection.createOffer(offerOptions)
    localPeerConnection.setLocalDescription(offer);
    remotePeerConnection.setRemoteDescription(localPeerConnection.localDescription);

    let answer = await remotePeerConnection.createAnswer();
    remotePeerConnection.setLocalDescription(answer);
    localPeerConnection.setRemoteDescription(remotePeerConnection.localDescription);
  } catch(e) {
    error = e;
  }
}

window.onload = start;

</script>
</body>
</html>
