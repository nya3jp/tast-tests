{
  "comments": [
    {
      "key": {
        "uuid": "a53ca031_5111c00b",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 2
      },
      "lineNbr": 0,
      "author": {
        "id": 1401350
      },
      "writtenOn": "2020-09-23T07:13:25Z",
      "side": 1,
      "message": "LGTM (regarding the Go and Tast style).",
      "revId": "5cc46a1a7ed042193d14a5b27bcacc5dcdea87b9",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "748232b2_8eef1437",
        "filename": "src/chromiumos/tast/local/bundles/cros/security/mtab.go",
        "patchSetId": 2
      },
      "lineNbr": 165,
      "author": {
        "id": 1000985
      },
      "writtenOn": "2020-09-23T00:51:54Z",
      "side": 1,
      "message": "Does this mount only exist on test imageS?",
      "range": {
        "startLine": 165,
        "startChar": 2,
        "endLine": 165,
        "endChar": 26
      },
      "revId": "5cc46a1a7ed042193d14a5b27bcacc5dcdea87b9",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "1b66839f_cef020bd",
        "filename": "src/chromiumos/tast/local/bundles/cros/security/mtab.go",
        "patchSetId": 2
      },
      "lineNbr": 165,
      "author": {
        "id": 1351160
      },
      "writtenOn": "2020-09-23T01:04:24Z",
      "side": 1,
      "message": "Yes only on test images.",
      "parentUuid": "748232b2_8eef1437",
      "range": {
        "startLine": 165,
        "startChar": 2,
        "endLine": 165,
        "endChar": 26
      },
      "revId": "5cc46a1a7ed042193d14a5b27bcacc5dcdea87b9",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "ef5bdad7_ba454d55",
        "filename": "src/chromiumos/tast/local/bundles/cros/security/stateful_files.go",
        "patchSetId": 2
      },
      "lineNbr": 220,
      "author": {
        "id": 1000985
      },
      "writtenOn": "2020-09-23T00:51:22Z",
      "side": 1,
      "message": "Why is it both? This should be owned by only one user.",
      "range": {
        "startLine": 220,
        "startChar": 83,
        "endLine": 220,
        "endChar": 103
      },
      "revId": "5cc46a1a7ed042193d14a5b27bcacc5dcdea87b9",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "39b9ab44_e54f45ce",
        "filename": "src/chromiumos/tast/local/bundles/cros/security/stateful_files.go",
        "patchSetId": 2
      },
      "lineNbr": 220,
      "author": {
        "id": 1351160
      },
      "writtenOn": "2020-09-23T01:04:24Z",
      "side": 1,
      "message": "On my local it is owned by root.\nOn a CQ test run: /mnt/stateful_partition/encrypted/var/cache/dlc-images: UID 20118 (want [0]), GID 20118 (want [0])\nIt seems to be expecting root as the default, but was set to 20118.\n\ndlcservice daemon when it starts up sets this dlc-image directory to be owned by dlcservice.\nWhich should it be set to?",
      "parentUuid": "ef5bdad7_ba454d55",
      "range": {
        "startLine": 220,
        "startChar": 83,
        "endLine": 220,
        "endChar": 103
      },
      "revId": "5cc46a1a7ed042193d14a5b27bcacc5dcdea87b9",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "1ef435a0_0cfe6f7d",
        "filename": "src/chromiumos/tast/local/bundles/cros/security/stateful_files.go",
        "patchSetId": 2
      },
      "lineNbr": 220,
      "author": {
        "id": 1000985
      },
      "writtenOn": "2020-09-23T01:05:54Z",
      "side": 1,
      "message": "Are your local runs happening before dlcservice starts?\n\nWe should have a single owner here. It would be good to figure out why your local runs are not passing with 20118.",
      "parentUuid": "39b9ab44_e54f45ce",
      "range": {
        "startLine": 220,
        "startChar": 83,
        "endLine": 220,
        "endChar": 103
      },
      "revId": "5cc46a1a7ed042193d14a5b27bcacc5dcdea87b9",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "b22884c2_dd9d7240",
        "filename": "src/chromiumos/tast/local/bundles/cros/security/stateful_files.go",
        "patchSetId": 2
      },
      "lineNbr": 220,
      "author": {
        "id": 1351160
      },
      "writtenOn": "2020-09-23T01:09:17Z",
      "side": 1,
      "message": "Local run is completely after booting.\n\nlocalhost ~ # ps aux | grep dlcservice\ndlcserv+  8761  0.0  0.0  26852  7604 ?        S    16:57   0:00 /usr/sbin/dlcservice\n\nlocalhost ~ # stat /mnt/stateful_partition/var_overlay/cache/dlc-images\n  File: \u0027/mnt/stateful_partition/var_overlay/cache/dlc-images\u0027\n  Size: 4096            Blocks: 8          IO Block: 4096   directory\nDevice: 10301h/66305d   Inode: 30539786    Links: 4\nAccess: (0755/drwxr-xr-x)  Uid: (20118/dlcservice)   Gid: (20118/dlcservice)\nContext: u:object_r:unlabeled:s0\nAccess: 2020-09-22 14:42:06.433137944 -0700\nModify: 2020-09-22 08:11:48.000000000 -0700\nChange: 2020-09-22 16:57:22.345863321 -0700\n Birth: -\n\nlocalhost ~ # stat /mnt/stateful_partition/encrypted/var/cache/dlc-images\n  File: \u0027/mnt/stateful_partition/encrypted/var/cache/dlc-images\u0027\n  Size: 4096            Blocks: 8          IO Block: 4096   directory\nDevice: fd01h/64769d    Inode: 590119      Links: 2\nAccess: (0755/drwxr-xr-x)  Uid: (    0/    root)   Gid: (    0/    root)\nContext: u:object_r:cros_var_cache:s0\nAccess: 2020-09-22 16:22:36.234000083 -0700\nModify: 2020-09-22 16:22:36.234000083 -0700\nChange: 2020-09-22 16:22:36.234000083 -0700\n Birth: -",
      "parentUuid": "1ef435a0_0cfe6f7d",
      "range": {
        "startLine": 220,
        "startChar": 83,
        "endLine": 220,
        "endChar": 103
      },
      "revId": "5cc46a1a7ed042193d14a5b27bcacc5dcdea87b9",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "755aafdb_38ffe9d9",
        "filename": "src/chromiumos/tast/local/bundles/cros/security/stateful_files.go",
        "patchSetId": 2
      },
      "lineNbr": 220,
      "author": {
        "id": 1000985
      },
      "writtenOn": "2020-09-23T13:44:32Z",
      "side": 1,
      "message": "Where in the code does dlcservice configure the 20118 owner?",
      "parentUuid": "b22884c2_dd9d7240",
      "range": {
        "startLine": 220,
        "startChar": 83,
        "endLine": 220,
        "endChar": 103
      },
      "revId": "5cc46a1a7ed042193d14a5b27bcacc5dcdea87b9",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "73d24d76_a6d4a23b",
        "filename": "src/chromiumos/tast/local/bundles/cros/security/stateful_files.go",
        "patchSetId": 2
      },
      "lineNbr": 220,
      "author": {
        "id": 1351160
      },
      "writtenOn": "2020-09-23T16:13:49Z",
      "side": 1,
      "message": "It changes ownership here:\nhttps://source.corp.google.com/chromeos_public/src/platform2/dlcservice/dlcservice.conf;l\u003d19\n\nIf you also take a look at this CL\u0027s Cq-Depend and one chain after it, it will use the bind mounted path at /var/cache/dlc-images.\n\nSo I\u0027m not sure when encrypted/var/cache/dlc-images gets created.",
      "parentUuid": "755aafdb_38ffe9d9",
      "range": {
        "startLine": 220,
        "startChar": 83,
        "endLine": 220,
        "endChar": 103
      },
      "revId": "5cc46a1a7ed042193d14a5b27bcacc5dcdea87b9",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "3bc8b3dd_099ced80",
        "filename": "src/chromiumos/tast/local/bundles/cros/security/stateful_files.go",
        "patchSetId": 2
      },
      "lineNbr": 220,
      "author": {
        "id": 1351160
      },
      "writtenOn": "2020-09-29T16:25:23Z",
      "side": 1,
      "message": "@jorgelo, is it okay to proceed with checking two users?",
      "parentUuid": "73d24d76_a6d4a23b",
      "range": {
        "startLine": 220,
        "startChar": 83,
        "endLine": 220,
        "endChar": 103
      },
      "revId": "5cc46a1a7ed042193d14a5b27bcacc5dcdea87b9",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "3b1e2fe2_2dd172f6",
        "filename": "src/chromiumos/tast/local/bundles/cros/security/stateful_files.go",
        "patchSetId": 2
      },
      "lineNbr": 220,
      "author": {
        "id": 1000985
      },
      "writtenOn": "2020-09-30T13:02:08Z",
      "side": 1,
      "message": "I\u0027m not comfortable moving forward here. The fact that we need to include two users suggests there is a race somewhere, or that we\u0027re not fully understanding how the system behaves. Not understanding how the system behaves leads to security bugs.\n\nIt sounds to me like the problem here is that the init script is configuring things on the overlay directory, but the test is checking /var/cache/ directly.",
      "parentUuid": "3bc8b3dd_099ced80",
      "range": {
        "startLine": 220,
        "startChar": 83,
        "endLine": 220,
        "endChar": 103
      },
      "revId": "5cc46a1a7ed042193d14a5b27bcacc5dcdea87b9",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "2791f894_37bf1167",
        "filename": "src/chromiumos/tast/local/bundles/cros/security/stateful_files.go",
        "patchSetId": 2
      },
      "lineNbr": 220,
      "author": {
        "id": 1351160
      },
      "writtenOn": "2020-09-30T18:54:38Z",
      "side": 1,
      "message": "I think I have it narrowed down.\n\nDuring startup, if in dev mode, dev_utils will run:\n\nwhich will bind mount /mnt/stateful_partition/var_overlay/cache/dlc-images \nonto /var/cache/dlc-images\n\nThen, during dlcservice startup (system service) it sets /var/cache/dlc-images with owners dlcservice:dlcservice.\nHowever, at this time /var/cache/dlc-images has the same inode as /mnt/stateful_partition/var_overlay/cache/dlc-images and NOT /mnt/stateful_partition/encrypted/var/cache/dlc-images.\n\n\nA test run I\u0027ve done (with additional dlc-images2 being created and permissions set in the startup conf of dlcservice):\n\nlocalhost ~ # ls -il /var/cache/ | grep dlc-images\n19935971 drwxr-xr-x. 4 dlcservice dlcservice 4096 Sep 16 19:51 dlc-images\n 2179512 drwxr-xr-x. 2 dlcservice dlcservice 4096 Sep 30 11:38 dlc-images2\n\nlocalhost ~ # ls -il /mnt/stateful_partition/var_overlay/cache/ | grep dlc-images\n19935971 drwxr-xr-x. 4 dlcservice dlcservice 4096 Sep 16 19:51 dlc-images\n\nlocalhost ~ # ls -il /mnt/stateful_partition/encrypted/var/cache/ | grep dlc-images\n2179140 drwxr-xr-x. 2 root       root       4096 Sep 30 10:08 dlc-images\n2179512 drwxr-xr-x. 2 dlcservice dlcservice 4096 Sep 30 11:38 dlc-images2\n\n^^^ note the /var/cache/dlc-images2 having the same inode as /mnt/stateful_partition/encrypted/var/cache/dlc-images2, while this isn\u0027t the case for /var/cache/dlc-images.\n\n\nAny insights as to why /mnt/stateful_partition/encrypted/var/cache/dlc-images is \"dangling\"?\nAre there multiple bind mounts to /var that is messing with things?",
      "parentUuid": "3b1e2fe2_2dd172f6",
      "range": {
        "startLine": 220,
        "startChar": 83,
        "endLine": 220,
        "endChar": 103
      },
      "revId": "5cc46a1a7ed042193d14a5b27bcacc5dcdea87b9",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "24e436c2_9958d087",
        "filename": "src/chromiumos/tast/local/bundles/cros/security/stateful_files.go",
        "patchSetId": 2
      },
      "lineNbr": 220,
      "author": {
        "id": 1351160
      },
      "writtenOn": "2020-09-30T19:06:12Z",
      "side": 1,
      "message": "```\nlocalhost ~ # mount | grep dlc-images\n/dev/nvme0n1p1 on /var/cache/dlc-images type ext4 (rw,nosuid,nodev,noexec,noatime,seclabel,resgid\u003d20119,commit\u003d600,data\u003dordered)\nlocalhost ~ # ls -il /var/cache/ | grep dlc-images\n19935971 drwxr-xr-x. 4 dlcservice dlcservice 4096 Sep 16 19:51 dlc-images\n\nlocalhost ~ # umount /var/cache/dlc-images\nlocalhost ~ # ls -il /var/cache/ | grep dlc-images\n2179140 drwxr-xr-x. 2 root       root       4096 Sep 30 10:08 dlc-images\n```\n\nIt seems that after unmounting /var/cache/dlc the first time, it ends up having the same inode as the dlc-images dir in encrypted.\n\n[unencrypted] is bind mounted first, then [encrypted].\n\n@jorgelo, should the fix be to skip the encrypted mount for dlc-images? Or is there another approach to take to avoid this double mount.",
      "parentUuid": "2791f894_37bf1167",
      "range": {
        "startLine": 220,
        "startChar": 83,
        "endLine": 220,
        "endChar": 103
      },
      "revId": "5cc46a1a7ed042193d14a5b27bcacc5dcdea87b9",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "32fa91cd_cd758ae4",
        "filename": "src/chromiumos/tast/local/bundles/cros/security/stateful_files.go",
        "patchSetId": 2
      },
      "lineNbr": 220,
      "author": {
        "id": 1000985
      },
      "writtenOn": "2020-10-05T14:15:32Z",
      "side": 1,
      "message": "Can you clarify this section?\n\n\"During startup, if in dev mode, dev_utils will run:\n\nwhich will bind mount /mnt/stateful_partition/var_overlay/cache/dlc-images \nonto /var/cache/dlc-images\n\"\n\nI think the actual command there is missing.\n\nIsn\u0027t the problem that we\u0027re referring to var_overlay in the first place? Why do we need to refer to var_overlay?",
      "parentUuid": "24e436c2_9958d087",
      "range": {
        "startLine": 220,
        "startChar": 83,
        "endLine": 220,
        "endChar": 103
      },
      "revId": "5cc46a1a7ed042193d14a5b27bcacc5dcdea87b9",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "e0a8631d_f52427cd",
        "filename": "src/chromiumos/tast/local/bundles/cros/security/stateful_files.go",
        "patchSetId": 2
      },
      "lineNbr": 220,
      "author": {
        "id": 1351160
      },
      "writtenOn": "2020-10-05T18:36:17Z",
      "side": 1,
      "message": "Yes, the Cq-Depend of this CL: crrev.com/c/2404276\nBind mounts the path /mnt/stateful_partition/var_overlay/cache/dlc-images [unencrypted] onto /var/cache/dlc-images.\n\nThis happens during the last portion of chromeos-startup:\nhttps://source.corp.google.com/chromeos_public/src/platform2/init/chromeos_startup;l\u003d675?q\u003ddev_mount_packages\u0026ss\u003dpiper%2FGoogle%2Fchromeos_public\n\nAs you saw the bind mount for /var/cache/dlc-images is stacked like this:\n[TOP]\n/mnt/stateful_partition/var_overlay/cache/dlc-images [bind mount created by dev_utils.sh]\n/mnt/stateful_partition/encrypted/var/cache/dlc-images [bind mounted by who?]\n[BOTTOM]",
      "parentUuid": "32fa91cd_cd758ae4",
      "range": {
        "startLine": 220,
        "startChar": 83,
        "endLine": 220,
        "endChar": 103
      },
      "revId": "5cc46a1a7ed042193d14a5b27bcacc5dcdea87b9",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "28db972f_747de499",
        "filename": "src/chromiumos/tast/local/bundles/cros/security/stateful_files.go",
        "patchSetId": 2
      },
      "lineNbr": 220,
      "author": {
        "id": 1000985
      },
      "writtenOn": "2020-10-06T14:27:05Z",
      "side": 1,
      "message": "dev_utils.sh is not messing with the dlc-images directory, right? At most it\u0027s messing with the var_overlay directory.\n\nAnd there should be no use of var_overlay at all! var_overlay is a dev image thing only, it\u0027s not used in production.\n\nThese: https://source.corp.google.com/search?q\u003dvar_overlay\u0026sq\u003d\u0026ss\u003dpiper%2FGoogle%2Fchromeos_public:src%2Fplatform2%2Fdlcservice%2F\n\nShould not be using var_overlay in production.\n\nThe solution here is to change the dlcservice code to never use var_overlay in production.\n\nAll of these references should be /var/cache/dlcservice.",
      "parentUuid": "e0a8631d_f52427cd",
      "range": {
        "startLine": 220,
        "startChar": 83,
        "endLine": 220,
        "endChar": 103
      },
      "revId": "5cc46a1a7ed042193d14a5b27bcacc5dcdea87b9",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "b3b23bbe_ff4474c5",
        "filename": "src/chromiumos/tast/local/bundles/cros/security/stateful_files.go",
        "patchSetId": 2
      },
      "lineNbr": 220,
      "author": {
        "id": 1000985
      },
      "writtenOn": "2020-10-06T14:45:24Z",
      "side": 1,
      "message": "I think https://chromium-review.googlesource.com/c/chromiumos/platform2/+/2404276/1 is just making things harder.\n\nIIUC you want to unify the paths so that you don\u0027t need to have separate paths in production and for testing. I\u0027m not sure this is helping.\n\nThe end result of https://chromium-review.googlesource.com/c/chromiumos/platform2/+/2404276 is that the test environment is different from the production environment, so that we need to add expectations to our tests that are not true in production (there should be no var_overlay in production.)\n\nWouldn\u0027t it make more sense to have dlcservice support some sort of test prefix? I really don\u0027t understand how var_overlay is currently working for you in production images.",
      "parentUuid": "28db972f_747de499",
      "range": {
        "startLine": 220,
        "startChar": 83,
        "endLine": 220,
        "endChar": 103
      },
      "revId": "5cc46a1a7ed042193d14a5b27bcacc5dcdea87b9",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    }
  ]
}