{
  "comments": [
    {
      "key": {
        "uuid": "91037e2b_b7f37ad6",
        "filename": "src/chromiumos/tast/local/bundles/cros/video/encode_accel_jpeg_perf.go",
        "patchSetId": 1
      },
      "lineNbr": 36,
      "author": {
        "id": 1000042
      },
      "writtenOn": "2019-02-14T05:01:47Z",
      "side": 1,
      "message": "huge nit: JPEG",
      "range": {
        "startLine": 36,
        "startChar": 38,
        "endLine": 36,
        "endChar": 42
      },
      "revId": "fa575d2927338aa21235f897f1b3ae2a1a3ffa2e",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "ce178a3f_3a27fd67",
        "filename": "src/chromiumos/tast/local/bundles/cros/video/encode_accel_jpeg_perf.go",
        "patchSetId": 1
      },
      "lineNbr": 36,
      "author": {
        "id": 1288602
      },
      "writtenOn": "2019-02-15T01:55:02Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "91037e2b_b7f37ad6",
      "range": {
        "startLine": 36,
        "startChar": 38,
        "endLine": 36,
        "endChar": 42
      },
      "revId": "fa575d2927338aa21235f897f1b3ae2a1a3ffa2e",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "8ae27d0a_c93c5c22",
        "filename": "src/chromiumos/tast/local/bundles/cros/video/encode_accel_jpeg_perf.go",
        "patchSetId": 1
      },
      "lineNbr": 60,
      "author": {
        "id": 1000042
      },
      "writtenOn": "2019-02-14T05:01:47Z",
      "side": 1,
      "message": "the code from L60 to L81 looks like it\u0027s duplicated from decode_accel_jpeg_perf.go. instead of copying it, can you move it to a shared location in a subpackage?",
      "revId": "fa575d2927338aa21235f897f1b3ae2a1a3ffa2e",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "e016bb48_4ee930eb",
        "filename": "src/chromiumos/tast/local/bundles/cros/video/encode_accel_jpeg_perf.go",
        "patchSetId": 1
      },
      "lineNbr": 60,
      "author": {
        "id": 1288602
      },
      "writtenOn": "2019-02-15T01:55:02Z",
      "side": 1,
      "message": "I can\u0027t move the shortCtx, as it needs to be used when running the binary (forgot to do this in initial upload, fixed now). As for the other functionality, do you have any good suggestions about the subpackage? I moved them to cpu.go to a PrepareBenchmark() function, but better suggestions are welcome!",
      "parentUuid": "8ae27d0a_c93c5c22",
      "revId": "fa575d2927338aa21235f897f1b3ae2a1a3ffa2e",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "5ad6002d_12249244",
        "filename": "src/chromiumos/tast/local/bundles/cros/video/encode_accel_jpeg_perf.go",
        "patchSetId": 1
      },
      "lineNbr": 60,
      "author": {
        "id": 1000042
      },
      "writtenOn": "2019-02-15T04:42:36Z",
      "side": 1,
      "message": "people on the video team will have better opinions than me about whether it makes sense (and where it should go), but you could probably move all of this into a single function similar to the following (sorry, gerrit really doesn\u0027t handle long lines well in comments :-/).\n\n// SetUpBenchmark performs setup needed for running benchmarks.\n// It enables verbose logging, disables CPU frequency scaling and thermal\n// throttling, and waits for the CPU to become idle. shortCtx should be used to\n// perform testing, and a deferred call to the returned undo function should be\n// scheduled by the caller if err is non-nil.\nfunc SetUpBenchmark(ctx context.Context) (shortCtx context.Context, undo func(), err error) {\n    var vl *logging.VideoLogger\n    var restoreScaling, cancel func()\n    var restoreThrottling func(context.Context)\n    undo \u003d func() {\n        cancel()\n        if vl !\u003d nil {\n            vl.Close()\n        }\n        if restoreScaling !\u003d nil {\n            restoreScaling()\n        }\n        if restoreThrottling !\u003d nil {\n            restoreThrottling(ctx)\n        }\n    }\n\n    // Run the undo function automatically if we encounter an error.\n    cleanup :\u003d undo\n    defer func() {\n        if cleanup !\u003d nil {\n            cleanup()\n        }\n    }()\n\n    // Run all non-cleanup operations with a shorter context. This ensures\n    // thermal throttling and CPU frequency scaling get re-enabled, even when\n    // test execution exceeds the maximum time allowed.\n    shortCtx, cancel \u003d ctxutil.Shorten(ctx, 10*time.Second)\n\n    if vl, err \u003d logging.NewVideoLogger(); err !\u003d nil {\n        return shortCtx, nil, errors.Wrap(err, \"failed to set values for verbose logging\")\n    }\n\n    // CPU frequency scaling and thermal throttling might influence our test results.\n    if restoreScaling, err \u003d cpu.DisableCPUFrequencyScaling(); err !\u003d nil {\n        return shortCtx, nil, errors.Wrap(err, \"failed to disable CPU frequency scaling\")\n    }\n    if restoreThrottling, err \u003d cpu.DisableThermalThrottling(shortCtx); err !\u003d nil {\n        return shortCtx, nil, errors.Wrap(err, \"failed to disable thermal throttling\")\n    }\n\n    if err \u003d cpu.WaitForIdle(shortCtx, waitIdleCPUTimeout, idleCPUUsagePercent); err !\u003d nil {\n        return shortCtx, nil, errors.Wrap(err, \"failed waiting for CPU to become idle\")\n    }\n\n    // Disarm running the undo function now that we expect the caller to do it.\n    cleanup \u003d nil\n    return shortCtx, undo, nil\n}",
      "parentUuid": "e016bb48_4ee930eb",
      "revId": "fa575d2927338aa21235f897f1b3ae2a1a3ffa2e",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "e2ce4a14_2ff8181f",
        "filename": "src/chromiumos/tast/local/bundles/cros/video/encode_accel_jpeg_perf.go",
        "patchSetId": 1
      },
      "lineNbr": 60,
      "author": {
        "id": 1288602
      },
      "writtenOn": "2019-02-18T04:05:29Z",
      "side": 1,
      "message": "Thanks for the excellent and very detailed suggestions Dan!",
      "parentUuid": "5ad6002d_12249244",
      "revId": "fa575d2927338aa21235f897f1b3ae2a1a3ffa2e",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "557fed65_ec325ee1",
        "filename": "src/chromiumos/tast/local/bundles/cros/video/encode_accel_jpeg_perf.go",
        "patchSetId": 1
      },
      "lineNbr": 104,
      "author": {
        "id": 1000042
      },
      "writtenOn": "2019-02-14T05:01:47Z",
      "side": 1,
      "message": "as in L144, it might be a bit cleaner to just pass the outdir into this instead of a testing.State and make it return an error. your call, though",
      "revId": "fa575d2927338aa21235f897f1b3ae2a1a3ffa2e",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "fa5a54e2_7046f125",
        "filename": "src/chromiumos/tast/local/bundles/cros/video/encode_accel_jpeg_perf.go",
        "patchSetId": 1
      },
      "lineNbr": 104,
      "author": {
        "id": 1288602
      },
      "writtenOn": "2019-02-15T01:55:02Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "557fed65_ec325ee1",
      "revId": "fa575d2927338aa21235f897f1b3ae2a1a3ffa2e",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "6eb34f21_02275fe7",
        "filename": "src/chromiumos/tast/local/bundles/cros/video/encode_accel_jpeg_perf.go",
        "patchSetId": 1
      },
      "lineNbr": 112,
      "author": {
        "id": 1000042
      },
      "writtenOn": "2019-02-14T05:01:47Z",
      "side": 1,
      "message": "nit: var encodeTimesHW, encodeTimesSW []int",
      "revId": "fa575d2927338aa21235f897f1b3ae2a1a3ffa2e",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "4e3aada5_70819355",
        "filename": "src/chromiumos/tast/local/bundles/cros/video/encode_accel_jpeg_perf.go",
        "patchSetId": 1
      },
      "lineNbr": 112,
      "author": {
        "id": 1288602
      },
      "writtenOn": "2019-02-15T01:55:02Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "6eb34f21_02275fe7",
      "revId": "fa575d2927338aa21235f897f1b3ae2a1a3ffa2e",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "9ff412e2_99b0f991",
        "filename": "src/chromiumos/tast/local/bundles/cros/video/encode_accel_jpeg_perf.go",
        "patchSetId": 1
      },
      "lineNbr": 117,
      "author": {
        "id": 1000042
      },
      "writtenOn": "2019-02-14T05:01:47Z",
      "side": 1,
      "message": "please check that tokens is the expected length before indexing into it",
      "revId": "fa575d2927338aa21235f897f1b3ae2a1a3ffa2e",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "0a6a9a80_07e3255f",
        "filename": "src/chromiumos/tast/local/bundles/cros/video/encode_accel_jpeg_perf.go",
        "patchSetId": 1
      },
      "lineNbr": 117,
      "author": {
        "id": 1288602
      },
      "writtenOn": "2019-02-15T01:55:02Z",
      "side": 1,
      "message": "Good catch, thanks!",
      "parentUuid": "9ff412e2_99b0f991",
      "revId": "fa575d2927338aa21235f897f1b3ae2a1a3ffa2e",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "6084c842_fb85aa52",
        "filename": "src/chromiumos/tast/local/bundles/cros/video/encode_accel_jpeg_perf.go",
        "patchSetId": 1
      },
      "lineNbr": 119,
      "author": {
        "id": 1000042
      },
      "writtenOn": "2019-02-14T05:01:47Z",
      "side": 1,
      "message": "nit: please quote string and log error:\n\n  if err !\u003d nil {\n      s.Fatalf(\"Failed to parse time from line %q: %v\", line, err)\n  }",
      "revId": "fa575d2927338aa21235f897f1b3ae2a1a3ffa2e",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "6386dd8b_b1e6cf2e",
        "filename": "src/chromiumos/tast/local/bundles/cros/video/encode_accel_jpeg_perf.go",
        "patchSetId": 1
      },
      "lineNbr": 119,
      "author": {
        "id": 1288602
      },
      "writtenOn": "2019-02-15T01:55:02Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "6084c842_fb85aa52",
      "revId": "fa575d2927338aa21235f897f1b3ae2a1a3ffa2e",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "1f175a8a_14c65be5",
        "filename": "src/chromiumos/tast/local/bundles/cros/video/encode_accel_jpeg_perf.go",
        "patchSetId": 1
      },
      "lineNbr": 122,
      "author": {
        "id": 1000042
      },
      "writtenOn": "2019-02-14T05:01:47Z",
      "side": 1,
      "message": "nit: avoid trimming multiple times:\n\n  if name :\u003d strings.TrimSpace(tokens[0]0; name \u003d\u003d \"hw_encode_time\" {\n      ...\n  } else if name \u003d\u003d \"sw_encode_time\" {\n      ...\n\n(can also use a switch statement but i think it\u0027ll be more lines)",
      "revId": "fa575d2927338aa21235f897f1b3ae2a1a3ffa2e",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "deef2c7f_e01df7b7",
        "filename": "src/chromiumos/tast/local/bundles/cros/video/encode_accel_jpeg_perf.go",
        "patchSetId": 1
      },
      "lineNbr": 122,
      "author": {
        "id": 1288602
      },
      "writtenOn": "2019-02-15T01:55:02Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "1f175a8a_14c65be5",
      "revId": "fa575d2927338aa21235f897f1b3ae2a1a3ffa2e",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "2eb90d46_eb9354ed",
        "filename": "src/chromiumos/tast/local/bundles/cros/video/encode_accel_jpeg_perf.go",
        "patchSetId": 1
      },
      "lineNbr": 127,
      "author": {
        "id": 1000042
      },
      "writtenOn": "2019-02-14T05:01:47Z",
      "side": 1,
      "message": "nit: s.Fatalf(\"Unexpected name %q in line %q\", name, line)",
      "revId": "fa575d2927338aa21235f897f1b3ae2a1a3ffa2e",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "f49bf2d1_d9ef8a86",
        "filename": "src/chromiumos/tast/local/bundles/cros/video/encode_accel_jpeg_perf.go",
        "patchSetId": 1
      },
      "lineNbr": 127,
      "author": {
        "id": 1288602
      },
      "writtenOn": "2019-02-15T01:55:02Z",
      "side": 1,
      "message": "Thanks! It\u0027s a great idea to make error messages as clear as possible while testing :-)",
      "parentUuid": "2eb90d46_eb9354ed",
      "revId": "fa575d2927338aa21235f897f1b3ae2a1a3ffa2e",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "e4954290_36ff5de2",
        "filename": "src/chromiumos/tast/local/bundles/cros/video/encode_accel_jpeg_perf.go",
        "patchSetId": 1
      },
      "lineNbr": 144,
      "author": {
        "id": 1000042
      },
      "writtenOn": "2019-02-14T05:01:47Z",
      "side": 1,
      "message": "how about making this return an error instead of passing s? then the caller can provide more detail:\n\n  if err :\u003d calculatePercentiles(p, encodeTimesSW, ...); err !\u003d nil {\n      s.Fatal(\"Failed to calculate software percentiles: \", err)\n  }\n  if err :\u003d calculatePercentiles(p, encodeTimesHW, ...); err !\u003d nil {\n      s.Fatal(\"Failed to calculate hardware percentiles: \", err)\n  }\n  p.Save(...)\n\n  ...\n\n  func calculatePercentiles(...) error {\n      if len(encodeTimes) \u003d\u003d 0 {\n          return errors.New(\"list of encode times is empty\")\n      }",
      "revId": "fa575d2927338aa21235f897f1b3ae2a1a3ffa2e",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "a8532bf6_a3218bce",
        "filename": "src/chromiumos/tast/local/bundles/cros/video/encode_accel_jpeg_perf.go",
        "patchSetId": 1
      },
      "lineNbr": 144,
      "author": {
        "id": 1288602
      },
      "writtenOn": "2019-02-15T01:55:02Z",
      "side": 1,
      "message": "Done, thanks for the example code! :-)",
      "parentUuid": "e4954290_36ff5de2",
      "revId": "fa575d2927338aa21235f897f1b3ae2a1a3ffa2e",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    }
  ]
}