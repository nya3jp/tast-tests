{
  "comments": [
    {
      "unresolved": false,
      "key": {
        "uuid": "25cb24cd_c85e0e61",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 2
      },
      "lineNbr": 0,
      "author": {
        "id": 1394308
      },
      "writtenOn": "2021-10-25T21:10:53Z",
      "side": 1,
      "message": "Thank you for the reviews!",
      "revId": "a020fabc11cc51d02451744d1cd11f4e8d4a256b",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "8e09b5c5_cbd2368e",
        "filename": "src/chromiumos/tast/local/bundles/cros/arc/downloads.go",
        "patchSetId": 2
      },
      "lineNbr": 61,
      "author": {
        "id": 1221932
      },
      "writtenOn": "2021-10-25T03:45:09Z",
      "side": 1,
      "message": "Do you know why this is not affected by the cache issue?",
      "range": {
        "startLine": 58,
        "startChar": 1,
        "endLine": 61,
        "endChar": 44
      },
      "revId": "a020fabc11cc51d02451744d1cd11f4e8d4a256b",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "dccb93cf_7fbf07bf",
        "filename": "src/chromiumos/tast/local/bundles/cros/arc/downloads.go",
        "patchSetId": 2
      },
      "lineNbr": 61,
      "author": {
        "id": 1394308
      },
      "writtenOn": "2021-10-25T05:58:18Z",
      "side": 1,
      "message": "Hmm, TBH I\u0027m not sure. Maybe write from the Chrome OS side invalidates stale cache immediately? |actual| matches |expected| even if I insert\n  ioutil.WriteFile(crosPath, []byte(\"stale-data\"), 0666)\n\nbefore\n  ioutil.WriteFile(crosPath, expected, 0666)",
      "parentUuid": "8e09b5c5_cbd2368e",
      "range": {
        "startLine": 58,
        "startChar": 1,
        "endLine": 61,
        "endChar": 44
      },
      "revId": "a020fabc11cc51d02451744d1cd11f4e8d4a256b",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "01d1fe12_f4abf3f3",
        "filename": "src/chromiumos/tast/local/bundles/cros/arc/downloads.go",
        "patchSetId": 2
      },
      "lineNbr": 61,
      "author": {
        "id": 1394308
      },
      "writtenOn": "2021-10-25T06:17:13Z",
      "side": 1,
      "message": "FWIW,\n  a.WriteFile(ctx, androidPath, expected)\n\nin L71 of the original file succeeds without inserting a sleep if we remove\n  os.Remove(crosPath)\n\nin L66, or replace it with\n  ioutil.WriteFile(crosPath, []byte(\"stale-data\"), 0666).\n\nSo, os.Remove(crosPath) seems to trigger the adb push failure.",
      "parentUuid": "dccb93cf_7fbf07bf",
      "range": {
        "startLine": 58,
        "startChar": 1,
        "endLine": 61,
        "endChar": 44
      },
      "revId": "a020fabc11cc51d02451744d1cd11f4e8d4a256b",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "00a1ed37_86db0135",
        "filename": "src/chromiumos/tast/local/bundles/cros/arc/downloads.go",
        "patchSetId": 2
      },
      "lineNbr": 61,
      "author": {
        "id": 1221932
      },
      "writtenOn": "2021-10-25T06:42:17Z",
      "side": 1,
      "message": "I see. Thanks for the investigation. I will leave this open in case Chirantan knows what happens here.",
      "parentUuid": "01d1fe12_f4abf3f3",
      "range": {
        "startLine": 58,
        "startChar": 1,
        "endLine": 61,
        "endChar": 44
      },
      "revId": "a020fabc11cc51d02451744d1cd11f4e8d4a256b",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "1facfe21_23f9de71",
        "filename": "src/chromiumos/tast/local/bundles/cros/arc/downloads.go",
        "patchSetId": 2
      },
      "lineNbr": 61,
      "author": {
        "id": 1002983
      },
      "writtenOn": "2021-10-25T07:44:40Z",
      "side": 1,
      "message": "I think it\u0027s not a data cache but a directory cache issue.  The lines from 58-61 are writing and reading data, which fuse can handle without issue.  The problem here is the call to os.Remove() on line 67, which will delete the file on the chrome os side without the knowledge of the arcvm kernel. \n\nIn the bad case:\n\n* An entry with the exact name exists in the arcvm kernel directory entry cache.\n* The arcvm kernel sends an open request for the entry.\n* The open request fails on the virtio-fs side because the file is removed.\n\nIn the good case where a delay longer than the cache timeout is inserted:\n\n* The arcvm kernel notices that its cached directory entries are stale and sends a lookup request for the path.\n* The lookup request fails because the file has been deleted.\n* The arcvm kernel sends a create request for the path, which then succeeds.\n\nThere are a few ways we can fix this:\n\n* Insert a timeout in the test (this CL).\n* Delete the file from the android side.  This will also remove the cached entry in the arcvm kernel.\n* Set the timeout to an even smaller value (10 ms?).  This will not fix the underlying race but will make it much harder to trigger.\n* Don\u0027t allow directory entry caching.  Data caching and directory entry caching are 2 separate options but we currently use the same setting for both in the virtiofs server.  We can add a new type of cache policy that only allows data caching for a short time but not directory entry caching.",
      "parentUuid": "00a1ed37_86db0135",
      "range": {
        "startLine": 58,
        "startChar": 1,
        "endLine": 61,
        "endChar": 44
      },
      "revId": "a020fabc11cc51d02451744d1cd11f4e8d4a256b",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "149252eb_1ee2e007",
        "filename": "src/chromiumos/tast/local/bundles/cros/arc/downloads.go",
        "patchSetId": 2
      },
      "lineNbr": 61,
      "author": {
        "id": 1394308
      },
      "writtenOn": "2021-10-25T08:57:12Z",
      "side": 1,
      "message": "Thanks a lot for the detailed explanation! Now I see what\u0027s happening.\n\n\u003e There are a few ways we can fix this:\n\u003e * Insert a timeout in the test (this CL).\n\u003e * Delete the file from the android side.  This will also remove the cached entry in the arcvm kernel.\n\u003e * Set the timeout to an even smaller value (10 ms?).  This will not fix the underlying race but will make it much harder to trigger.\n\u003e * Don\u0027t allow directory entry caching.  Data caching and directory entry caching are 2 separate options but we currently use the same setting for both in the virtiofs server.  We can add a new type of cache policy that only allows data caching for a short time but not directory entry caching.\n\nI\u0027d prefer the first option for now. We can revert this CL once the issue is completely resolved.\nThe second option should work, and actually looks cleaner. On the other hand, this os.Remove() once detected a cache sync issue on the Android\u0027s FUSE layer: b/154926540#comment11. I think it\u0027s good to keep having this check so that there is a convenient way to detect a regression with regard to it, considering that the issue significantly affects what this test checks (i.e. Downloads integration).\nIIUC, the third and fourth options require crosvm and vm_tools changes. Assuming that the current configuration does not bother users so much, I guess we can leave it as-is for now. However, if you think it\u0027s reasonable to make such changes ASAP, this test can be left as-is so that it can be used to verify the fix.\nWhat do you think?",
      "parentUuid": "1facfe21_23f9de71",
      "range": {
        "startLine": 58,
        "startChar": 1,
        "endLine": 61,
        "endChar": 44
      },
      "revId": "a020fabc11cc51d02451744d1cd11f4e8d4a256b",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "e197607f_cc5c8e04",
        "filename": "src/chromiumos/tast/local/bundles/cros/arc/downloads.go",
        "patchSetId": 2
      },
      "lineNbr": 61,
      "author": {
        "id": 1002983
      },
      "writtenOn": "2021-10-25T10:00:19Z",
      "side": 1,
      "message": "I\u0027m fine with landing this for now and we can land a longer term fix later.",
      "parentUuid": "149252eb_1ee2e007",
      "range": {
        "startLine": 58,
        "startChar": 1,
        "endLine": 61,
        "endChar": 44
      },
      "revId": "a020fabc11cc51d02451744d1cd11f4e8d4a256b",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "33a4647c_7e910208",
        "filename": "src/chromiumos/tast/local/bundles/cros/arc/downloads.go",
        "patchSetId": 2
      },
      "lineNbr": 61,
      "author": {
        "id": 1394308
      },
      "writtenOn": "2021-10-25T10:13:58Z",
      "side": 1,
      "message": "I see. Thanks!",
      "parentUuid": "e197607f_cc5c8e04",
      "range": {
        "startLine": 58,
        "startChar": 1,
        "endLine": 61,
        "endChar": 44
      },
      "revId": "a020fabc11cc51d02451744d1cd11f4e8d4a256b",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "4b9fdfc5_86253161",
        "filename": "src/chromiumos/tast/local/bundles/cros/arc/downloads.go",
        "patchSetId": 2
      },
      "lineNbr": 81,
      "author": {
        "id": 1221932
      },
      "writtenOn": "2021-10-25T03:45:09Z",
      "side": 1,
      "message": "What is the threshold for the duration until the cache can be invalidated?",
      "range": {
        "startLine": 81,
        "startChar": 21,
        "endLine": 81,
        "endChar": 32
      },
      "revId": "a020fabc11cc51d02451744d1cd11f4e8d4a256b",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "c08fd2af_6c8904a7",
        "filename": "src/chromiumos/tast/local/bundles/cros/arc/downloads.go",
        "patchSetId": 2
      },
      "lineNbr": 81,
      "author": {
        "id": 1394308
      },
      "writtenOn": "2021-10-25T05:58:18Z",
      "side": 1,
      "message": "I think it\u0027s 1 second. Currently, the \"timeout\" value for the shared-dir option is set to 1 second: https://source.chromium.org/chromium/chromiumos/platform2/+/HEAD:vm_tools/concierge/vm_util.cc;l\u003d620;drc\u003d31903b7f7da738667cf0064659aabaef7b797e01\nIn my local experiment, when I set the value to 3 seconds, this test needed 3 seconds of sleep to pass.",
      "parentUuid": "4b9fdfc5_86253161",
      "range": {
        "startLine": 81,
        "startChar": 21,
        "endLine": 81,
        "endChar": 32
      },
      "revId": "a020fabc11cc51d02451744d1cd11f4e8d4a256b",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "b3c43a76_635bc210",
        "filename": "src/chromiumos/tast/local/bundles/cros/arc/downloads.go",
        "patchSetId": 2
      },
      "lineNbr": 81,
      "author": {
        "id": 1221932
      },
      "writtenOn": "2021-10-25T06:42:17Z",
      "side": 1,
      "message": "Thanks!",
      "parentUuid": "c08fd2af_6c8904a7",
      "range": {
        "startLine": 81,
        "startChar": 21,
        "endLine": 81,
        "endChar": 32
      },
      "revId": "a020fabc11cc51d02451744d1cd11f4e8d4a256b",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    }
  ]
}