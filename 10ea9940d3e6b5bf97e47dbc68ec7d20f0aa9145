{
  "comments": [
    {
      "unresolved": true,
      "key": {
        "uuid": "0e5c7322_844cb7fd",
        "filename": "src/chromiumos/tast/local/bundles/cros/inputs/physical_keyboard_emoji.go",
        "patchSetId": 1
      },
      "lineNbr": 37,
      "author": {
        "id": 1395692
      },
      "writtenOn": "2021-12-02T11:35:47Z",
      "side": 1,
      "message": "This looks a bit weird here.\n\nWe are used to something as below:\n        cleanupCtx :\u003d ctx\n\tctx, cancel :\u003d ctxutil.Shorten(ctx, 5*time.Second)\n\tdefer cancel()\n\nIt is up to the user to decide how long it takes to cleanup: defer stopRecording(cleanCtx)\n\nI do not have a good answer anyway. cc Alvin if he has any good suggestion.",
      "range": {
        "startLine": 37,
        "startChar": 1,
        "endLine": 37,
        "endChar": 4
      },
      "revId": "10ea9940d3e6b5bf97e47dbc68ec7d20f0aa9145",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "1d518325_35d50e34",
        "filename": "src/chromiumos/tast/local/bundles/cros/inputs/physical_keyboard_emoji.go",
        "patchSetId": 1
      },
      "lineNbr": 37,
      "author": {
        "id": 1450817
      },
      "writtenOn": "2021-12-03T01:32:23Z",
      "side": 1,
      "message": "I agree that it looks a bit wierd, but in this particular case the user should not decide how long it takes to cleanup.\n\nUnlike every other scenario, the cleanup time is proportional to the timeout of the test itself. If someone doubles the timeout of the test from 5m to 10m, they will also need to double the vnc cleanup time, which they will inevitably forget.\n\nAlso, this code works exactly the same way as your example above. If this becomes an issue, I can always add support for `uiauto.RecordVNCVideo(ctx, s, uiauto.VNCVideoCleanupTime(2*time.Second))` or similar.",
      "parentUuid": "0e5c7322_844cb7fd",
      "range": {
        "startLine": 37,
        "startChar": 1,
        "endLine": 37,
        "endChar": 4
      },
      "revId": "10ea9940d3e6b5bf97e47dbc68ec7d20f0aa9145",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "3ba1c856_a14f7cbc",
        "filename": "src/chromiumos/tast/local/bundles/cros/inputs/physical_keyboard_emoji.go",
        "patchSetId": 1
      },
      "lineNbr": 37,
      "author": {
        "id": 1508900
      },
      "writtenOn": "2021-12-03T02:23:21Z",
      "side": 1,
      "message": "I agree that we should not let users to decide the duration for cleanup. How about that we do something like:\n\n// New function to reserve time for recording cleanup.\nctx, cancel :\u003d uiauto.ReserveForRecordingCleanup(ctx)\ndefer cancel()\n\nstopRecording :\u003d uiauto.RecordVNCVideo(ctx, s)\ndefer stopRecording()",
      "parentUuid": "1d518325_35d50e34",
      "range": {
        "startLine": 37,
        "startChar": 1,
        "endLine": 37,
        "endChar": 4
      },
      "revId": "10ea9940d3e6b5bf97e47dbc68ec7d20f0aa9145",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "2742af4a_87195c7c",
        "filename": "src/chromiumos/tast/local/bundles/cros/inputs/physical_keyboard_emoji.go",
        "patchSetId": 1
      },
      "lineNbr": 37,
      "author": {
        "id": 1508900
      },
      "writtenOn": "2021-12-03T02:27:21Z",
      "side": 1,
      "message": "which basically does the same thing, but breaks down it into two parts.",
      "parentUuid": "3ba1c856_a14f7cbc",
      "range": {
        "startLine": 37,
        "startChar": 1,
        "endLine": 37,
        "endChar": 4
      },
      "revId": "10ea9940d3e6b5bf97e47dbc68ec7d20f0aa9145",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "0d4d9efa_4ec850d3",
        "filename": "src/chromiumos/tast/local/bundles/cros/inputs/physical_keyboard_emoji.go",
        "patchSetId": 1
      },
      "lineNbr": 37,
      "author": {
        "id": 1450817
      },
      "writtenOn": "2021-12-03T02:31:54Z",
      "side": 1,
      "message": "That code won\u0027t work - you\u0027ll actually need to do something more like this\n\ncleanupCtx :\u003d ctx\nctx, cancel :\u003d uiauto.ReserveForRecordingCleanup(ctx)\ndefer cancel()\n\nstopRecording :\u003d uiauto.RecordVNCVideo(cleanupCtx, s)\ndefer stopRecording()\n\nMy question is why would you implement it this way?\n* It adds several more potential places where people can do something wrong (eg. someone might accidentally write what you did).\n* The code is far less concise and less readable\n* Trying to check whether the code is actually correct is difficult\n* It significantly increases cognotive load\n\nUnder the hood, this works exactly the same way (I shorten it, then place the cancel in the deferred stopRecording function, so the cancel does get called correctly).",
      "parentUuid": "3ba1c856_a14f7cbc",
      "range": {
        "startLine": 37,
        "startChar": 1,
        "endLine": 37,
        "endChar": 4
      },
      "revId": "10ea9940d3e6b5bf97e47dbc68ec7d20f0aa9145",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "14269c37_1867ad2c",
        "filename": "src/chromiumos/tast/local/bundles/cros/inputs/physical_keyboard_emoji.go",
        "patchSetId": 1
      },
      "lineNbr": 37,
      "author": {
        "id": 1508900
      },
      "writtenOn": "2021-12-03T02:52:52Z",
      "side": 1,
      "message": "Right, the code above is what I meant.\n\n1, it is similar to how `shorten` is used:\ncleanupCtx :\u003d ctx\nctx, cancel :\u003d ctxutil.Shorten(ctx, 5*time.Second)\ndefer cancel()\n\nwhile another subtitute is used to avoid explicitly specifying the duration.\n\nI wouldn\u0027t worry too much about people doing something wrong, as far as I can tell, the test-writers are more and more familiar with how reserving time for cleanup works (https://chromium.googlesource.com/chromiumos/platform/tast/+/HEAD/docs/writing_tests.md#Reserve-time-for-clean_up-task) in CLs I have reviewed. Pluse, we have tast reviews to help them, also the example usage in the comment.\n\n2, As mentioned, it does exactly the same thing, but breaks down into two parts (but more cohesive).\n\n3, It might be better to give the users a clear signal that recording needs extra time for cleaning up, which can help them better decide the timeout for their test (nowadays, the test writers are encouraged to explicitly specify the test timeout, https://chromium.googlesource.com/chromiumos/platform/tast/+/HEAD/docs/writing_tests.md#:~:text\u003dTests%20should%20always%20set%20the%20Timeout%20field).\n\n`ctx, stopRecording :\u003d uiauto.RecordVNCVideo(ctx, s)` doesn\u0027t tell much about this. We should not let them decide how long it takes to clean up, but we should tell them the cleanup time is being reserved.",
      "parentUuid": "0d4d9efa_4ec850d3",
      "range": {
        "startLine": 37,
        "startChar": 1,
        "endLine": 37,
        "endChar": 4
      },
      "revId": "10ea9940d3e6b5bf97e47dbc68ec7d20f0aa9145",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "66fe4b38_d3f5034e",
        "filename": "src/chromiumos/tast/local/chrome/uiauto/screen_recorder_vnc.go",
        "patchSetId": 1
      },
      "lineNbr": 212,
      "author": {
        "id": 1395692
      },
      "writtenOn": "2021-12-02T11:35:47Z",
      "side": 1,
      "message": "nit: kill",
      "range": {
        "startLine": 212,
        "startChar": 23,
        "endLine": 212,
        "endChar": 26
      },
      "revId": "10ea9940d3e6b5bf97e47dbc68ec7d20f0aa9145",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "0faa2f30_9c032651",
        "filename": "src/chromiumos/tast/local/chrome/uiauto/screen_recorder_vnc.go",
        "patchSetId": 1
      },
      "lineNbr": 212,
      "author": {
        "id": 1450817
      },
      "writtenOn": "2021-12-03T01:32:23Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "66fe4b38_d3f5034e",
      "range": {
        "startLine": 212,
        "startChar": 23,
        "endLine": 212,
        "endChar": 26
      },
      "revId": "10ea9940d3e6b5bf97e47dbc68ec7d20f0aa9145",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    }
  ]
}