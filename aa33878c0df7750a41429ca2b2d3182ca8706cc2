{
  "comments": [
    {
      "unresolved": true,
      "key": {
        "uuid": "dcf076ba_1bea1fd5",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 4
      },
      "lineNbr": 0,
      "author": {
        "id": 1302456
      },
      "writtenOn": "2022-05-19T21:44:13Z",
      "side": 1,
      "message": "Hi Ben, PTAL.\n\nI think it might be good to expand the mock printer to return an error if it\u0027s shut down when the test case hasn\u0027t been satisfied. In our mock script here, we expect to see lpadmin send another get-printer-attributes request without the document-format attribute after we respond with a 500 Internal Server Error to the request with document-format. However, if that request never came, we wouldn\u0027t necessarily know. Alternatively, we could expand this test in the future to fully configure the printer, which would serve the same purpose and maybe give us better coverage than this first version.",
      "revId": "aa33878c0df7750a41429ca2b2d3182ca8706cc2",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "bb6d46e8_9f3f4429",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 4
      },
      "lineNbr": 0,
      "author": {
        "id": 1192536
      },
      "writtenOn": "2022-05-20T15:57:09Z",
      "side": 1,
      "message": "Agreed, it seems like the mock printer needs to indicate somewhere that all of its conditions have been satisfied.  Does it at least produce a log file we can read to confirm that all the expected requests have arrived?",
      "parentUuid": "dcf076ba_1bea1fd5",
      "revId": "aa33878c0df7750a41429ca2b2d3182ca8706cc2",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "e711ca30_9cc5ab7e",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 4
      },
      "lineNbr": 0,
      "author": {
        "id": 1302456
      },
      "writtenOn": "2022-06-16T18:59:33Z",
      "side": 1,
      "message": "I don\u0027t think there\u0027s any indication currently. TestCaseHolder has a TestCaseFinished() method that seems to be what we want. Currently, we only check for this when receiving data (which indicates an unexpected message): https://source.corp.google.com/chromeos_public/src/third_party/virtual-usb-printer/mock_printer/mock_printer.cc;rcl\u003ddf39a58e2bad34b03437e6d61807acc3e45b0bf3;l\u003d81\n\nWe could additionally check for this right before sending a response: https://source.corp.google.com/chromeos_public/src/third_party/virtual-usb-printer/mock_printer/mock_printer.cc;rcl\u003ddf39a58e2bad34b03437e6d61807acc3e45b0bf3;l\u003d135\n\nThen we could log to a file once we catch that the test case has been finished. The virtual-usb-printer already has an argument for specifying a log path: https://source.corp.google.com/chromeos_public/src/third_party/virtual-usb-printer/virtual_usb_printer.cc;rcl\u003df6958c3ca5c29ba9aaf674b9843dea0cd555c2a5;l\u003d131\n\nAt the moment, that log path is only used by the eSCL manager to do some logging, but we could have the mock printer log there as well. How does all that sound?",
      "parentUuid": "bb6d46e8_9f3f4429",
      "revId": "aa33878c0df7750a41429ca2b2d3182ca8706cc2",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "dab31e9b_9734ce20",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 4
      },
      "lineNbr": 0,
      "author": {
        "id": 1192536
      },
      "writtenOn": "2022-06-17T15:09:33Z",
      "side": 1,
      "message": "If I\u0027m understanding correctly, this combination would produce some log output when the test case was finished, and then the first check you linked would produce an error if additional requests came in.  Is that correct?  That sounds like a reasonable approach to me if that\u0027s the correct understanding.",
      "parentUuid": "e711ca30_9cc5ab7e",
      "revId": "aa33878c0df7750a41429ca2b2d3182ca8706cc2",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "72fb4312_49520d24",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 4
      },
      "lineNbr": 0,
      "author": {
        "id": 1302456
      },
      "writtenOn": "2022-06-21T20:53:58Z",
      "side": 1,
      "message": "The first check I linked is active today, and logs an error to /var/log/messages if additional requests come in after the test case is finished. This behavior exists today. We could also log those error messages to our log file if we wanted to. Otherwise yes, the changes I proposed would log some output to the log file when the test case finishes.\n\nOnce we settle on an approach, I figured it would be clearer to implement that in a follow-up CL, although we could hold off on this CL, make the virtual USB printer changes necessary and then update this CL if you\u0027d rather. Let me know!",
      "parentUuid": "dab31e9b_9734ce20",
      "revId": "aa33878c0df7750a41429ca2b2d3182ca8706cc2",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "8e9e5ccc_989590f5",
        "filename": "src/chromiumos/tast/local/bundles/cros/printer/reject_document_format.go",
        "patchSetId": 4
      },
      "lineNbr": 1,
      "author": {
        "id": 1192536
      },
      "writtenOn": "2022-05-20T15:57:09Z",
      "side": 1,
      "message": "nit: This doesn\u0027t match the new expected format.  Please take a look at the PSA: https://groups.google.com/a/chromium.org/g/chromium-os-dev/c/gZBw_GxEeng/m/oH5BONcECwAJ",
      "revId": "aa33878c0df7750a41429ca2b2d3182ca8706cc2",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "d35680c8_957bfe49",
        "filename": "src/chromiumos/tast/local/bundles/cros/printer/reject_document_format.go",
        "patchSetId": 4
      },
      "lineNbr": 1,
      "author": {
        "id": 1302456
      },
      "writtenOn": "2022-06-16T18:59:33Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "8e9e5ccc_989590f5",
      "revId": "aa33878c0df7750a41429ca2b2d3182ca8706cc2",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "74606494_34e4dce7",
        "filename": "src/chromiumos/tast/local/bundles/cros/printer/reject_document_format.go",
        "patchSetId": 4
      },
      "lineNbr": 44,
      "author": {
        "id": 1192536
      },
      "writtenOn": "2022-05-20T15:57:09Z",
      "side": 1,
      "message": "Does this need a new Chrome?  If it doesn\u0027t depend on a fresh Chrome, it should be more efficient to switch to the virtualUsbPrinterModulesLoadedWithChromeLoggedIn fixture.",
      "revId": "aa33878c0df7750a41429ca2b2d3182ca8706cc2",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "a4b4c659_2592af57",
        "filename": "src/chromiumos/tast/local/bundles/cros/printer/reject_document_format.go",
        "patchSetId": 4
      },
      "lineNbr": 44,
      "author": {
        "id": 1302456
      },
      "writtenOn": "2022-06-16T18:59:33Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "74606494_34e4dce7",
      "revId": "aa33878c0df7750a41429ca2b2d3182ca8706cc2",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "980354ad_f0dc7df9",
        "filename": "src/chromiumos/tast/local/bundles/cros/printer/reject_document_format.go",
        "patchSetId": 4
      },
      "lineNbr": 69,
      "author": {
        "id": 1192536
      },
      "writtenOn": "2022-05-20T15:57:09Z",
      "side": 1,
      "message": "The returned printer object from usbprinter.Start should have the VID and PID.  Could you generate this string from there instead of hardcoding?  That way this doesn\u0027t break if we ever change the values.",
      "revId": "aa33878c0df7750a41429ca2b2d3182ca8706cc2",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "68cf495b_50713fc4",
        "filename": "src/chromiumos/tast/local/bundles/cros/printer/reject_document_format.go",
        "patchSetId": 4
      },
      "lineNbr": 69,
      "author": {
        "id": 1302456
      },
      "writtenOn": "2022-06-16T18:59:33Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "980354ad_f0dc7df9",
      "revId": "aa33878c0df7750a41429ca2b2d3182ca8706cc2",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "6107cecb_411f8f96",
        "filename": "src/chromiumos/tast/local/bundles/cros/printer/reject_document_format.go",
        "patchSetId": 4
      },
      "lineNbr": 71,
      "author": {
        "id": 1192536
      },
      "writtenOn": "2022-05-20T15:57:09Z",
      "side": 1,
      "message": "Is there a bug for this somewhere?  Is lpadmin not actually using an exit status of 9, or is it getting incorrectly parsed?",
      "revId": "aa33878c0df7750a41429ca2b2d3182ca8706cc2",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "7a92caa4_16b8da4d",
        "filename": "src/chromiumos/tast/local/bundles/cros/printer/reject_document_format.go",
        "patchSetId": 4
      },
      "lineNbr": 71,
      "author": {
        "id": 1302456
      },
      "writtenOn": "2022-06-16T18:59:33Z",
      "side": 1,
      "message": "I don\u0027t have a bug for this. I tested this out by manually starting the virtual USB printer with the textproto from this CL and running `lpadmin -v $URI -m everywhere` and then `echo $?`, and it looks like lpadmin is returning the correct exit code. I took a quick look at the tast code, which I think is where the error is, but I don\u0027t fully understand it yet. Do you want me to log a bug for the tast folks?",
      "parentUuid": "6107cecb_411f8f96",
      "revId": "aa33878c0df7750a41429ca2b2d3182ca8706cc2",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "a161fde7_349c04f3",
        "filename": "src/chromiumos/tast/local/bundles/cros/printer/reject_document_format.go",
        "patchSetId": 4
      },
      "lineNbr": 71,
      "author": {
        "id": 1192536
      },
      "writtenOn": "2022-06-17T15:09:33Z",
      "side": 1,
      "message": "If we think tast isn\u0027t capturing the correct process exit code, that does seem like something that should be fixed in the framework.  However, exit codes on Linux can be a little tricky because they also encode things like whether the process received a signal.  Do you get the expected exit code if you call testexec.GetWaitStatus directly?",
      "parentUuid": "7a92caa4_16b8da4d",
      "revId": "aa33878c0df7750a41429ca2b2d3182ca8706cc2",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "e1c9b749_4db24295",
        "filename": "src/chromiumos/tast/local/bundles/cros/printer/reject_document_format.go",
        "patchSetId": 4
      },
      "lineNbr": 71,
      "author": {
        "id": 1302456
      },
      "writtenOn": "2022-06-21T20:53:58Z",
      "side": 1,
      "message": "Unfortunately not - the `ok` bool returned by testexec.GetWaitStatus is false.",
      "parentUuid": "a161fde7_349c04f3",
      "revId": "aa33878c0df7750a41429ca2b2d3182ca8706cc2",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    }
  ]
}