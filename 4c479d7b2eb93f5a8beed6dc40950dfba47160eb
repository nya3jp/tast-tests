{
  "comments": [
    {
      "key": {
        "uuid": "68ee236e_01e70ce3",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 5
      },
      "lineNbr": 0,
      "author": {
        "id": 1337146
      },
      "writtenOn": "2020-07-28T09:45:48Z",
      "side": 1,
      "message": "Added the suggested fixes.",
      "revId": "4c479d7b2eb93f5a8beed6dc40950dfba47160eb",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "bdbb0fe3_4db78518",
        "filename": "src/chromiumos/tast/local/chrome/chrome.go",
        "patchSetId": 5
      },
      "lineNbr": 836,
      "author": {
        "id": 1118346
      },
      "writtenOn": "2020-07-27T08:47:55Z",
      "side": 1,
      "message": "We clear /home/chronos here. If we want to clear /home/.shadow according to the content of /home/chronos, we have to call cleanChromeShadowDir before this.",
      "range": {
        "startLine": 836,
        "startChar": 2,
        "endLine": 836,
        "endChar": 26
      },
      "revId": "4c479d7b2eb93f5a8beed6dc40950dfba47160eb",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "29ec3d66_78d08286",
        "filename": "src/chromiumos/tast/local/chrome/chrome.go",
        "patchSetId": 5
      },
      "lineNbr": 836,
      "author": {
        "id": 1337146
      },
      "writtenOn": "2020-07-28T09:45:48Z",
      "side": 1,
      "message": "/home/.shadow [dir1, ...] that are not found in /home/chronos [\u0027u-$dir1\u0027,...] (see line 872)\nSo it is ok to remove all chronosDir first. \n\nFurther, if a directory is found in /home/.shadow and /home/chronos and it is not open in /home/chronos it is removed from /home/.shadow.",
      "parentUuid": "bdbb0fe3_4db78518",
      "range": {
        "startLine": 836,
        "startChar": 2,
        "endLine": 836,
        "endChar": 26
      },
      "revId": "4c479d7b2eb93f5a8beed6dc40950dfba47160eb",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "45890e01_1e5653a0",
        "filename": "src/chromiumos/tast/local/chrome/chrome.go",
        "patchSetId": 5
      },
      "lineNbr": 836,
      "author": {
        "id": 1337146
      },
      "writtenOn": "2020-07-28T09:51:17Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "29ec3d66_78d08286",
      "range": {
        "startLine": 836,
        "startChar": 2,
        "endLine": 836,
        "endChar": 26
      },
      "revId": "4c479d7b2eb93f5a8beed6dc40950dfba47160eb",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "ef0aaf14_1ca69c30",
        "filename": "src/chromiumos/tast/local/chrome/chrome.go",
        "patchSetId": 5
      },
      "lineNbr": 871,
      "author": {
        "id": 1118346
      },
      "writtenOn": "2020-07-27T08:47:55Z",
      "side": 1,
      "message": "nit: Let\u0027s use \"continue\" to reduce the nest level of the normal code path.\n\n if !file.IsDir() {\n   continue\n }\n ...\n\nhttps://github.com/golang/go/wiki/CodeReviewComments#indent-error-flow",
      "range": {
        "startLine": 871,
        "startChar": 2,
        "endLine": 871,
        "endChar": 19
      },
      "revId": "4c479d7b2eb93f5a8beed6dc40950dfba47160eb",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "1ca60c63_0b2a21f7",
        "filename": "src/chromiumos/tast/local/chrome/chrome.go",
        "patchSetId": 5
      },
      "lineNbr": 871,
      "author": {
        "id": 1337146
      },
      "writtenOn": "2020-07-28T09:45:48Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "ef0aaf14_1ca69c30",
      "range": {
        "startLine": 871,
        "startChar": 2,
        "endLine": 871,
        "endChar": 19
      },
      "revId": "4c479d7b2eb93f5a8beed6dc40950dfba47160eb",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "28928d27_dde6d70a",
        "filename": "src/chromiumos/tast/local/chrome/chrome.go",
        "patchSetId": 5
      },
      "lineNbr": 878,
      "author": {
        "id": 1118346
      },
      "writtenOn": "2020-07-27T08:47:55Z",
      "side": 1,
      "message": "Let\u0027s log that we\u0027ve removed shadowName to make debugging easier.",
      "range": {
        "startLine": 878,
        "startChar": 4,
        "endLine": 878,
        "endChar": 32
      },
      "revId": "4c479d7b2eb93f5a8beed6dc40950dfba47160eb",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "6a9e2b1c_1f054abd",
        "filename": "src/chromiumos/tast/local/chrome/chrome.go",
        "patchSetId": 5
      },
      "lineNbr": 878,
      "author": {
        "id": 1337146
      },
      "writtenOn": "2020-07-28T09:45:48Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "28928d27_dde6d70a",
      "range": {
        "startLine": 878,
        "startChar": 4,
        "endLine": 878,
        "endChar": 32
      },
      "revId": "4c479d7b2eb93f5a8beed6dc40950dfba47160eb",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "f19a568a_2e006c6f",
        "filename": "src/chromiumos/tast/local/chrome/chrome.go",
        "patchSetId": 5
      },
      "lineNbr": 882,
      "author": {
        "id": 1118346
      },
      "writtenOn": "2020-07-27T08:47:55Z",
      "side": 1,
      "message": "Can you use testexec.CommandContext instead? It has some addition to the standard os/exec suitable for Tast tests.",
      "range": {
        "startLine": 882,
        "startChar": 10,
        "endLine": 882,
        "endChar": 22
      },
      "revId": "4c479d7b2eb93f5a8beed6dc40950dfba47160eb",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "b502494d_d85ed44d",
        "filename": "src/chromiumos/tast/local/chrome/chrome.go",
        "patchSetId": 5
      },
      "lineNbr": 882,
      "author": {
        "id": 1118346
      },
      "writtenOn": "2020-07-27T08:47:55Z",
      "side": 1,
      "message": "This is a tricky condition... do you know when this happens even though we stopped the ui job in advance? What happens if we remove shadowName unconditionally?",
      "range": {
        "startLine": 882,
        "startChar": 24,
        "endLine": 882,
        "endChar": 37
      },
      "revId": "4c479d7b2eb93f5a8beed6dc40950dfba47160eb",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "083e5eac_8b4dbbe5",
        "filename": "src/chromiumos/tast/local/chrome/chrome.go",
        "patchSetId": 5
      },
      "lineNbr": 882,
      "author": {
        "id": 1337146
      },
      "writtenOn": "2020-07-28T09:45:48Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "f19a568a_2e006c6f",
      "range": {
        "startLine": 882,
        "startChar": 10,
        "endLine": 882,
        "endChar": 22
      },
      "revId": "4c479d7b2eb93f5a8beed6dc40950dfba47160eb",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "f145f91b_21fa9959",
        "filename": "src/chromiumos/tast/local/chrome/chrome.go",
        "patchSetId": 5
      },
      "lineNbr": 882,
      "author": {
        "id": 1337146
      },
      "writtenOn": "2020-07-28T09:45:48Z",
      "side": 1,
      "message": "If the directory is still open in /home/chronos, then we will fail deleting the corresponding directory in /home/.shadow. I saw that when trying to unconditionally remove the directory. The code here used to remove both the unopened directory in /home/chronos and /home/.shadow. Maybe we should do that \nagain.",
      "parentUuid": "b502494d_d85ed44d",
      "range": {
        "startLine": 882,
        "startChar": 24,
        "endLine": 882,
        "endChar": 37
      },
      "revId": "4c479d7b2eb93f5a8beed6dc40950dfba47160eb",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "54acdee4_f2e0a17b",
        "filename": "src/chromiumos/tast/local/chrome/chrome.go",
        "patchSetId": 5
      },
      "lineNbr": 882,
      "author": {
        "id": 1337146
      },
      "writtenOn": "2020-07-28T09:51:17Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "f145f91b_21fa9959",
      "range": {
        "startLine": 882,
        "startChar": 24,
        "endLine": 882,
        "endChar": 37
      },
      "revId": "4c479d7b2eb93f5a8beed6dc40950dfba47160eb",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "a3888611_330780f1",
        "filename": "src/chromiumos/tast/local/chrome/chrome.go",
        "patchSetId": 5
      },
      "lineNbr": 882,
      "author": {
        "id": 1337146
      },
      "writtenOn": "2020-07-29T01:04:04Z",
      "side": 1,
      "message": "Adding more info:\nwe would see this condition (no open files in chronos dir) if we try to remove the .shadow directories before deleting them from the chronos directory.\nI tried it by moving the call to cleanChromeShadowDir() from line 856 to line 833. \nUsing both file not found in chronos and file not open in chronos makes the function independent of the order in which chronos/.shadow are cleaned up.",
      "parentUuid": "54acdee4_f2e0a17b",
      "range": {
        "startLine": 882,
        "startChar": 24,
        "endLine": 882,
        "endChar": 37
      },
      "revId": "4c479d7b2eb93f5a8beed6dc40950dfba47160eb",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "7f577b92_d86eacd5",
        "filename": "src/chromiumos/tast/local/chrome/chrome.go",
        "patchSetId": 5
      },
      "lineNbr": 882,
      "author": {
        "id": 1118346
      },
      "writtenOn": "2020-07-29T09:54:34Z",
      "side": 1,
      "message": "Hmm. my understanding is that you observed that unconditionally deleting cryptohome directories in /home/.shadow fails due to files still in use.\n\nHowever, IIUC, stopping the ui job is equivalent to user logout, and Chrome OS *must* render all encrypted user files unaccessible on logout (e.g. throwing away the user encryption key, dropping in-kernel file cache, ...). If that\u0027s not the case, it\u0027s a critical product bug.\n\nSo I\u0027d like to know the reason why it fails. Can you share error messages you see when you unconditionally delete user directories in /home/.shadow? I might be missing some edge cases (e.g. some files in /home/.shadow are unencrypted and still in use after logout?).",
      "parentUuid": "a3888611_330780f1",
      "range": {
        "startLine": 882,
        "startChar": 24,
        "endLine": 882,
        "endChar": 37
      },
      "revId": "4c479d7b2eb93f5a8beed6dc40950dfba47160eb",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "f6368b25_eafe6e82",
        "filename": "src/chromiumos/tast/local/chrome/chrome.go",
        "patchSetId": 5
      },
      "lineNbr": 882,
      "author": {
        "id": 1337146
      },
      "writtenOn": "2020-07-30T09:47:41Z",
      "side": 1,
      "message": "\u003e\u003e unconditionally deleting cryptohome directories in /home/.shadow\n\u003e\u003e fails due to files still in use.\nYes this is true if you do it before line #847. \nThe cleanChromeShadowDir() function as implemented handles that case without\nerror.\n\nI tested it manually by moving the call to cleanChromeShadowDir() at different\nlocation\nline #875, #853, #846\nThe implementation of cleanChromeShadowDir() allows the function to be call without requiring the ui job or the /home/chronos directory to be cleaned up.\n\nThere is no problem with the product.",
      "parentUuid": "7f577b92_d86eacd5",
      "range": {
        "startLine": 882,
        "startChar": 24,
        "endLine": 882,
        "endChar": 37
      },
      "revId": "4c479d7b2eb93f5a8beed6dc40950dfba47160eb",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "619aa907_a03aa07d",
        "filename": "src/chromiumos/tast/local/chrome/chrome.go",
        "patchSetId": 5
      },
      "lineNbr": 883,
      "author": {
        "id": 1118346
      },
      "writtenOn": "2020-07-27T08:47:55Z",
      "side": 1,
      "message": "Since we discard the output anyway, let\u0027s use cmd.Run() instead.",
      "range": {
        "startLine": 883,
        "startChar": 20,
        "endLine": 883,
        "endChar": 34
      },
      "revId": "4c479d7b2eb93f5a8beed6dc40950dfba47160eb",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "19614b83_111340ef",
        "filename": "src/chromiumos/tast/local/chrome/chrome.go",
        "patchSetId": 5
      },
      "lineNbr": 883,
      "author": {
        "id": 1337146
      },
      "writtenOn": "2020-07-28T09:45:48Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "619aa907_a03aa07d",
      "range": {
        "startLine": 883,
        "startChar": 20,
        "endLine": 883,
        "endChar": 34
      },
      "revId": "4c479d7b2eb93f5a8beed6dc40950dfba47160eb",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "a504e618_0c0653a9",
        "filename": "src/chromiumos/tast/local/chrome/chrome.go",
        "patchSetId": 5
      },
      "lineNbr": 884,
      "author": {
        "id": 1118346
      },
      "writtenOn": "2020-07-27T08:47:55Z",
      "side": 1,
      "message": "Same here: let us log.",
      "range": {
        "startLine": 884,
        "startChar": 4,
        "endLine": 884,
        "endChar": 19
      },
      "revId": "4c479d7b2eb93f5a8beed6dc40950dfba47160eb",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "5a680031_3ce5a7e8",
        "filename": "src/chromiumos/tast/local/chrome/chrome.go",
        "patchSetId": 5
      },
      "lineNbr": 884,
      "author": {
        "id": 1337146
      },
      "writtenOn": "2020-07-28T09:45:48Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "a504e618_0c0653a9",
      "range": {
        "startLine": 884,
        "startChar": 4,
        "endLine": 884,
        "endChar": 19
      },
      "revId": "4c479d7b2eb93f5a8beed6dc40950dfba47160eb",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "bfda9887_2ebd6527",
        "filename": "src/chromiumos/tast/local/chrome/chrome.go",
        "patchSetId": 5
      },
      "lineNbr": 886,
      "author": {
        "id": 1118346
      },
      "writtenOn": "2020-07-27T08:47:55Z",
      "side": 1,
      "message": "Let us also log that we did not delete the directory because it is in use.",
      "range": {
        "startLine": 886,
        "startChar": 3,
        "endLine": 886,
        "endChar": 4
      },
      "revId": "4c479d7b2eb93f5a8beed6dc40950dfba47160eb",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "0daa8cc6_c8bb9740",
        "filename": "src/chromiumos/tast/local/chrome/chrome.go",
        "patchSetId": 5
      },
      "lineNbr": 886,
      "author": {
        "id": 1337146
      },
      "writtenOn": "2020-07-28T09:45:48Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "bfda9887_2ebd6527",
      "range": {
        "startLine": 886,
        "startChar": 3,
        "endLine": 886,
        "endChar": 4
      },
      "revId": "4c479d7b2eb93f5a8beed6dc40950dfba47160eb",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    }
  ]
}