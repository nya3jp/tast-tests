{
  "comments": [
    {
      "unresolved": false,
      "key": {
        "uuid": "6e5300c8_159cf83e",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 5
      },
      "lineNbr": 0,
      "author": {
        "id": 1000479
      },
      "writtenOn": "2021-02-20T01:48:47Z",
      "side": 1,
      "message": "The CL description says about the kernel panic, and indeed that\u0027s an interesting problem. I\u0027m still not sure if it\u0027s worth doing here as defer.  Rather it\u0027s better to provide the way to back to ccNormal and test callers invoke that.",
      "revId": "66f979415867f3c6ad0284b411ca3a62372ea26f",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "315fdfd6_ae582432",
        "filename": "src/chromiumos/tast/local/power/setup/setup_battery.go",
        "patchSetId": 5
      },
      "lineNbr": 36,
      "author": {
        "id": 1000479
      },
      "writtenOn": "2021-02-20T01:48:47Z",
      "side": 1,
      "message": "Sorry I don\u0027t quite get this actually.  Basically this function does:\n* check the current level of battery, and return an error if the battery is too low\n* set to ccDischarge at the end.  Returning function (CleanupCallback) will reest back to ccNormal.\n\nSo, what this CL does is to set to ccNormal when the battery is low. Why doing that?\n* if the test calling this function fails, CleanupCallback should be called and it should be reset back to ccNormal already.\n* if the device is in low-battery state for some reasons, I\u0027m not sure how setting ccNormal changes some behaviors.",
      "revId": "66f979415867f3c6ad0284b411ca3a62372ea26f",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "784bf5ca_e1b4254a",
        "filename": "src/chromiumos/tast/local/power/setup/setup_battery.go",
        "patchSetId": 5
      },
      "lineNbr": 36,
      "author": {
        "id": 1400377
      },
      "writtenOn": "2021-02-20T02:08:25Z",
      "side": 1,
      "message": "Because the battery is low, the test cannot be executed. If we re-charge the DUT, next time the same test will have the chance to succeed. This is useful when we repeatedly run CUJs on a dedicated DUT. Even the first run failed, the subsequent tests can benefit from this and will not be blocked by low battery. I think this logic does\u0027t have adverse impact but will improve the stability of the test environment.",
      "parentUuid": "315fdfd6_ae582432",
      "revId": "66f979415867f3c6ad0284b411ca3a62372ea26f",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "871d9a86_f40d83fe",
        "filename": "src/chromiumos/tast/local/power/setup/setup_battery.go",
        "patchSetId": 5
      },
      "lineNbr": 36,
      "author": {
        "id": 1000479
      },
      "writtenOn": "2021-02-20T02:18:34Z",
      "side": 1,
      "message": "That is a transient status due to kernel panic. Isn\u0027t it?  Why not manually fixing the battery status by yourself?\n(by the way, I think kernel panic is exceptional and is really bad.  If that happens consistently for some reasons, I guess that needs to be resolved).\n\nOr maybe simply ensuring to start from normal state is probably good enough.",
      "parentUuid": "784bf5ca_e1b4254a",
      "revId": "66f979415867f3c6ad0284b411ca3a62372ea26f",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "818a78d3_b4873210",
        "filename": "src/chromiumos/tast/local/power/setup/setup_battery.go",
        "patchSetId": 5
      },
      "lineNbr": 36,
      "author": {
        "id": 1400377
      },
      "writtenOn": "2021-02-20T03:11:09Z",
      "side": 1,
      "message": "Jun, kernel panic is one of the reasons and we will surely to check when we see it. Another reason I heard of from the testing team is that the DUT runs out of battery during test and goes down with battery uncharged. When it gets rebooted (it can still be brought up for a while) it is with discharged status. Usually testers don\u0027t know this and will report issues that this DUT is unchangeable. This logic can help put the battery into charge by a new test and save debugging and manual restore effort.\nWe can always raise the battery cutoff level but it doesn\u0027t guarantee different DUTs can support the same time of testing. So above mentioned scenario will occasionally happen.\n\nThis logic will help to resolve various issues related to charge status, and I hope this change makes sense. If you think explicitly setting to charged status by test cases is preferred, I will make that change.",
      "parentUuid": "871d9a86_f40d83fe",
      "revId": "66f979415867f3c6ad0284b411ca3a62372ea26f",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "72848044_b704e0c3",
        "filename": "src/chromiumos/tast/local/power/setup/setup_battery.go",
        "patchSetId": 5
      },
      "lineNbr": 36,
      "author": {
        "id": 1000479
      },
      "writtenOn": "2021-02-23T19:32:07Z",
      "side": 1,
      "message": "I am pretty sure you\u0027re seeing the problem, I am not sure if this is the right fix.\n\nIf the device is shutting down during the test case, I guess the assumption of this function is not working well with your test cases. As described in https://chromium.googlesource.com/chromiumos/platform/tast-tests.git/+/refs/heads/main/src/chromiumos/tast/local/power/setup/setup_battery.go#31, it will not start the test if the battery is too low, and the cutoff percentage looks like shutdown percentage + 2% (https://chromium.googlesource.com/chromiumos/platform/tast-tests.git/+/refs/heads/main/src/chromiumos/tast/local/power/setup/setup.go#167).\n\nHow about allow customizing those parameters to prevent shutting down during your test case?",
      "parentUuid": "818a78d3_b4873210",
      "revId": "66f979415867f3c6ad0284b411ca3a62372ea26f",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "bfaba4ac_f9ce6e6a",
        "filename": "src/chromiumos/tast/local/power/setup/setup_battery.go",
        "patchSetId": 5
      },
      "lineNbr": 36,
      "author": {
        "id": 1400377
      },
      "writtenOn": "2021-02-23T21:03:23Z",
      "side": 1,
      "message": "Thanks Jun. As you pointed out, I think we need to improve the cutoff level for certain tests - probably on certain models only. For example, some AMD models run test case very slow and consumes more power. Do you have any suggestions how to control the cutoff level per model?",
      "parentUuid": "72848044_b704e0c3",
      "revId": "66f979415867f3c6ad0284b411ca3a62372ea26f",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    }
  ]
}