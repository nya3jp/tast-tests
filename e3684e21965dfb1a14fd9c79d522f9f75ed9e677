{
  "comments": [
    {
      "unresolved": false,
      "key": {
        "uuid": "37203271_4b7d11a6",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 21
      },
      "lineNbr": 0,
      "author": {
        "id": 1520127
      },
      "writtenOn": "2022-04-07T14:50:22Z",
      "side": 1,
      "message": "Hi. I\u0027ve just uploaded the latest patchset.\n\n@hyung: I\u0027ve mentioned before about my intention to use a single command line that would run all variations on this test. So that idea is implemented now using `VarDeps`, where I\u0027m enforcing the test to always run with the `lacrosDeployedBinary` var, otherwise it fails. \n\nI\u0027m really curious how Chromium builders, specifically Crosbolt, will deal with this `VarDeps` idea. Probably some tweaks will be needed. I\u0027m looking at these now - is there anywhere else I should pay attention in terms of builders?\nhttps://chromium.googlesource.com/chromiumos/third_party/autotest/+/refs/heads/main/server/site_tests/tast/control.crosbolt-perbuild-shard-1\nhttps://chromium.googlesource.com/chromiumos/third_party/autotest/+/refs/heads/main/server/site_tests/tast/control.lacros\n\n@hidehiko: I\u0027m looking forward to analyzing the effects of the results developed here in Crosbolt next and follow-up with eventual changes if necessary. Tha said, I believe this CL is quite ready for your consideration now. Could you PTAL?\n\nThank you,",
      "revId": "e3684e21965dfb1a14fd9c79d522f9f75ed9e677",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "d12fc184_09fca232",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 21
      },
      "lineNbr": 0,
      "author": {
        "id": 1520127
      },
      "writtenOn": "2022-04-07T19:43:53Z",
      "side": 1,
      "message": "Thank you for reviewing Hidehiko. PTAL.",
      "revId": "e3684e21965dfb1a14fd9c79d522f9f75ed9e677",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "6d588b82_eece2911",
        "filename": "src/chromiumos/tast/local/bundles/cros/lacros/login_perf.go",
        "patchSetId": 21
      },
      "lineNbr": 81,
      "author": {
        "id": 1115919
      },
      "writtenOn": "2022-04-07T16:00:55Z",
      "side": 1,
      "message": "as these requires to download lacros image for each case from the internet,\nI\u0027m slightly worried about the lab network capacity. Seewai, do you know who\u0027s the best person to clarify?",
      "range": {
        "startLine": 65,
        "startChar": 5,
        "endLine": 81,
        "endChar": 3
      },
      "revId": "e3684e21965dfb1a14fd9c79d522f9f75ed9e677",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "422de973_32d41110",
        "filename": "src/chromiumos/tast/local/bundles/cros/lacros/login_perf.go",
        "patchSetId": 21
      },
      "lineNbr": 81,
      "author": {
        "id": 1520127
      },
      "writtenOn": "2022-04-07T19:43:53Z",
      "side": 1,
      "message": "how this one can be different than lacros.ShelfLaunch, for instance? That test is using Omaha as well (although through the fixtures concept). I understand that it runs in a different set of builders (\"group:mainline\"), but aren\u0027t we okay with that therefore?\n\nCc-ing Seewai now.",
      "parentUuid": "6d588b82_eece2911",
      "range": {
        "startLine": 65,
        "startChar": 5,
        "endLine": 81,
        "endChar": 3
      },
      "revId": "e3684e21965dfb1a14fd9c79d522f9f75ed9e677",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "b8c63f89_5e53091f",
        "filename": "src/chromiumos/tast/local/bundles/cros/lacros/login_perf.go",
        "patchSetId": 21
      },
      "lineNbr": 81,
      "author": {
        "id": 1115919
      },
      "writtenOn": "2022-04-08T05:58:59Z",
      "side": 1,
      "message": "lacros.ShelfLaunch.omaha is limited only for selected devices.\ncf) https://source.chromium.org/chromium/chromiumos/platform/tast-tests/+/HEAD:src/chromiumos/tast/local/bundles/cros/lacros/shelf_launch.go;l\u003d50",
      "parentUuid": "422de973_32d41110",
      "range": {
        "startLine": 65,
        "startChar": 5,
        "endLine": 81,
        "endChar": 3
      },
      "revId": "e3684e21965dfb1a14fd9c79d522f9f75ed9e677",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "f441d354_422447e4",
        "filename": "src/chromiumos/tast/local/bundles/cros/lacros/login_perf.go",
        "patchSetId": 21
      },
      "lineNbr": 81,
      "author": {
        "id": 1431492
      },
      "writtenOn": "2022-04-08T16:02:42Z",
      "side": 1,
      "message": "I think Congbin Guo from the Fleet Software is the best person to clarify lab network capacity question. I will add him to the CC list.",
      "parentUuid": "b8c63f89_5e53091f",
      "range": {
        "startLine": 65,
        "startChar": 5,
        "endLine": 81,
        "endChar": 3
      },
      "revId": "e3684e21965dfb1a14fd9c79d522f9f75ed9e677",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "c50bd277_c93495bb",
        "filename": "src/chromiumos/tast/local/bundles/cros/lacros/login_perf.go",
        "patchSetId": 21
      },
      "lineNbr": 81,
      "author": {
        "id": 1520127
      },
      "writtenOn": "2022-04-08T20:51:08Z",
      "side": 1,
      "message": "I\u0027ve changed now for that hw subset plus added \"phaser\" (another class we\u0027re focusing and is also the DUT I have atm). If you prefer, we can follow-up and change to some other subset.\n\nCongbin Guo, please let us know your considerations for the lab capacity mentioned here?",
      "parentUuid": "b8c63f89_5e53091f",
      "range": {
        "startLine": 65,
        "startChar": 5,
        "endLine": 81,
        "endChar": 3
      },
      "revId": "e3684e21965dfb1a14fd9c79d522f9f75ed9e677",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "4c67bc35_70034310",
        "filename": "src/chromiumos/tast/local/bundles/cros/lacros/login_perf.go",
        "patchSetId": 21
      },
      "lineNbr": 101,
      "author": {
        "id": 1115919
      },
      "writtenOn": "2022-04-07T16:00:55Z",
      "side": 1,
      "message": "how do you deploy lacros, i.e. where the deployed lacros comes from?\n\nAlso, why do you need this independent?\nrootfs_primary + variable should just work, I think.",
      "range": {
        "startLine": 81,
        "startChar": 5,
        "endLine": 101,
        "endChar": 4
      },
      "revId": "e3684e21965dfb1a14fd9c79d522f9f75ed9e677",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "cfa3e5b5_a4ce1c7a",
        "filename": "src/chromiumos/tast/local/bundles/cros/lacros/login_perf.go",
        "patchSetId": 21
      },
      "lineNbr": 101,
      "author": {
        "id": 1520127
      },
      "writtenOn": "2022-04-07T19:43:53Z",
      "side": 1,
      "message": "\u003e how do you deploy lacros, i.e. where the deployed lacros comes from?\n\nI don\u0027t know exactly how to deploy Lacros in the builders. TBH I was relying on the builders just and naively thinking they would transparently deploy it :) Could you guide here please? How other tests relying on deployed Lacros are doing?\n\n\u003e Also, why do you need this independent?\n\u003e rootfs_primary + variable should just work, I think.\n\nI thought that would be easier for the builder to use a single command line to run all variations. This is implemented using VarDeps, where I\u0027m enforcing the test to always run with the `lacrosDeployedBinary` var. This is basically what I was talking with Hyung before here.",
      "parentUuid": "4c67bc35_70034310",
      "range": {
        "startLine": 81,
        "startChar": 5,
        "endLine": 101,
        "endChar": 4
      },
      "revId": "e3684e21965dfb1a14fd9c79d522f9f75ed9e677",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "60b645b1_e6bae92f",
        "filename": "src/chromiumos/tast/local/bundles/cros/lacros/login_perf.go",
        "patchSetId": 21
      },
      "lineNbr": 101,
      "author": {
        "id": 1115919
      },
      "writtenOn": "2022-04-08T05:58:59Z",
      "side": 1,
      "message": "this runs on crosbolt (as a part of our infra).\nWe periodically build OS images, and crosbolt takes the result of builders, then run the test.\nSo, I do not expect the bots will use deployed-binary flow.\n\nIn Chromium infra, Lacros is injected onto the pre-built OS image, so they use deployed binary.\n\nMy recommendation is just drop deploy* pattern, and support lacrosDeployedBinary in rootfs (or omaha) cases for convinience of manual testing.",
      "parentUuid": "cfa3e5b5_a4ce1c7a",
      "range": {
        "startLine": 81,
        "startChar": 5,
        "endLine": 101,
        "endChar": 4
      },
      "revId": "e3684e21965dfb1a14fd9c79d522f9f75ed9e677",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "f2ad4057_74e4118b",
        "filename": "src/chromiumos/tast/local/bundles/cros/lacros/login_perf.go",
        "patchSetId": 21
      },
      "lineNbr": 101,
      "author": {
        "id": 1520127
      },
      "writtenOn": "2022-04-08T20:51:08Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "60b645b1_e6bae92f",
      "range": {
        "startLine": 81,
        "startChar": 5,
        "endLine": 101,
        "endChar": 4
      },
      "revId": "e3684e21965dfb1a14fd9c79d522f9f75ed9e677",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "a5abe794_8fbc2128",
        "filename": "src/chromiumos/tast/local/bundles/cros/lacros/login_perf.go",
        "patchSetId": 21
      },
      "lineNbr": 134,
      "author": {
        "id": 1115919
      },
      "writtenOn": "2022-04-07T16:00:55Z",
      "side": 1,
      "message": "nit/style: could you merge these lines?\n\nif err :\u003d performInitialLogin(...); err !\u003d nil {\n  ...",
      "range": {
        "startLine": 133,
        "startChar": 2,
        "endLine": 134,
        "endChar": 17
      },
      "revId": "e3684e21965dfb1a14fd9c79d522f9f75ed9e677",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "93fcfd49_dacbb08f",
        "filename": "src/chromiumos/tast/local/bundles/cros/lacros/login_perf.go",
        "patchSetId": 21
      },
      "lineNbr": 134,
      "author": {
        "id": 1520127
      },
      "writtenOn": "2022-04-07T19:43:53Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "a5abe794_8fbc2128",
      "range": {
        "startLine": 133,
        "startChar": 2,
        "endLine": 134,
        "endChar": 17
      },
      "revId": "e3684e21965dfb1a14fd9c79d522f9f75ed9e677",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "b4df832d_2753565e",
        "filename": "src/chromiumos/tast/local/bundles/cros/lacros/login_perf.go",
        "patchSetId": 21
      },
      "lineNbr": 153,
      "author": {
        "id": 1115919
      },
      "writtenOn": "2022-04-07T16:00:55Z",
      "side": 1,
      "message": "maybe, move this out from the for-loop?",
      "revId": "e3684e21965dfb1a14fd9c79d522f9f75ed9e677",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "35611bf1_de17de45",
        "filename": "src/chromiumos/tast/local/bundles/cros/lacros/login_perf.go",
        "patchSetId": 21
      },
      "lineNbr": 153,
      "author": {
        "id": 1520127
      },
      "writtenOn": "2022-04-07T19:43:53Z",
      "side": 1,
      "message": "yes, this is possible. Done\n\nAside to your question, we\u0027re getting each value saved independently for each iteration run, e.g.:\n\n```\n  \"browser_restore\": {\n    \"summary\": {\n      \"units\": \"seconds\",\n      \"improvement_direction\": \"down\",\n      \"type\": \"list_of_scalar_values\",\n      \"values\": [\n        9.941428052,\n        11.863214077,\n        9.611322887,\n        9.706841253,\n        9.965838618,\n        10.13402917,\n        9.892464851\n      ]\n    }\n  },\n```\n\nbut I\u0027m wondering whether the mean result of these values is better to be saved instead, so we can more easily analyse in Crosbolt dashboard. Wdyt?",
      "parentUuid": "b4df832d_2753565e",
      "revId": "e3684e21965dfb1a14fd9c79d522f9f75ed9e677",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "e30879ad_2862b7b3",
        "filename": "src/chromiumos/tast/local/bundles/cros/lacros/login_perf.go",
        "patchSetId": 21
      },
      "lineNbr": 175,
      "author": {
        "id": 1115919
      },
      "writtenOn": "2022-04-07T16:00:55Z",
      "side": 1,
      "message": "nit/style: you can directly return.\n\nreturn httptest.NewServer(...",
      "revId": "e3684e21965dfb1a14fd9c79d522f9f75ed9e677",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "54699fce_f84350b3",
        "filename": "src/chromiumos/tast/local/bundles/cros/lacros/login_perf.go",
        "patchSetId": 21
      },
      "lineNbr": 175,
      "author": {
        "id": 1520127
      },
      "writtenOn": "2022-04-07T19:43:53Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "e30879ad_2862b7b3",
      "revId": "e3684e21965dfb1a14fd9c79d522f9f75ed9e677",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "3a39d234_76092e89",
        "filename": "src/chromiumos/tast/local/bundles/cros/lacros/login_perf.go",
        "patchSetId": 21
      },
      "lineNbr": 182,
      "author": {
        "id": 1115919
      },
      "writtenOn": "2022-04-07T16:00:55Z",
      "side": 1,
      "message": "could you avoid passing state directly?\nInstead, could you pass variables, outdir and HasError one by one?\nAlso return error instead of s.Fatal/s.Error?",
      "range": {
        "startLine": 182,
        "startChar": 46,
        "endLine": 182,
        "endChar": 62
      },
      "revId": "e3684e21965dfb1a14fd9c79d522f9f75ed9e677",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "09fab05c_c0d23667",
        "filename": "src/chromiumos/tast/local/bundles/cros/lacros/login_perf.go",
        "patchSetId": 21
      },
      "lineNbr": 182,
      "author": {
        "id": 1520127
      },
      "writtenOn": "2022-04-07T19:43:53Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "3a39d234_76092e89",
      "range": {
        "startLine": 182,
        "startChar": 46,
        "endLine": 182,
        "endChar": 62
      },
      "revId": "e3684e21965dfb1a14fd9c79d522f9f75ed9e677",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "f92d0316_22b4c6a1",
        "filename": "src/chromiumos/tast/local/bundles/cros/lacros/login_perf.go",
        "patchSetId": 21
      },
      "lineNbr": 192,
      "author": {
        "id": 1115919
      },
      "writtenOn": "2022-04-07T16:00:55Z",
      "side": 1,
      "message": "could you run the retured closure later on success, which releases some internal state in go, too?",
      "range": {
        "startLine": 191,
        "startChar": 28,
        "endLine": 192,
        "endChar": 57
      },
      "revId": "e3684e21965dfb1a14fd9c79d522f9f75ed9e677",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "397283f6_fce2ffc1",
        "filename": "src/chromiumos/tast/local/bundles/cros/lacros/login_perf.go",
        "patchSetId": 21
      },
      "lineNbr": 192,
      "author": {
        "id": 1520127
      },
      "writtenOn": "2022-04-07T19:43:53Z",
      "side": 1,
      "message": "I\u0027ve tried to bring the closure right before the next `Chrome.New()`, but the session restore wouldn\u0027t work in that case. And if it\u0027s placed after that, it won\u0027t find the browser connection anymore, with the log showing `\"Failed to close connection to lacros-chrome: browser process 28589 exited; Chrome probably crashed\"`.\n\nWhich states were you referring BTW? Do you think it\u0027s worth checking deeper a bit other alternatives for releasing such states?",
      "parentUuid": "f92d0316_22b4c6a1",
      "range": {
        "startLine": 191,
        "startChar": 28,
        "endLine": 192,
        "endChar": 57
      },
      "revId": "e3684e21965dfb1a14fd9c79d522f9f75ed9e677",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "5322bee2_517d7010",
        "filename": "src/chromiumos/tast/local/bundles/cros/lacros/login_perf.go",
        "patchSetId": 21
      },
      "lineNbr": 192,
      "author": {
        "id": 1115919
      },
      "writtenOn": "2022-04-08T05:58:59Z",
      "side": 1,
      "message": "\u003e but the session restore wouldn\u0027t work in that case.\n\nI may be a bit confused. Closing the testing connection has an impact on session restore...?",
      "parentUuid": "397283f6_fce2ffc1",
      "range": {
        "startLine": 191,
        "startChar": 28,
        "endLine": 192,
        "endChar": 57
      },
      "revId": "e3684e21965dfb1a14fd9c79d522f9f75ed9e677",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "b0388acc_c1c36bcb",
        "filename": "src/chromiumos/tast/local/bundles/cros/lacros/login_perf.go",
        "patchSetId": 21
      },
      "lineNbr": 192,
      "author": {
        "id": 1520127
      },
      "writtenOn": "2022-04-08T20:51:08Z",
      "side": 1,
      "message": "Sorry, let me try to explain again:\n\nWhen I\u0027ve referred to `closeBrowser` in the comment, I actually meant the closure function, used for cleanup and close the Lacros browser (or Ash Chrome). This closure function is used normally in most of regular user flows, like: open UI -\u003e open browser -\u003e do something -\u003e close browser (closeBrowser) -\u003e close UI. But for this test we want to: open UI -\u003e open browser -\u003e do something -\u003e wait hw resources stabilize -\u003e start to collect performance metrics -\u003e open a new UI and expect it to automatically restore the browser from the previous session -\u003e stop collect metrics.\n\nSo if we use the closure to actually close the browser, then we won\u0027t have it restored and available when the second time the UI is up, ready to collect the metrics we want. I hope this is clear now a bit ðŸ˜Š",
      "parentUuid": "5322bee2_517d7010",
      "range": {
        "startLine": 191,
        "startChar": 28,
        "endLine": 192,
        "endChar": 57
      },
      "revId": "e3684e21965dfb1a14fd9c79d522f9f75ed9e677",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "ebf44f5c_779b03c7",
        "filename": "src/chromiumos/tast/local/bundles/cros/lacros/login_perf.go",
        "patchSetId": 21
      },
      "lineNbr": 192,
      "author": {
        "id": 1115919
      },
      "writtenOn": "2022-04-11T16:53:58Z",
      "side": 1,
      "message": "ok, then we may need to split two things: releasing the resources to maintain the connection with Lacros, and actually terminating the Lacros.\n\nEliot, any thoughts?",
      "parentUuid": "b0388acc_c1c36bcb",
      "range": {
        "startLine": 191,
        "startChar": 28,
        "endLine": 192,
        "endChar": 57
      },
      "revId": "e3684e21965dfb1a14fd9c79d522f9f75ed9e677",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "d218756a_b1f7bda7",
        "filename": "src/chromiumos/tast/local/bundles/cros/lacros/login_perf.go",
        "patchSetId": 21
      },
      "lineNbr": 192,
      "author": {
        "id": 1179631
      },
      "writtenOn": "2022-04-12T05:22:59Z",
      "side": 1,
      "message": "In Chrome, this is done with a separate Close() and ResetState() function. Maybe in the future when we remove the lacros fixture, we could have chrome\u0027s ResetState function do the same for lacros?\n\nOr, we can provide ResetState and Close on Browser().\n\nBTW, currently looks like the implementation of browserfixt.SetUp closes tabs for lacros, but not for chrome? why is this different? https://source.chromium.org/chromiumos/chromiumos/codesearch/+/main:src/platform/tast-tests/src/chromiumos/tast/local/chrome/browser/browserfixt/browserfixt.go;l\u003d30;drc\u003dea29a678bf10980f5e3d5f00a72ec45b3ad34ef5\n\nTangential, but I am not so keen on this return cleanup function for browserfixt. IMO we should do like defer br.Close() (closes resources), and defer br.ResetState() (closes browser - and most tests won\u0027t need this) to be consistent with Chrome.\n\nUntil then, what about just leaking the connection? We are restarting all chromes anyway.",
      "parentUuid": "ebf44f5c_779b03c7",
      "range": {
        "startLine": 191,
        "startChar": 28,
        "endLine": 192,
        "endChar": 57
      },
      "revId": "e3684e21965dfb1a14fd9c79d522f9f75ed9e677",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "1da28f97_89ffac49",
        "filename": "src/chromiumos/tast/local/bundles/cros/lacros/login_perf.go",
        "patchSetId": 21
      },
      "lineNbr": 192,
      "author": {
        "id": 1520127
      },
      "writtenOn": "2022-04-12T19:57:43Z",
      "side": 1,
      "message": "Thanks for checking in, Eliot! That\u0027s clear for me now. Meanwhile, do you think something like this is okay?\n\n```\n--- a/src/chromiumos/tast/local/chrome/lacros/lacros.go\n+++ b/src/chromiumos/tast/local/chrome/lacros/lacros.go\n@@ -59,6 +59,15 @@ func (l *Lacros) StopTracing(ctx context.Context) (*perfetto_proto.Trace, error)\n        return l.sess.StopTracing(ctx)\n }\n \n+// ResetState TODO.\n+func (l *Lacros) ResetState(ctx context.Context) {\n+       testing.ContextLog(ctx, \"TIAGOOOOOOOOOO ResetState\")\n+       l.sess.Close(ctx)\n+       l.sess \u003d nil\n+       l.agg.Close()\n+       l.agg \u003d nil\n+}\n+\n // Close closes all lacros chrome targets and the dev session.\n func (l *Lacros) Close(ctx context.Context) error {\n        // Get all pages. Note that we can\u0027t get all targets, because one of them\n@@ -82,10 +91,7 @@ func (l *Lacros) Close(ctx context.Context) error {\n \n        // The browser may already be terminated by the time we try to close the\n        // dev session, so ignore any error.\n-       l.sess.Close(ctx)\n-       l.sess \u003d nil\n-       l.agg.Close()\n-       l.agg \u003d nil\n+       l.ResetState(ctx)\n \n        if l.cmd !\u003d nil {\n                if err :\u003d l.cmd.Kill(); err !\u003d nil {\n```\n\nI\u0027m fine with leaking otherwise. After all it\u0027d be just a leak internally to tast because lacros process resources are cleanup nicely when ash-chrome is killed during UI restart.",
      "parentUuid": "d218756a_b1f7bda7",
      "range": {
        "startLine": 191,
        "startChar": 28,
        "endLine": 192,
        "endChar": 57
      },
      "revId": "e3684e21965dfb1a14fd9c79d522f9f75ed9e677",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "35f7fbee_079de487",
        "filename": "src/chromiumos/tast/local/bundles/cros/lacros/login_perf.go",
        "patchSetId": 21
      },
      "lineNbr": 192,
      "author": {
        "id": 1179631
      },
      "writtenOn": "2022-04-13T00:17:19Z",
      "side": 1,
      "message": "That diff does the opposite of what chrome does. ResetState closes tabs, Close closes resources. But, if you were to try to modify lacros Close to not close tabs it would break a lot of tests, so it needs to be migrated.\n\nWe could add a temporary CloseResources fn maybe with a TODO to make it ResetState/Close like chrome.\n\nhidehiko@, wdyt? also that browserfixt.SetUp closeBrowser closure closes tabs for lacros, but not for ash (seems extremely broken).",
      "parentUuid": "1da28f97_89ffac49",
      "range": {
        "startLine": 191,
        "startChar": 28,
        "endLine": 192,
        "endChar": 57
      },
      "revId": "e3684e21965dfb1a14fd9c79d522f9f75ed9e677",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "fbefc87c_d6572b7b",
        "filename": "src/chromiumos/tast/local/bundles/cros/lacros/login_perf.go",
        "patchSetId": 21
      },
      "lineNbr": 192,
      "author": {
        "id": 1520127
      },
      "writtenOn": "2022-04-19T20:20:49Z",
      "side": 1,
      "message": "eliot@, I\u0027m following a bit the refactoring and changes you\u0027re doing recently e.g https://crrev.com/c/3585268. Very interesting! With those merged in, is the CloseResources fn suggestion you mentioned before here valid still? I could go ahead and submit a CL with that if that\u0027s okay by you.\n\nhidehiko@, I understood we\u0027re waiting for your opinion here. Can you PTAL?\n\nThank you very much, again!",
      "parentUuid": "35f7fbee_079de487",
      "range": {
        "startLine": 191,
        "startChar": 28,
        "endLine": 192,
        "endChar": 57
      },
      "revId": "e3684e21965dfb1a14fd9c79d522f9f75ed9e677",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "e1c4e542_76849682",
        "filename": "src/chromiumos/tast/local/bundles/cros/lacros/login_perf.go",
        "patchSetId": 21
      },
      "lineNbr": 192,
      "author": {
        "id": 1179631
      },
      "writtenOn": "2022-04-20T00:06:48Z",
      "side": 1,
      "message": "I think I still need to discuss with hidehiko@ about what to do w.r.t lacros Close/ResetState. The change you linked I think doesn\u0027t change anything for this CL. Personally I\u0027m happy with leaking it (with a TODO) but yeah",
      "parentUuid": "fbefc87c_d6572b7b",
      "range": {
        "startLine": 191,
        "startChar": 28,
        "endLine": 192,
        "endChar": 57
      },
      "revId": "e3684e21965dfb1a14fd9c79d522f9f75ed9e677",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "c6dbec83_2993c73e",
        "filename": "src/chromiumos/tast/local/bundles/cros/lacros/login_perf.go",
        "patchSetId": 21
      },
      "lineNbr": 192,
      "author": {
        "id": 1115919
      },
      "writtenOn": "2022-04-20T13:37:20Z",
      "side": 1,
      "message": "ok, could you add TODO with a tracking issue?\nWe can continue to discuss, and unblock this then.\nMy biggest concern is, if this is only one exceptional case, that\u0027s fine. Though, many people looking at the surrounding code, and import existing ones even if it is a short term workaround. So, definitely it is important not to make any easy mirror of the code.",
      "parentUuid": "e1c4e542_76849682",
      "range": {
        "startLine": 191,
        "startChar": 28,
        "endLine": 192,
        "endChar": 57
      },
      "revId": "e3684e21965dfb1a14fd9c79d522f9f75ed9e677",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "49a9f742_35d4d079",
        "filename": "src/chromiumos/tast/local/bundles/cros/lacros/login_perf.go",
        "patchSetId": 21
      },
      "lineNbr": 192,
      "author": {
        "id": 1520127
      },
      "writtenOn": "2022-04-20T20:57:31Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "c6dbec83_2993c73e",
      "range": {
        "startLine": 191,
        "startChar": 28,
        "endLine": 192,
        "endChar": 57
      },
      "revId": "e3684e21965dfb1a14fd9c79d522f9f75ed9e677",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "4e508caf_d2cdc5d2",
        "filename": "src/chromiumos/tast/local/bundles/cros/lacros/login_perf.go",
        "patchSetId": 21
      },
      "lineNbr": 220,
      "author": {
        "id": 1115919
      },
      "writtenOn": "2022-04-07T16:00:55Z",
      "side": 1,
      "message": "ditto: could you avoid passing testing.State to utility function?",
      "range": {
        "startLine": 220,
        "startChar": 46,
        "endLine": 220,
        "endChar": 62
      },
      "revId": "e3684e21965dfb1a14fd9c79d522f9f75ed9e677",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "3ebc84a6_58e2f88c",
        "filename": "src/chromiumos/tast/local/bundles/cros/lacros/login_perf.go",
        "patchSetId": 21
      },
      "lineNbr": 220,
      "author": {
        "id": 1520127
      },
      "writtenOn": "2022-04-07T19:43:53Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "4e508caf_d2cdc5d2",
      "range": {
        "startLine": 220,
        "startChar": 46,
        "endLine": 220,
        "endChar": 62
      },
      "revId": "e3684e21965dfb1a14fd9c79d522f9f75ed9e677",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "01ba53ba_7111782c",
        "filename": "src/chromiumos/tast/local/bundles/cros/lacros/login_perf.go",
        "patchSetId": 21
      },
      "lineNbr": 258,
      "author": {
        "id": 1115919
      },
      "writtenOn": "2022-04-07T16:00:55Z",
      "side": 1,
      "message": "Clarification: this performs fake login, which is different from actual login flow.\nI was thinking you\u0027d like to perform actual login with a test gaia account. WDYT?",
      "range": {
        "startLine": 256,
        "startChar": 1,
        "endLine": 258,
        "endChar": 36
      },
      "revId": "e3684e21965dfb1a14fd9c79d522f9f75ed9e677",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "24dbe1a4_1acf2620",
        "filename": "src/chromiumos/tast/local/bundles/cros/lacros/login_perf.go",
        "patchSetId": 21
      },
      "lineNbr": 258,
      "author": {
        "id": 1520127
      },
      "writtenOn": "2022-04-07T19:43:53Z",
      "side": 1,
      "message": "I haven\u0027t found any need to use the gaia account. What benefits it brings in this test compared with the fake account?",
      "parentUuid": "01ba53ba_7111782c",
      "range": {
        "startLine": 256,
        "startChar": 1,
        "endLine": 258,
        "endChar": 36
      },
      "revId": "e3684e21965dfb1a14fd9c79d522f9f75ed9e677",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "6dd3ff0a_12b43505",
        "filename": "src/chromiumos/tast/local/bundles/cros/lacros/login_perf.go",
        "patchSetId": 21
      },
      "lineNbr": 258,
      "author": {
        "id": 1115919
      },
      "writtenOn": "2022-04-08T05:58:59Z",
      "side": 1,
      "message": "just to avoid fake, as this is performance test.\nUsing fake sounds like it bypasses some key flow that needs for gaia login.",
      "parentUuid": "24dbe1a4_1acf2620",
      "range": {
        "startLine": 256,
        "startChar": 1,
        "endLine": 258,
        "endChar": 36
      },
      "revId": "e3684e21965dfb1a14fd9c79d522f9f75ed9e677",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "61070f48_2d080119",
        "filename": "src/chromiumos/tast/local/bundles/cros/lacros/login_perf.go",
        "patchSetId": 21
      },
      "lineNbr": 258,
      "author": {
        "id": 1520127
      },
      "writtenOn": "2022-04-08T20:51:08Z",
      "side": 1,
      "message": "Alright. I\u0027ve started to code Gaia login now but I\u0027m running into \"Something went wrong\" screen right after the login \u0026 password get auto-filled. I\u0027d guess it\u0027s something wrong with my CrOS environment - I\u0027m using a non-official image (Chromium 98.0.4751.0), could that be an issue?\n\nNow, in the latest patchset, I left a big TODO comment with the idea discussed. I\u0027ll be taking a more careful look next and tackle that.",
      "parentUuid": "6dd3ff0a_12b43505",
      "range": {
        "startLine": 256,
        "startChar": 1,
        "endLine": 258,
        "endChar": 36
      },
      "revId": "e3684e21965dfb1a14fd9c79d522f9f75ed9e677",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "8c252455_6c6f5854",
        "filename": "src/chromiumos/tast/local/bundles/cros/lacros/login_perf.go",
        "patchSetId": 21
      },
      "lineNbr": 291,
      "author": {
        "id": 1115919
      },
      "writtenOn": "2022-04-07T16:00:55Z",
      "side": 1,
      "message": "nit: time.Since returns time.Duration, so you don\u0027t need to call it here explicitly.",
      "range": {
        "startLine": 291,
        "startChar": 9,
        "endLine": 291,
        "endChar": 22
      },
      "revId": "e3684e21965dfb1a14fd9c79d522f9f75ed9e677",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "85666f2b_d3e12506",
        "filename": "src/chromiumos/tast/local/bundles/cros/lacros/login_perf.go",
        "patchSetId": 21
      },
      "lineNbr": 291,
      "author": {
        "id": 1520127
      },
      "writtenOn": "2022-04-07T19:43:53Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "8c252455_6c6f5854",
      "range": {
        "startLine": 291,
        "startChar": 9,
        "endLine": 291,
        "endChar": 22
      },
      "revId": "e3684e21965dfb1a14fd9c79d522f9f75ed9e677",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "1d6ec3a1_d19138bf",
        "filename": "src/chromiumos/tast/local/bundles/cros/lacros/login_perf.go",
        "patchSetId": 21
      },
      "lineNbr": 323,
      "author": {
        "id": 1115919
      },
      "writtenOn": "2022-04-07T16:00:55Z",
      "side": 1,
      "message": "I saw this pattern several times, but in general testing.Sleep is the source of flakiness.\nCould you file a bug to get rid of this pattern?",
      "range": {
        "startLine": 320,
        "startChar": 1,
        "endLine": 323,
        "endChar": 34
      },
      "revId": "e3684e21965dfb1a14fd9c79d522f9f75ed9e677",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "ac704696_a16b5973",
        "filename": "src/chromiumos/tast/local/bundles/cros/lacros/login_perf.go",
        "patchSetId": 21
      },
      "lineNbr": 323,
      "author": {
        "id": 1520127
      },
      "writtenOn": "2022-04-07T19:43:53Z",
      "side": 1,
      "message": "yes, sure. Do you think it\u0027s fine if I file this right after we finish this CL first? I\u0027m seeing at least 5 files / tests using this pattern and I\u0027m afraid it could bring up too much noise if we touch them right now here.",
      "parentUuid": "1d6ec3a1_d19138bf",
      "range": {
        "startLine": 320,
        "startChar": 1,
        "endLine": 323,
        "endChar": 34
      },
      "revId": "e3684e21965dfb1a14fd9c79d522f9f75ed9e677",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "ec5db99a_1c0b7a21",
        "filename": "src/chromiumos/tast/local/bundles/cros/lacros/login_perf.go",
        "patchSetId": 21
      },
      "lineNbr": 323,
      "author": {
        "id": 1115919
      },
      "writtenOn": "2022-04-08T05:58:59Z",
      "side": 1,
      "message": "I\u0027m fine as long as you file a bug and add TODO here.",
      "parentUuid": "ac704696_a16b5973",
      "range": {
        "startLine": 320,
        "startChar": 1,
        "endLine": 323,
        "endChar": 34
      },
      "revId": "e3684e21965dfb1a14fd9c79d522f9f75ed9e677",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "af4ee600_e99a9930",
        "filename": "src/chromiumos/tast/local/bundles/cros/lacros/login_perf.go",
        "patchSetId": 21
      },
      "lineNbr": 323,
      "author": {
        "id": 1520127
      },
      "writtenOn": "2022-04-08T20:51:08Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "ec5db99a_1c0b7a21",
      "range": {
        "startLine": 320,
        "startChar": 1,
        "endLine": 323,
        "endChar": 34
      },
      "revId": "e3684e21965dfb1a14fd9c79d522f9f75ed9e677",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    }
  ]
}