{
  "comments": [
    {
      "key": {
        "uuid": "d402bb4b_f27469f8",
        "filename": "/COMMIT_MSG",
        "patchSetId": 1
      },
      "lineNbr": 13,
      "author": {
        "id": 1273836
      },
      "writtenOn": "2019-06-20T03:06:19Z",
      "side": 1,
      "message": "I wonder why \u0027conn.Close()\u0027 doesn\u0027t clean up tabs. \nnya@ and hidehiko@, what\u0027s the reason? I think it\u0027s somehow confusing.\n\nIf conn.Close() shouldn\u0027t close tabs actually, how about a separate function like creating conn.CloseAll()?",
      "revId": "eb1ff42fedd3485ab06500854f943a1d0ab2a28f",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "b122b377_b0aaca8d",
        "filename": "/COMMIT_MSG",
        "patchSetId": 1
      },
      "lineNbr": 13,
      "author": {
        "id": 1273836
      },
      "writtenOn": "2019-06-20T03:11:22Z",
      "side": 1,
      "message": "Sorry, the last sentence is broken. I\u0027d suggest to create a function that closes tabs and a connection altogether in chrome package.",
      "parentUuid": "d402bb4b_f27469f8",
      "revId": "eb1ff42fedd3485ab06500854f943a1d0ab2a28f",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "9a9f6432_b64478aa",
        "filename": "/COMMIT_MSG",
        "patchSetId": 1
      },
      "lineNbr": 13,
      "author": {
        "id": 1115919
      },
      "writtenOn": "2019-06-20T04:53:03Z",
      "side": 1,
      "message": "https://chromium.googlesource.com/chromiumos/platform/tast/+/HEAD/docs/writing_tests.md#startup-and-shutdown\n\nSo, we expect that the test which needs tabs closed will close tabs as a part of its setup.\n\nThis is also useful for diagnosing the failure in some cases.\nE.g., screenshot of the display will be taken in case of failure, after the test is completed.\nIf the tab is closed, it\u0027s more difficult to see what was going on.\n\nCould you share which tests are actually affected by opened tabs, and how?",
      "parentUuid": "b122b377_b0aaca8d",
      "revId": "eb1ff42fedd3485ab06500854f943a1d0ab2a28f",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "3bd694b7_1ac39e55",
        "filename": "/COMMIT_MSG",
        "patchSetId": 1
      },
      "lineNbr": 13,
      "author": {
        "id": 1001853
      },
      "writtenOn": "2019-06-20T05:39:23Z",
      "side": 1,
      "message": "Thanks for pointing out. Screenshot is useful for investigating test failure, especially video playback.\n\nClosing all tabs at start-up time sounds reasonable. Shall we have a method, CloseAllTabs() in chrome/chrome.go?\n\nAlso, for reducing unnecessary CPU run, I suggest we can stop video playback after each video play test, especially for those which plays video repeatedly.",
      "parentUuid": "9a9f6432_b64478aa",
      "revId": "eb1ff42fedd3485ab06500854f943a1d0ab2a28f",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "a3377c51_0d787db1",
        "filename": "/COMMIT_MSG",
        "patchSetId": 1
      },
      "lineNbr": 13,
      "author": {
        "id": 1118346
      },
      "writtenOn": "2019-06-20T09:28:46Z",
      "side": 1,
      "message": "Hmm, it\u0027s not clear to me what this CL tries to solve. All tabs are supposed to be closed on starting a test even if a test uses chrome.LoggedIn precondition. This is a logic in precondition:\n\nhttp://cs/chromeos_public/src/platform/tast-tests/src/chromiumos/tast/local/chrome/chrome.go?l\u003d363\n\nRe: stopping video playback, it makes sense, but I recommend adding the deferred logic to stop the video (or close the tab if it\u0027s difficult to stop the video) case-by-case basis.",
      "parentUuid": "3bd694b7_1ac39e55",
      "revId": "eb1ff42fedd3485ab06500854f943a1d0ab2a28f",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "14f136eb_f7df67b1",
        "filename": "/COMMIT_MSG",
        "patchSetId": 1
      },
      "lineNbr": 13,
      "author": {
        "id": 1288602
      },
      "writtenOn": "2019-06-21T01:22:06Z",
      "side": 1,
      "message": "Thanks for all the feedback!\n\nTo be honest I very strongly disagree with leaving cleanup responsibility for the next testcase. I\u0027ve worked on multiple test frameworks in the past, and every time I encountered various hard-to-debug issues due to tests not properly cleaning up.\n\nWhile I agree that in some cases it\u0027s not always possible for tests to do cleanup on failure, in most cases the framework should make cleanup on failure possible. That\u0027s exactly why we do cleanup with a longer context. And tests should to some extend perform cleanup at the start, but it\u0027s impossible for a test to do all possible cleanup:\n- Some process might be left running, it\u0027s impossible for the next testcase to kill this.\n- Some files might pollute the file system and affect future tests.\n- Some configuration might be written by the previous test (e.g. CPU frequency scaling), it\u0027s impossible for the next test to fix all this.\n- Some process might have been killed (e.g. the thermal throttling process) that might affect next test runs.\n- Even on a UI restart most of these things will persist.\n- Even on a reboot some of the above things will persist.\n\nI can\u0027t stress strongly enough how important I think it is for tests to do proper cleanup at the end of the test run. If it were up to me I would rewrite the tast documentation to much better reflect this. There are some exceptions to this, but they should be properly listed as being exceptions:\n- The device can be left in the logged in state.\n- The Chrome browser can be left open.\nBut this is what the preconditions are for!\n\nIMHO the only thing a test should do at the start (asides from any pre-conditions) is making sure the UI is stopped or started. \n\nAnother reason for cleaning up at the end of the test:\n- After running a test I manually need to close tabs and clean up things, before I can use my board for other purposes. I find this very annoying.\n- The board might be left e.g. playing a movie, increasing CPU and power usage and potentially reducing the boards lifetime for no reason at all. This might not be a huge issue, but let\u0027s avoid the board playing movies non-stop whenever it\u0027s left idle.\n\nI understand that we might need to take screenshots on failure, but this doesn\u0027t weight up to the above points I listed. There are alternative ways to deal with this:\n- Explicitly ask to take a screenshot on failure.\n- Postpone cleanup until after taking a screenshot, e.g. testingstate.AttachCleanup(cleanupBenchmark).\n\nSome examples of tests issues:\n- The camera.Decode/EncodeAccelJPEGPerf tests will report 10% higher CPU if ran after the \u0027MediaRecorder*\u0027 tests. This issue is very hard to track down. It will also be fixed by closing the UI at the start of the tests, but that doesn\u0027t mean we shouldn\u0027t enforce tests to do cleanup at the end.\n- The video.EncodeAccelPerf* and many other performance tests fail waiting for the CPU to become idle, if ran after the \u0027MediaRecorder*\u0027 tests.\n\nAt the moment I\u0027m taking steps to both improve cleanup at the end of a test, and improve setup at the start of a test. I would really like this CL to be checked in soon, as we already spent a lot of time investigating why things go wrong, and want to get our tests stable as soon as possible. We can always continue our conversation afterwards, and discuss alternatives!",
      "parentUuid": "a3377c51_0d787db1",
      "revId": "eb1ff42fedd3485ab06500854f943a1d0ab2a28f",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    }
  ]
}