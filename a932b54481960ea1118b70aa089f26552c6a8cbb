{
  "comments": [
    {
      "key": {
        "uuid": "eae93540_4e6f47ba",
        "filename": "src/chromiumos/tast/local/bundles/cros/network/wpa_sanity.go",
        "patchSetId": 2
      },
      "lineNbr": 43,
      "author": {
        "id": 1132414
      },
      "writtenOn": "2020-01-16T02:40:24Z",
      "side": 1,
      "message": "Is it still possible that Shill is still initializing the device when you get here? i.e., if you get to WiFi::Start() but haven\u0027t finished ConnectToSupplicant()? I recall this is possible, which means you might need to poll this for a short period of time.",
      "range": {
        "startLine": 39,
        "startChar": 0,
        "endLine": 43,
        "endChar": 2
      },
      "revId": "a932b54481960ea1118b70aa089f26552c6a8cbb",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "1714b53f_82c62ca8",
        "filename": "src/chromiumos/tast/local/bundles/cros/network/wpa_sanity.go",
        "patchSetId": 2
      },
      "lineNbr": 43,
      "author": {
        "id": 1132414
      },
      "writtenOn": "2020-01-16T02:56:57Z",
      "side": 1,
      "message": "To add a little here: in Manager::RegisterDevice(), EmitDeviceProperties() is only called after Device::SetEnabled(true) (which calls Start()). So normally, we would only see the Device in the Manager listing after it runs through ConnectToSupplicant().\n\nThe part I recall having problems with: WiFi::supplicant_present_ isn\u0027t always true initially. It\u0027s possible for wpa_supplicant to start after Shill, and we\u0027re *supposed* to handle it correctly, such that you might see WiFi::OnSupplicantAppear() -\u003e ConnectToSupplicant() long after the Device first appears.\n\nSo I still think technically, that\u0027s a race condition here (you\u0027re hoping that WiFi::OnSupplicantAppear() gets called first).",
      "parentUuid": "eae93540_4e6f47ba",
      "range": {
        "startLine": 39,
        "startChar": 0,
        "endLine": 43,
        "endChar": 2
      },
      "revId": "a932b54481960ea1118b70aa089f26552c6a8cbb",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "931973d5_06403a92",
        "filename": "src/chromiumos/tast/local/bundles/cros/network/wpa_sanity.go",
        "patchSetId": 2
      },
      "lineNbr": 43,
      "author": {
        "id": 1001853
      },
      "writtenOn": "2020-01-16T03:00:02Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "eae93540_4e6f47ba",
      "range": {
        "startLine": 39,
        "startChar": 0,
        "endLine": 43,
        "endChar": 2
      },
      "revId": "a932b54481960ea1118b70aa089f26552c6a8cbb",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "13d4f02f_d072f6d4",
        "filename": "src/chromiumos/tast/local/bundles/cros/network/wpa_sanity.go",
        "patchSetId": 2
      },
      "lineNbr": 43,
      "author": {
        "id": 1001853
      },
      "writtenOn": "2020-01-16T03:00:57Z",
      "side": 1,
      "message": "Let me think about the race.",
      "parentUuid": "931973d5_06403a92",
      "range": {
        "startLine": 39,
        "startChar": 0,
        "endLine": 43,
        "endChar": 2
      },
      "revId": "a932b54481960ea1118b70aa089f26552c6a8cbb",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "eb5d359f_3305ad60",
        "filename": "src/chromiumos/tast/local/bundles/cros/network/wpa_sanity.go",
        "patchSetId": 2
      },
      "lineNbr": 43,
      "author": {
        "id": 1001853
      },
      "writtenOn": "2020-01-17T04:08:02Z",
      "side": 1,
      "message": "Let me clarify if I understand correctly.\n\nIn normal condition, wpa_supplicant is started by init process. And shill calls ConnectToSupplicant() in WiFi::Start(). \nHowever, for some reason, wpa_supplicant could be restarted. It triggers OnSupplicantAppear() which calls ConnectToSupplicant(). In such case, seeing a wifi device in shill may still cannot find a wpa_supplicant process yet.\n\nSo yes, seeing a wifi device in shill manager does not mean there\u0027s a working wpa_supplicant process to ping. So in the patchset 3, I added a polling for wpa_cli ping to mitigate the uncertainty. Does that cover the possible wpa_supplicant restart case?",
      "parentUuid": "13d4f02f_d072f6d4",
      "range": {
        "startLine": 39,
        "startChar": 0,
        "endLine": 43,
        "endChar": 2
      },
      "revId": "a932b54481960ea1118b70aa089f26552c6a8cbb",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "6531a94f_a638ca5f",
        "filename": "src/chromiumos/tast/local/bundles/cros/network/wpa_sanity.go",
        "patchSetId": 2
      },
      "lineNbr": 43,
      "author": {
        "id": 1132414
      },
      "writtenOn": "2020-01-17T18:24:36Z",
      "side": 1,
      "message": "That\u0027s right, yes.\n\nOne additional bit (that I hinted at, but you didn\u0027t cover): this doesn\u0027t even actually require a wpa_supplicant restart. wpa_supplicant could be already started just fine, but at shill WiFi (Device) creation / Start(), we still don\u0027t quite guarantee WiFi::supplicant_present_ will be true yet. That happens asynchronously -- here\u0027s a rough call outline:\n\n  WiFi constructor\n  -\u003e CreateSupplicantProcessProxy()\n  -\u003e ...\n  -\u003e supplicant_proxy_-\u003eGetObjectProxy()-\u003eWaitForServiceToBeAvailable()\n  -\u003e \n  // One time callback when service becomes available.\n  supplicant_proxy_-\u003eGetObjectProxy()-\u003eWaitForServiceToBeAvailable(base::Bind(\n      \u0026SupplicantProcessProxy::OnServiceAvailable, weak_factory_.GetWeakPtr()));\n   [ now look at libchrome / dbus/object_proxy.cc ]\n   // This posts an asynchronous callback which \"eventually\" goes to...\n\n  -\u003e SupplicantProcessProxy::OnServiceAvailable()\n  -\u003e WiFi::OnSupplicantAppear()\n\nIn other words, WiFi::OnSupplicantAppear() is always asynchronous from WiFi object construction -- in the default case, I think (due to message loop ordering I believe?) it is very likely to run before WiFi::Start(), but it\u0027s not clearly guaranteed AFAICT.\n\nMaybe the lesson here is: everything is asynchronous unless proven otherwise.",
      "parentUuid": "eb5d359f_3305ad60",
      "range": {
        "startLine": 39,
        "startChar": 0,
        "endLine": 43,
        "endChar": 2
      },
      "revId": "a932b54481960ea1118b70aa089f26552c6a8cbb",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "bc58b030_a94ebf77",
        "filename": "src/chromiumos/tast/local/bundles/cros/network/wpa_sanity.go",
        "patchSetId": 2
      },
      "lineNbr": 43,
      "author": {
        "id": 1132414
      },
      "writtenOn": "2020-01-17T18:28:35Z",
      "side": 1,
      "message": "Also, given how many words are being spent here on describing the asynchronocity, maybe you could stick a few words above in code comments, next to the polling loop in version 3?",
      "parentUuid": "6531a94f_a638ca5f",
      "range": {
        "startLine": 39,
        "startChar": 0,
        "endLine": 43,
        "endChar": 2
      },
      "revId": "a932b54481960ea1118b70aa089f26552c6a8cbb",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "6b454660_03da1b8f",
        "filename": "src/chromiumos/tast/local/bundles/cros/network/wpa_sanity.go",
        "patchSetId": 2
      },
      "lineNbr": 43,
      "author": {
        "id": 1001853
      },
      "writtenOn": "2020-01-18T12:33:16Z",
      "side": 1,
      "message": "Thank you for the detailed explanation. I missed the flow that WiFi ctor asynchronously triggers WiFi::OnSupplicantAppear().\n\nWhen I studied your previous comment, I misunderstood your meaning for a while: I thought you wanted to say it is not enough to use wpa_cli polling. But what you want to point out is: even shill has wifi device registered, wpa_cli is not guaranteed to work.\n\nBack the a basic question: wpa_supplicant should be spinned up by system init process, right? Because it is not kicked off by shill, wpa_cli should be able to talk to wpa_supplicant via unix socket, which is irrelevant whether shill\u0027s SupplicantProcessProxy is available or not. Am I correct?\n\nSure I\u0027ll add a comment to explain why polling is necessary.",
      "parentUuid": "bc58b030_a94ebf77",
      "range": {
        "startLine": 39,
        "startChar": 0,
        "endLine": 43,
        "endChar": 2
      },
      "revId": "a932b54481960ea1118b70aa089f26552c6a8cbb",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "9831e8ea_a2fcf362",
        "filename": "src/chromiumos/tast/local/bundles/cros/network/wpa_sanity.go",
        "patchSetId": 2
      },
      "lineNbr": 43,
      "author": {
        "id": 1132414
      },
      "writtenOn": "2020-01-21T17:31:10Z",
      "side": 1,
      "message": "\u003e But what you want to point out is: even shill has wifi device registered, wpa_cli is not guaranteed to work.\n\nRighnt.\n \n\u003e Back the a basic question: wpa_supplicant should be spinned up by system init process, right?\n\nYes.\n\n\u003e Because it is not kicked off by shill, wpa_cli should be able to talk to wpa_supplicant via unix socket, which is irrelevant whether shill\u0027s SupplicantProcessProxy is available or not. Am I correct?\n\nIf you just want to \"talk to wpa_supplicant\", then yes, the Shill device state is mostly irrelevant. But my hope was that we were actually checking that wpa_supplicant has attached to the WiFi device, and it only does that when Shill tells it to.\n\nUnfortunately, I realized the wpa_cli \u0027ping\u0027 command doesn\u0027t actually check anything about the interface state -- it just checks that wpa_supplicant is responding OK. So you\u0027re actually right, that this doesn\u0027t *really* need to be polled.\n\nI guess what we\u0027re really looking for, is something more like \u0027wpa_cli -i wlan0 status | sed -n \"s:^wpa_state\u003d::p\"\u0027.",
      "parentUuid": "6b454660_03da1b8f",
      "range": {
        "startLine": 39,
        "startChar": 0,
        "endLine": 43,
        "endChar": 2
      },
      "revId": "a932b54481960ea1118b70aa089f26552c6a8cbb",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "3beb368a_82016ac1",
        "filename": "src/chromiumos/tast/local/bundles/cros/network/wpa_sanity.go",
        "patchSetId": 2
      },
      "lineNbr": 43,
      "author": {
        "id": 1132414
      },
      "writtenOn": "2020-01-21T17:32:52Z",
      "side": 1,
      "message": "\u003e Righnt.\n\n*Right.\n\n(wow, that was a weird typo)",
      "parentUuid": "9831e8ea_a2fcf362",
      "range": {
        "startLine": 39,
        "startChar": 0,
        "endLine": 43,
        "endChar": 2
      },
      "revId": "a932b54481960ea1118b70aa089f26552c6a8cbb",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "fdbdb439_ffc49907",
        "filename": "src/chromiumos/tast/local/bundles/cros/network/wpa_sanity.go",
        "patchSetId": 2
      },
      "lineNbr": 47,
      "author": {
        "id": 1132414
      },
      "writtenOn": "2020-01-16T02:40:24Z",
      "side": 1,
      "message": "how about dumping the unexpected output here?",
      "range": {
        "startLine": 47,
        "startChar": 11,
        "endLine": 47,
        "endChar": 44
      },
      "revId": "a932b54481960ea1118b70aa089f26552c6a8cbb",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "eff69ddb_ff9064e3",
        "filename": "src/chromiumos/tast/local/bundles/cros/network/wpa_sanity.go",
        "patchSetId": 2
      },
      "lineNbr": 47,
      "author": {
        "id": 1001853
      },
      "writtenOn": "2020-01-16T03:00:02Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "fdbdb439_ffc49907",
      "range": {
        "startLine": 47,
        "startChar": 11,
        "endLine": 47,
        "endChar": 44
      },
      "revId": "a932b54481960ea1118b70aa089f26552c6a8cbb",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    }
  ]
}