{
  "comments": [
    {
      "unresolved": false,
      "key": {
        "uuid": "def3915f_0bb5fcf8",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 3
      },
      "lineNbr": 0,
      "author": {
        "id": 1411497
      },
      "writtenOn": "2020-12-16T12:39:04Z",
      "side": 1,
      "message": "This commit fix the bug reported at http://b/149921859#comment9 and reverts the commit again.\nThe diff from previous commit (https://crrev.com/c/2232379) is http://crrev/c/2594929/1..2\n\nShao-Chuan, could I ask you to check whether it\u0027s correctly fixed, or tell me environments which you could reproduce it on? I couldn\u0027t reproduce the bug on my DUTs (rammus-arc-r and kukui-arc-r) with just `$ tast run localhost:9222 arc.BuildProperties.vm arc.CheckAndroidVersion.vm`. Thank you!",
      "revId": "cb0e93f616857b5c19e564a767fdd64f4accbcad",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "2402d1ca_0b61b0a0",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 3
      },
      "lineNbr": 0,
      "author": {
        "id": 1145774
      },
      "writtenOn": "2020-12-17T01:04:02Z",
      "side": 1,
      "message": "Without the revert I was able to reproduce said failure on both rammus-arc-r and betty-arc-r R89-13666.0.0.\nIt\u0027s *not* that tests themselves are failing, but the arc_booted precondition is not being reused across tests, resulting in ui restart before running each test.\n\nRunning arc.BuildProperties.vm and arc.CheckAndroidVersion.vm is sufficient to reproduce this since the latter will attempt to reuse the ARC session from the former. If the session is being reused you\u0027ll see the following in logs\n\n2020/12/17 09:52:12 Started test arc.CheckAndroidVersion.vm\n2020/12/17 09:52:12 [09:52:12.275] Preparing precondition \"arc_booted\"\n2020/12/17 09:52:12 [09:52:12.394] Resetting Chrome\u0027s state\n2020/12/17 09:52:12 [09:52:12.400] Reloading the extension process\n2020/12/17 09:52:12 [09:52:12.429] Reusing existing ARC session\n\nWithout the revert Tast is unable to reuse the precondition, logs show\n\n2020/12/17 09:43:49 Started test arc.CheckAndroidVersion.vm\n2020/12/17 09:43:49 [09:43:49.050] Preparing precondition \"arc_booted\"\n2020/12/17 09:43:49 [09:43:49.174] Resetting Chrome\u0027s state\n2020/12/17 09:43:49 [09:43:49.180] Reloading the extension process\n2020/12/17 09:43:49 [09:43:49.209] Failed to reuse existing ARC session: failed to update the connection to ARC: failed to save logfiles: [failed to exec the command to save console output: open /usr/local/tmp/tast_out.20201217-094254.887331107/arc.BuildProperties.vm/arcvm-console.txt: no such file or directory]\n2020/12/17 09:43:49 [09:43:49.228] Restarting ui job",
      "parentUuid": "def3915f_0bb5fcf8",
      "revId": "cb0e93f616857b5c19e564a767fdd64f4accbcad",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "5f47bdd7_0ce9a04b",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 3
      },
      "lineNbr": 0,
      "author": {
        "id": 1411497
      },
      "writtenOn": "2020-12-17T08:22:09Z",
      "side": 1,
      "message": "Thank you for explanation!\nI tried it again on rammus-arc-r and R89-13666.0.0, however it is not reproduced while Tast says \"Reusing existing ARC session\".\n\nThis is the log of Tast without the revert.\n\n```\n$ tast run my_crbook arc.BuildProperties.vm arc.CheckAndroidVersion.vm\n...\n2020/12/17 16:46:30 Completed test arc.BuildProperties.vm in 53.33s with 0 error(s)\n2020/12/17 16:46:30 Started test arc.CheckAndroidVersion.vm\n2020/12/17 16:46:30 [16:46:30.432] Preparing precondition \"arc_booted\"\n2020/12/17 16:46:30 [16:46:30.558] Resetting Chrome\u0027s state\n2020/12/17 16:46:30 [16:46:30.563] Reloading the extension process\n2020/12/17 16:46:30 [16:46:30.597] Reusing existing ARC session\n2020/12/17 16:46:30 [16:46:30.650] Closing precondition \"arc_booted\"\n2020/12/17 16:46:30 Completed test arc.CheckAndroidVersion.vm in 240ms with 0 error(s)\n2020/12/17 16:46:30 Ran 2 local test(s) in 55.511s\n2020/12/17 16:46:31 Starting /tmp/tast/build/host/remote_test_runner locally\n2020/12/17 16:46:31 Ran 0 remote test(s) in 161ms\n2020/12/17 16:46:33 --------------------------------------------------------------------------------\n2020/12/17 16:46:33 arc.BuildProperties.vm      [ PASS ]\n2020/12/17 16:46:33 arc.CheckAndroidVersion.vm  [ PASS ]\n2020/12/17 16:46:33 --------------------------------------------------------------------------------\n2020/12/17 16:46:33 Results saved to /tmp/tast/results/20201217-164530\n\n$ ls /tmp/tast/results/20201217-164530/tests/*/arcvm-console.txt\n/tmp/tast/results/20201217-164530/tests/arc.BuildProperties.vm/arcvm-console.txt\n/tmp/tast/results/20201217-164530/tests/arc.CheckAndroidVersion.vm/arcvm-console.txt\n```",
      "parentUuid": "2402d1ca_0b61b0a0",
      "revId": "cb0e93f616857b5c19e564a767fdd64f4accbcad",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "cb146b8b_406beddc",
        "filename": "src/chromiumos/tast/local/arc/arc.go",
        "patchSetId": 3
      },
      "lineNbr": 149,
      "author": {
        "id": 1145774
      },
      "writtenOn": "2020-12-17T01:04:02Z",
      "side": 1,
      "message": "This is *not* where it failed. See following.",
      "revId": "cb0e93f616857b5c19e564a767fdd64f4accbcad",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "3441a112_7c14398b",
        "filename": "src/chromiumos/tast/local/arc/arc.go",
        "patchSetId": 3
      },
      "lineNbr": 149,
      "author": {
        "id": 1411497
      },
      "writtenOn": "2020-12-17T08:22:09Z",
      "side": 1,
      "message": "Okay. I removed this change.",
      "parentUuid": "cb146b8b_406beddc",
      "revId": "cb0e93f616857b5c19e564a767fdd64f4accbcad",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "e3a1ad44_0e2482d2",
        "filename": "src/chromiumos/tast/local/arc/arc.go",
        "patchSetId": 3
      },
      "lineNbr": 343,
      "author": {
        "id": 1145774
      },
      "writtenOn": "2020-12-17T01:04:02Z",
      "side": 1,
      "message": "The failure happens here. In my example running arc.BuildProperties.vm and arc.CheckAndroidVersion.vm, when resetOutDir is called from preImpl.Prepare(), |outDir| is the tempdir for arc.CheckAndroidVersion.vm while |a.outDir| is the previous tempdir for arc.BuildProperties.vm.\n\nI\u0027m suspecting that when Tast reaches here |a.outDir| is already cleaned up, resulting in the error. You probably don\u0027t want to simply skip if |a.outDir| exists, which means to drop arcvm-console.txt for all but the last test reusing the same precondition.",
      "revId": "cb0e93f616857b5c19e564a767fdd64f4accbcad",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "d0d1e131_214081ca",
        "filename": "src/chromiumos/tast/local/arc/arc.go",
        "patchSetId": 3
      },
      "lineNbr": 343,
      "author": {
        "id": 1411497
      },
      "writtenOn": "2020-12-17T08:22:09Z",
      "side": 1,
      "message": "Thank you for telling the location of failure. For now, I moved the check of the existence of outDir here.\n\narcvm-console.txt may be dropped but I don\u0027t know how to avoid it. I couldn\u0027t know the condition to reproduce the error yet. Openning *os.File before outDir is cleaned up and using the handler may solve this issue?",
      "parentUuid": "e3a1ad44_0e2482d2",
      "revId": "cb0e93f616857b5c19e564a767fdd64f4accbcad",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "943e5fc0_beda0aca",
        "filename": "src/chromiumos/tast/local/arc/arc.go",
        "patchSetId": 3
      },
      "lineNbr": 343,
      "author": {
        "id": 1118346
      },
      "writtenOn": "2020-12-22T03:43:23Z",
      "side": 1,
      "message": "Ah, that\u0027s a good catch. Indeed, when precondition\u0027s Prepare is called, OutDir for the previous test might be already copied to the host and removed. Sorry for not catching this problem earlier...\n\nThis problem is actually solved by fixtures. Fixtures can install post-test hooks where they can save files to a test\u0027s output dir after it ends.\nhttps://source.corp.google.com/chromeos_public/src/platform/tast/src/chromiumos/tast/internal/testing/fixt.go;rcl\u003dd046166708dcfe66d512919eb37e909b9dcc41ab;l\u003d187\n\nThere\u0027s already ARC fixture. You might want to place the new logic to the fixture instead of the precondition.\nhttps://source.corp.google.com/chromeos_public/src/platform/tast-tests/src/chromiumos/tast/local/arc/fixture.go;rcl\u003d083eceb002501d4bc4acf632b4bae3fa1f5ef3b8;l\u003d98",
      "parentUuid": "d0d1e131_214081ca",
      "revId": "cb0e93f616857b5c19e564a767fdd64f4accbcad",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "5da05135_924acf31",
        "filename": "src/chromiumos/tast/local/arc/arc.go",
        "patchSetId": 3
      },
      "lineNbr": 343,
      "author": {
        "id": 1411497
      },
      "writtenOn": "2020-12-22T15:11:17Z",
      "side": 1,
      "message": "PostTest hook of a fixture is the right place to put the code to save log files, but how can I enable the \"arcBooted\" fixture on ARC-related tests? The fixture seems seems not enabled now and the hook is not called.\nhttps://source.corp.google.com/search?q\u003darcBooted%20language:go",
      "parentUuid": "943e5fc0_beda0aca",
      "revId": "cb0e93f616857b5c19e564a767fdd64f4accbcad",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "938dc4ec_6e82b766",
        "filename": "src/chromiumos/tast/local/arc/arc.go",
        "patchSetId": 3
      },
      "lineNbr": 343,
      "author": {
        "id": 1118346
      },
      "writtenOn": "2020-12-23T01:36:07Z",
      "side": 1,
      "message": "We have to update tests to use the fixture instead of the precondition... Hopefully it\u0027s as simple as rewriting test metadata slightly (Pre -\u003e Fixture).",
      "parentUuid": "5da05135_924acf31",
      "revId": "cb0e93f616857b5c19e564a767fdd64f4accbcad",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "f082bc80_0d9f76c2",
        "filename": "src/chromiumos/tast/local/arc/arc.go",
        "patchSetId": 3
      },
      "lineNbr": 343,
      "author": {
        "id": 1000169
      },
      "writtenOn": "2020-12-23T06:26:36Z",
      "side": 1,
      "message": "Is there anyone actively working on replacing the precondition with a fixture?\nThis is blocking a P1 ARCVM bug b/167430147.",
      "parentUuid": "938dc4ec_6e82b766",
      "revId": "cb0e93f616857b5c19e564a767fdd64f4accbcad",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "57c4bfff_cb58ccca",
        "filename": "src/chromiumos/tast/local/arc/arc.go",
        "patchSetId": 3
      },
      "lineNbr": 343,
      "author": {
        "id": 1118346
      },
      "writtenOn": "2020-12-24T02:52:59Z",
      "side": 1,
      "message": "AFAIK there\u0027s no one working on ARC fixture migration. I\u0027ve added the ARC fixture as an example... I\u0027d like someone from ARC team to do migration if it\u0027s necessary.",
      "parentUuid": "f082bc80_0d9f76c2",
      "revId": "cb0e93f616857b5c19e564a767fdd64f4accbcad",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "d01e0634_4c4e283e",
        "filename": "src/chromiumos/tast/local/arc/arc.go",
        "patchSetId": 3
      },
      "lineNbr": 343,
      "author": {
        "id": 1000169
      },
      "writtenOn": "2021-01-06T03:09:09Z",
      "side": 1,
      "message": "Is it possible to solve this problem without migrating all ARC tests to the fixture?\nRewriting all ARC tests may take a long time if we encounter unexpected bugs.",
      "parentUuid": "57c4bfff_cb58ccca",
      "revId": "cb0e93f616857b5c19e564a767fdd64f4accbcad",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "595a9a03_b3c194e8",
        "filename": "src/chromiumos/tast/local/arc/arc.go",
        "patchSetId": 3
      },
      "lineNbr": 343,
      "author": {
        "id": 1118346
      },
      "writtenOn": "2021-01-06T04:54:01Z",
      "side": 1,
      "message": "Unfortunately AFAIK there\u0027s no workaround to run post-test hooks in preconditions. As soon as a test finishes, the framework starts copying output files back to the host. When a precondition\u0027s Prepare is called copying is already in flight.",
      "parentUuid": "d01e0634_4c4e283e",
      "revId": "cb0e93f616857b5c19e564a767fdd64f4accbcad",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "67aab3b8_b961e09b",
        "filename": "src/chromiumos/tast/local/arc/arc.go",
        "patchSetId": 3
      },
      "lineNbr": 343,
      "author": {
        "id": 1411497
      },
      "writtenOn": "2021-01-06T09:02:32Z",
      "side": 1,
      "message": "Now I\u0027m trying to replacing preconditions with the fixture.\nhttps://chromium-review.googlesource.com/c/chromiumos/platform/tast-tests/+/2599687",
      "parentUuid": "595a9a03_b3c194e8",
      "revId": "cb0e93f616857b5c19e564a767fdd64f4accbcad",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    }
  ]
}