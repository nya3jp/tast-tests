#!/usr/bin/env python3
# -*- coding: utf-8 -*-
# Copyright 2020 The Chromium OS Authors. All rights reserved.
# Use of this source code is governed by a BSD-style license that can be
# found in the LICENSE file.

"""Tool for generating go code from automation.js

Used to create src/chromiumos/tast/local/chrome/ui/constants.go.

Usage example:
# ./generate_automation_constants.py \
  /path/to/chromium/src/third_party/closure_compiler/externs/automation.js > \
  /path/to/chromeos/src/platform/tast-tests/src/chromiumos/tast/local/chrome/ui/constants.go

Make sure to apply gofmt for the output of this script.
"""

import sys
import re

HEADER = """\
// Copyright 2020 The Chromium OS Authors. All rights reserved.
// Use of this source code is governed by a BSD-style license that can be
// found in the LICENSE file.

// This file is generated by `tools/generate_automation_constants.py`.

package ui
"""

# Some hardcorded attributes.
# TODO: Generate these definitions as well.
FOOTER = """\
// CheckedState describes the checked state of a chrome.automation AutomationNode.
type CheckedState string

// As defined in https://chromium.googlesource.com/chromium/src/+/refs/heads/master/extensions/common/api/automation.idl
const (
\tCheckedStateTrue  CheckedState = "true"
\tCheckedStateFalse CheckedState = "false"
\tCheckedStateMixed CheckedState = "mixed"
)

// RestrictionState describes the restriction state of a chrome.automation AutomationNode.
type RestrictionState string

// As defined in https://chromium.googlesource.com/chromium/src/+/refs/heads/master/extensions/common/api/automation.idl
const (
\tRestrictionDisabled RestrictionState = "disabled"
\tRestrictionReadOnly RestrictionState = "readOnly"
)
"""


def to_camel_case(snake_case_str):
  return ''.join(s.lower().title() for s in snake_case_str.split('_'))


def print_definitions(lines, typeName, description):
  item_pattern = re.compile(r'\s*(\w*):\s\'(\w*)\'')
  defs = []
  reading = False
  for l in lines:
    if reading:
      match = item_pattern.match(l)
      if not match:
        reading = False
        break
      defs.append((to_camel_case(match.group(1)), match.group(2)))
    elif l.startswith('chrome.automation.{}'.format(typeName)):
      reading = True

  print('// {} describes {}.'.format(typeName, description))
  print('type {} string'.format(typeName))
  print()
  print(
      '// As defined in https://chromium.googlesource.com/chromium/src/+/refs/heads/master/extensions/common/api/automation.idl'
  )
  print('const (')

  for r in defs:
    print('\t{}{} {} = "{}"'.format(typeName, r[0], typeName, r[1]))

  print(')')
  print()


def main(argv):
  with open(argv[1]) as f:
    lines = f.read().split('\n')

  print(HEADER)
  print_definitions(lines, 'StateType',
                    'characteristics of a chrome.automation AutomationNode')
  print_definitions(lines, 'RoleType',
                    'the purpose of a chrome.automation AutomationNode')
  print_definitions(lines, 'EventType',
                    'the type of a chrome.automation AutomationEvent')
  print(FOOTER)


if __name__ == '__main__':
  main(sys.argv)
