{
  "comments": [
    {
      "key": {
        "uuid": "cf0d9bb5_469e1b3b",
        "filename": "src/chromiumos/tast/local/ready/ready.go",
        "patchSetId": 7
      },
      "lineNbr": 326,
      "author": {
        "id": 1126309
      },
      "writtenOn": "2020-02-24T20:45:59Z",
      "side": 1,
      "message": "nit: Typo in \"work\".",
      "range": {
        "startLine": 326,
        "startChar": 21,
        "endLine": 326,
        "endChar": 25
      },
      "revId": "6f7fcdcd697b2658785d639fbc70f091a860c342",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "a1acc388_73944d49",
        "filename": "src/chromiumos/tast/local/ready/ready.go",
        "patchSetId": 7
      },
      "lineNbr": 327,
      "author": {
        "id": 1118346
      },
      "writtenOn": "2020-03-06T08:43:56Z",
      "side": 1,
      "message": "Please let me check my understanding:\n\n- When Tast tests start in the lab, the device might be already enrolled. In this case ready.go can do nothing because it requires a reboot to unenroll the device. This scenario is out of scope of this CL.\n- When Tast tests start in the lab, the device might be non-enrolled but have some policies in /var/lib/whitelist/*. In this case we can remove those files and restart various daemons (e.g. session_manager, chrome) to clear those policies. This scenario is addressed by this CL.\n\nAm I right?",
      "range": {
        "startLine": 327,
        "startChar": 5,
        "endLine": 327,
        "endChar": 18
      },
      "revId": "6f7fcdcd697b2658785d639fbc70f091a860c342",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "269a6759_c52dc980",
        "filename": "src/chromiumos/tast/local/ready/ready.go",
        "patchSetId": 7
      },
      "lineNbr": 327,
      "author": {
        "id": 1368736
      },
      "writtenOn": "2020-03-06T09:09:59Z",
      "side": 1,
      "message": "* Ack\n* The current CL does not restart daemons, it only removes the files. Chrome caches policies, but tests that use it already do not to depend on the state of Chrome.",
      "parentUuid": "a1acc388_73944d49",
      "range": {
        "startLine": 327,
        "startChar": 5,
        "endLine": 327,
        "endChar": 18
      },
      "revId": "6f7fcdcd697b2658785d639fbc70f091a860c342",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "e22da102_c93b5995",
        "filename": "src/chromiumos/tast/local/ready/ready.go",
        "patchSetId": 7
      },
      "lineNbr": 327,
      "author": {
        "id": 1118346
      },
      "writtenOn": "2020-03-06T09:28:31Z",
      "side": 1,
      "message": "OK, thanks for confirming.\n\nThe current code LGTM, but let us clarify some points in comments:\n\n- It is natural assumption for local tests that the device is not enrolled and no device policy is set.\n- It is possible that device is already enrolled, but to unenroll the device we need a reboot, so we can do nothing here.\n- It is possible that device policies are already set, so we attempt to clear them here.\n- Device policies might be cached by daemons even if we delete policy files. Ideally we should reboot the device, but it is not possible. We do nothing for now because Chrome and session_manager should reload the policy when they\u0027re restarted when a Chrome related test runs.",
      "parentUuid": "269a6759_c52dc980",
      "range": {
        "startLine": 327,
        "startChar": 5,
        "endLine": 327,
        "endChar": 18
      },
      "revId": "6f7fcdcd697b2658785d639fbc70f091a860c342",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "0a2babc0_f4ce4546",
        "filename": "src/chromiumos/tast/local/ready/ready.go",
        "patchSetId": 7
      },
      "lineNbr": 330,
      "author": {
        "id": 1126309
      },
      "writtenOn": "2020-02-25T01:40:06Z",
      "side": 1,
      "message": "Another file to consider for deletion might be the Install Attributes file (/home/.shadow/install_attributes.pb + /run/lockbox/install_attributes.pb). For instance, this file is used in a few places to detect whether the device is enrolled, or whether it\u0027s in some other special \"mode\".",
      "range": {
        "startLine": 330,
        "startChar": 25,
        "endLine": 330,
        "endChar": 74
      },
      "revId": "6f7fcdcd697b2658785d639fbc70f091a860c342",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "89174404_7da2d2e6",
        "filename": "src/chromiumos/tast/local/ready/ready.go",
        "patchSetId": 7
      },
      "lineNbr": 330,
      "author": {
        "id": 1126309
      },
      "writtenOn": "2020-02-25T01:40:06Z",
      "side": 1,
      "message": "Actually, it has to be taken into account that the deletion of these files doesn\u0027t flush in-memory state. At least session_manager and Chrome definitely do a caching of policies:\n* http://cs/chromeos_public/src/platform2/login_manager/device_policy_service.h?l\u003d202\u0026rcl\u003d720d60ac0e23db22052cac867f4084308487b4de\n* https://cs.chromium.org/chromium/src/chrome/browser/chromeos/settings/device_settings_service.h?l\u003d265\u0026rcl\u003d4bc2c880d365e020c81e063e86ec5b1920bdcc82\n\nNot every test touches this in-memory state, but if we\u0027re trying to build a generic solution we might want to address this problem as well. A reboot would be an ideal \"resetter\", but it\u0027s probably too expensive (or maybe not, if we only do this when we see some policy set?..). Another approach would be to focus on the session_manager+Chrome case and to make sure that the \"ui\" job is restarted after cleaning the policies.",
      "range": {
        "startLine": 330,
        "startChar": 1,
        "endLine": 330,
        "endChar": 73
      },
      "revId": "6f7fcdcd697b2658785d639fbc70f091a860c342",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "01fd350a_a3af9a47",
        "filename": "src/chromiumos/tast/local/ready/ready.go",
        "patchSetId": 7
      },
      "lineNbr": 330,
      "author": {
        "id": 1306673
      },
      "writtenOn": "2020-02-25T11:05:35Z",
      "side": 1,
      "message": "The problem is that this code is running on the device, so we cannot reboot. If we wanna reboot, I guess it should be part of autotest or tast device provisioning.\n\nAnyway, I guess it\u0027s not a problem to reboot some daemons. But it may be a problem in the future if other daemons will depend on these files.",
      "parentUuid": "89174404_7da2d2e6",
      "range": {
        "startLine": 330,
        "startChar": 1,
        "endLine": 330,
        "endChar": 73
      },
      "revId": "6f7fcdcd697b2658785d639fbc70f091a860c342",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "8a6bafc6_6e6fbd86",
        "filename": "src/chromiumos/tast/local/ready/ready.go",
        "patchSetId": 7
      },
      "lineNbr": 330,
      "author": {
        "id": 1368736
      },
      "writtenOn": "2020-02-25T13:31:06Z",
      "side": 1,
      "message": "Device should not be enrolled at the start of tast tests. The device policy tests that require enrolment clean up after themselves. Clearing enrolment also requires a reboot currently to clear the TPM.\n\nReboots can currently not be done as part of ready.go and it would be a very unexpected event for developers using the tast command.",
      "parentUuid": "0a2babc0_f4ce4546",
      "range": {
        "startLine": 330,
        "startChar": 25,
        "endLine": 330,
        "endChar": 74
      },
      "revId": "6f7fcdcd697b2658785d639fbc70f091a860c342",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "4f45f7cc_66ad0a99",
        "filename": "src/chromiumos/tast/local/ready/ready.go",
        "patchSetId": 7
      },
      "lineNbr": 330,
      "author": {
        "id": 1368736
      },
      "writtenOn": "2020-02-25T13:31:06Z",
      "side": 1,
      "message": "Tests that work with Chrome will restart the appropriate services anyway as they should not depend on their current state (as currently documented). This will refresh policies and log in using a new user and should clear up any stale state on the system left by other tast tests or by autotest.\n\nready.go only runs once when the tast command is executed so it is not the right place to do general cleanup between tests.",
      "parentUuid": "01fd350a_a3af9a47",
      "range": {
        "startLine": 330,
        "startChar": 1,
        "endLine": 330,
        "endChar": 73
      },
      "revId": "6f7fcdcd697b2658785d639fbc70f091a860c342",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "af0fbac4_72fd94c4",
        "filename": "src/chromiumos/tast/local/ready/ready.go",
        "patchSetId": 7
      },
      "lineNbr": 330,
      "author": {
        "id": 1126309
      },
      "writtenOn": "2020-02-25T18:49:46Z",
      "side": 1,
      "message": "Ack, although I\u0027m not quite understanding our overall approach then - I though the main point of this CL is to avoid the need in cleaning up the device policy related state in the tests startup?",
      "parentUuid": "4f45f7cc_66ad0a99",
      "range": {
        "startLine": 330,
        "startChar": 1,
        "endLine": 330,
        "endChar": 73
      },
      "revId": "6f7fcdcd697b2658785d639fbc70f091a860c342",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "169a1686_3def40a3",
        "filename": "src/chromiumos/tast/local/ready/ready.go",
        "patchSetId": 7
      },
      "lineNbr": 330,
      "author": {
        "id": 1126309
      },
      "writtenOn": "2020-02-25T18:49:46Z",
      "side": 1,
      "message": "\u003e Device should not be enrolled at the start of tast tests.\n\u003e The device policy tests that require enrolment clean up after themselves.\n\u003e Clearing enrolment also requires a reboot currently to clear the TPM.\n\nBut if we could rely on that, then this CL wouldn\u0027t be needed, or am I missing something? In b/148005583, we observed the cases where the device policy was set when the test starts, how do you know if it cannot be that the device is enrolled at that point?",
      "parentUuid": "8a6bafc6_6e6fbd86",
      "range": {
        "startLine": 330,
        "startChar": 25,
        "endLine": 330,
        "endChar": 74
      },
      "revId": "6f7fcdcd697b2658785d639fbc70f091a860c342",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba",
      "unresolved": false
    }
  ]
}