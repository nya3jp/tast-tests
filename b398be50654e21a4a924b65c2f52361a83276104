{
  "comments": [
    {
      "unresolved": false,
      "key": {
        "uuid": "b17653df_8b944a8d",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 3
      },
      "lineNbr": 0,
      "author": {
        "id": 1530382
      },
      "writtenOn": "2022-06-06T17:55:32Z",
      "side": 1,
      "message": "Thank you Jie and Hugo for your comments.\n\nI want to make it clear, as I did not previously, that this is a WIP patch. At the end of review I want to able to commit a http package that can be used as a captive portal. Given some of the discussion below, I feel like we could also end up creating a test that uses captive portal as long as the http package is listening on the veth interface. Please correct me if any of this seems like it does not make sense. Let me know what you think!",
      "revId": "b398be50654e21a4a924b65c2f52361a83276104",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "31fa2b6d_c228ea88",
        "filename": "src/chromiumos/tast/local/bundles/cros/network/shill_captive_portal_http.go",
        "patchSetId": 3
      },
      "lineNbr": 69,
      "author": {
        "id": 1364246
      },
      "writtenOn": "2022-06-06T02:25:35Z",
      "side": 1,
      "message": "There might be several other reasons:\n- The veth service is not Connected in shill, so we need to wait for the service state changes (WaitForConnectedOrError() in shill.Service can be used);\n- Even if the service is Connected, it can be triggered by IPv6 and thus IPv4 may be still not ready, so access the IPv4 address in the netns may fail.\n\nPossible solutions for the second point are:\na) Polling the server (curl in this case) until it works (for example, see the routing.ExpectPingSuccessWithTimeout() func in this WIP patch: https://crrev.com/c/3689373) (or perhaps add a function like \"WaitIPv4Ready()\" which use ping to check the IPv4 availability before curl)\nb) Checking the statuc of IPv4 IPConfig object on this service;\nc) Checking the IPv4 address on this interface directly.\n\nBut I don\u0027t have a clear idea on which is the best here (perhaps a)?) now.",
      "range": {
        "startLine": 67,
        "startChar": 0,
        "endLine": 69,
        "endChar": 34
      },
      "revId": "b398be50654e21a4a924b65c2f52361a83276104",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "62462a05_53f7241e",
        "filename": "src/chromiumos/tast/local/bundles/cros/network/shill_captive_portal_http.go",
        "patchSetId": 3
      },
      "lineNbr": 69,
      "author": {
        "id": 1238096
      },
      "writtenOn": "2022-06-06T02:31:47Z",
      "side": 1,
      "message": "If the http request is done with a localhost connection in the test namespace, there shouldn\u0027t be any dependency on the shill state back into the host namespace.\n\n\u003e The curl command fails if the sleep is not here\n\nWhat is the exact failure message / failure code ?\n\n\u003e My assumption is the curl command starts before the http server goes online.\n\t\nAgreed that a first glance this looks like a race condition within the context of the test setup itself. BVut as Jie suggested we would prefer to resolve that with some sort of notification, or we need to poll multiple times, because a single sleep statement might still be not enough some % of the time.",
      "parentUuid": "31fa2b6d_c228ea88",
      "range": {
        "startLine": 67,
        "startChar": 0,
        "endLine": 69,
        "endChar": 34
      },
      "revId": "b398be50654e21a4a924b65c2f52361a83276104",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "098186aa_116735a5",
        "filename": "src/chromiumos/tast/local/bundles/cros/network/shill_captive_portal_http.go",
        "patchSetId": 3
      },
      "lineNbr": 69,
      "author": {
        "id": 1301140
      },
      "writtenOn": "2022-06-07T00:07:49Z",
      "side": 1,
      "message": "+1 to a more event-driven approach",
      "parentUuid": "62462a05_53f7241e",
      "range": {
        "startLine": 67,
        "startChar": 0,
        "endLine": 69,
        "endChar": 34
      },
      "revId": "b398be50654e21a4a924b65c2f52361a83276104",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "79919742_bfe680b5",
        "filename": "src/chromiumos/tast/local/bundles/cros/network/shill_captive_portal_http.go",
        "patchSetId": 3
      },
      "lineNbr": 69,
      "author": {
        "id": 1530382
      },
      "writtenOn": "2022-06-15T21:42:44Z",
      "side": 1,
      "message": "Changed from a sleep to a poll. Thanks for that suggestion as that was something I was unfamiliar with.\n\n| What is the exact failure message / failure code ?\nIt was failing with an exit status code 7 (Failed to connect to host or proxy). My assumption is still that this was a race condition.",
      "parentUuid": "098186aa_116735a5",
      "range": {
        "startLine": 67,
        "startChar": 0,
        "endLine": 69,
        "endChar": 34
      },
      "revId": "b398be50654e21a4a924b65c2f52361a83276104",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "a96b524b_3a2974fa",
        "filename": "src/chromiumos/tast/local/bundles/cros/network/shill_captive_portal_http.go",
        "patchSetId": 3
      },
      "lineNbr": 72,
      "author": {
        "id": 1238096
      },
      "writtenOn": "2022-06-05T16:22:21Z",
      "side": 1,
      "message": "This is not representative of what shill does when doing captive portal detection.\n\nIf the inside of the network namespace plays the role of the captive portal appliance, here you are simulating an http server listening only inside that appliance with a local process running on that appliance and connecting to the local http server.",
      "range": {
        "startLine": 72,
        "startChar": 13,
        "endLine": 72,
        "endChar": 128
      },
      "revId": "b398be50654e21a4a924b65c2f52361a83276104",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "70c965c6_61045825",
        "filename": "src/chromiumos/tast/local/bundles/cros/network/shill_captive_portal_http.go",
        "patchSetId": 3
      },
      "lineNbr": 72,
      "author": {
        "id": 1530382
      },
      "writtenOn": "2022-06-06T17:55:32Z",
      "side": 1,
      "message": "Correct, I totally agree. My original intention with uploading this command was to show that the http web server was in fact running in the netns created. I am unsure if I will be uploading this test (unless others want it up or I make the changes necessary to connect to veth), which I should have made more clear.\n\nThe core focus I was trying to show was the http package and making sure it is in a usable state so later we can leverage it to play the role of the captive portal appliance.",
      "parentUuid": "a96b524b_3a2974fa",
      "range": {
        "startLine": 72,
        "startChar": 13,
        "endLine": 72,
        "endChar": 128
      },
      "revId": "b398be50654e21a4a924b65c2f52361a83276104",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "9edc8c9d_a9985a4b",
        "filename": "src/chromiumos/tast/local/bundles/cros/network/shill_captive_portal_http.go",
        "patchSetId": 3
      },
      "lineNbr": 72,
      "author": {
        "id": 1238096
      },
      "writtenOn": "2022-06-06T21:33:34Z",
      "side": 1,
      "message": "In that case the name of the test should be changed if this patch is intended to be submitted.",
      "parentUuid": "70c965c6_61045825",
      "range": {
        "startLine": 72,
        "startChar": 13,
        "endLine": 72,
        "endChar": 128
      },
      "revId": "b398be50654e21a4a924b65c2f52361a83276104",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "0f1ad8dc_1055f0c2",
        "filename": "src/chromiumos/tast/local/bundles/cros/network/shill_captive_portal_http.go",
        "patchSetId": 3
      },
      "lineNbr": 72,
      "author": {
        "id": 1530382
      },
      "writtenOn": "2022-06-15T21:42:44Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "9edc8c9d_a9985a4b",
      "range": {
        "startLine": 72,
        "startChar": 13,
        "endLine": 72,
        "endChar": 128
      },
      "revId": "b398be50654e21a4a924b65c2f52361a83276104",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "04517db7_f42b045d",
        "filename": "src/chromiumos/tast/local/bundles/cros/network/virtualnet/httpserver/httpserver.go",
        "patchSetId": 3
      },
      "lineNbr": 21,
      "author": {
        "id": 1364246
      },
      "writtenOn": "2022-06-06T02:25:35Z",
      "side": 1,
      "message": "Just curious, what\u0027s our attitude to use Python in tests?",
      "range": {
        "startLine": 21,
        "startChar": 30,
        "endLine": 21,
        "endChar": 37
      },
      "revId": "b398be50654e21a4a924b65c2f52361a83276104",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "4844be7d_6b8d2dae",
        "filename": "src/chromiumos/tast/local/bundles/cros/network/virtualnet/httpserver/httpserver.go",
        "patchSetId": 3
      },
      "lineNbr": 21,
      "author": {
        "id": 1530382
      },
      "writtenOn": "2022-06-06T17:55:32Z",
      "side": 1,
      "message": "Originally I was planning on using go but was unsure on how we could run a go web server in another netns. Python seemed straightforward and easily usable, but I imagine switching between python and go could be confusing. Eventually we will want the web server to eventually respond to requests with different response codes, which is doable in either.\n\nFortunately you uploaded a patchset to allow this: https://chromium-review.googlesource.com/c/chromiumos/platform/tast-tests/+/3691088/1\n\nI think the next step could be use that and run the go web server as a go routine. Let me know what you think about this.",
      "parentUuid": "04517db7_f42b045d",
      "range": {
        "startLine": 21,
        "startChar": 30,
        "endLine": 21,
        "endChar": 37
      },
      "revId": "b398be50654e21a4a924b65c2f52361a83276104",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "35cce377_048aebb1",
        "filename": "src/chromiumos/tast/local/bundles/cros/network/virtualnet/httpserver/httpserver.go",
        "patchSetId": 3
      },
      "lineNbr": 21,
      "author": {
        "id": 1530382
      },
      "writtenOn": "2022-06-15T21:42:44Z",
      "side": 1,
      "message": "The most recent patch did not touch this, but it is in the works in the background.",
      "parentUuid": "4844be7d_6b8d2dae",
      "range": {
        "startLine": 21,
        "startChar": 30,
        "endLine": 21,
        "endChar": 37
      },
      "revId": "b398be50654e21a4a924b65c2f52361a83276104",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "9aef39f5_e22543ed",
        "filename": "src/chromiumos/tast/local/bundles/cros/network/virtualnet/httpserver/httpserver.go",
        "patchSetId": 3
      },
      "lineNbr": 21,
      "author": {
        "id": 1530382
      },
      "writtenOn": "2022-06-24T20:59:58Z",
      "side": 1,
      "message": "Changed to a golang, done.",
      "parentUuid": "35cce377_048aebb1",
      "range": {
        "startLine": 21,
        "startChar": 30,
        "endLine": 21,
        "endChar": 37
      },
      "revId": "b398be50654e21a4a924b65c2f52361a83276104",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "9d31182a_8de19d1c",
        "filename": "src/chromiumos/tast/local/bundles/cros/network/virtualnet/httpserver/httpserver.go",
        "patchSetId": 3
      },
      "lineNbr": 37,
      "author": {
        "id": 1238096
      },
      "writtenOn": "2022-06-05T16:22:21Z",
      "side": 1,
      "message": "Need to be updated ?",
      "range": {
        "startLine": 34,
        "startChar": 0,
        "endLine": 37,
        "endChar": 50
      },
      "revId": "b398be50654e21a4a924b65c2f52361a83276104",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "25806518_f7dd0011",
        "filename": "src/chromiumos/tast/local/bundles/cros/network/virtualnet/httpserver/httpserver.go",
        "patchSetId": 3
      },
      "lineNbr": 37,
      "author": {
        "id": 1530382
      },
      "writtenOn": "2022-06-15T21:42:44Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "9d31182a_8de19d1c",
      "range": {
        "startLine": 34,
        "startChar": 0,
        "endLine": 37,
        "endChar": 50
      },
      "revId": "b398be50654e21a4a924b65c2f52361a83276104",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "3dc6c827_85a0e032",
        "filename": "src/chromiumos/tast/local/bundles/cros/network/virtualnet/httpserver/httpserver.go",
        "patchSetId": 3
      },
      "lineNbr": 55,
      "author": {
        "id": 1238096
      },
      "writtenOn": "2022-06-05T16:22:21Z",
      "side": 1,
      "message": "I am not sure this is the correct setup to achieve here.\n\nThe http server running inside the network namespace created by the test should be listening on the veth interface connected to the one managed by shill on the other side. It should not listen on the localhost of that network namespace.",
      "range": {
        "startLine": 55,
        "startChar": 1,
        "endLine": 55,
        "endChar": 75
      },
      "revId": "b398be50654e21a4a924b65c2f52361a83276104",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "8191a030_d04acb91",
        "filename": "src/chromiumos/tast/local/bundles/cros/network/virtualnet/httpserver/httpserver.go",
        "patchSetId": 3
      },
      "lineNbr": 55,
      "author": {
        "id": 1530382
      },
      "writtenOn": "2022-06-06T17:55:32Z",
      "side": 1,
      "message": "Thank you for pointing this out. Originally, I used this to show that the http package was up and running in the netns. Once I set up the http package to be listening to the veth interface, I can remove this line.",
      "parentUuid": "3dc6c827_85a0e032",
      "range": {
        "startLine": 55,
        "startChar": 1,
        "endLine": 55,
        "endChar": 75
      },
      "revId": "b398be50654e21a4a924b65c2f52361a83276104",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "317a7b56_a33f5716",
        "filename": "src/chromiumos/tast/local/bundles/cros/network/virtualnet/httpserver/httpserver.go",
        "patchSetId": 3
      },
      "lineNbr": 55,
      "author": {
        "id": 1530382
      },
      "writtenOn": "2022-06-15T21:42:44Z",
      "side": 1,
      "message": "I wanted to add here that I intend to remove this on final submission, just wanted it here so the curl works for test. I will remove both this and the curl before final submission. I will leave this as unresolved until done so as a reminder.",
      "parentUuid": "8191a030_d04acb91",
      "range": {
        "startLine": 55,
        "startChar": 1,
        "endLine": 55,
        "endChar": 75
      },
      "revId": "b398be50654e21a4a924b65c2f52361a83276104",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "ea81ba38_9f808170",
        "filename": "src/chromiumos/tast/local/bundles/cros/network/virtualnet/httpserver/httpserver.go",
        "patchSetId": 3
      },
      "lineNbr": 55,
      "author": {
        "id": 1530382
      },
      "writtenOn": "2022-06-24T20:59:58Z",
      "side": 1,
      "message": "Done because the loopback interface bringup has been removed and the http server listens on 0.0.0.0",
      "parentUuid": "317a7b56_a33f5716",
      "range": {
        "startLine": 55,
        "startChar": 1,
        "endLine": 55,
        "endChar": 75
      },
      "revId": "b398be50654e21a4a924b65c2f52361a83276104",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "a36546a5_3ae5eccf",
        "filename": "src/chromiumos/tast/local/bundles/cros/network/virtualnet/virtualnet.go",
        "patchSetId": 3
      },
      "lineNbr": 91,
      "author": {
        "id": 1238096
      },
      "writtenOn": "2022-06-05T16:22:21Z",
      "side": 1,
      "message": "Unless you are pairing this with additional DNAT rules, the server inside the test network namespace has to listen on the veth interface. Or at least it should listen on inaddr_any.",
      "range": {
        "startLine": 91,
        "startChar": 32,
        "endLine": 91,
        "endChar": 41
      },
      "revId": "b398be50654e21a4a924b65c2f52361a83276104",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "64cf2891_5fa0bc45",
        "filename": "src/chromiumos/tast/local/bundles/cros/network/virtualnet/virtualnet.go",
        "patchSetId": 3
      },
      "lineNbr": 91,
      "author": {
        "id": 1364246
      },
      "writtenOn": "2022-06-06T02:25:35Z",
      "side": 1,
      "message": "JFYI, if you need the ipv4 address on the in-interface, I added a |VethInStaticIPv4Addr| variable in https://crrev.com/c/3686429 which can be used. That patch may be changed later though.",
      "parentUuid": "a36546a5_3ae5eccf",
      "range": {
        "startLine": 91,
        "startChar": 32,
        "endLine": 91,
        "endChar": 41
      },
      "revId": "b398be50654e21a4a924b65c2f52361a83276104",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "60750405_bf43f462",
        "filename": "src/chromiumos/tast/local/bundles/cros/network/virtualnet/virtualnet.go",
        "patchSetId": 3
      },
      "lineNbr": 91,
      "author": {
        "id": 1530382
      },
      "writtenOn": "2022-06-06T17:55:32Z",
      "side": 1,
      "message": "Thank you Jie, that appears to be exactly what I am looking for. I can look at implementing that next here.",
      "parentUuid": "64cf2891_5fa0bc45",
      "range": {
        "startLine": 91,
        "startChar": 32,
        "endLine": 91,
        "endChar": 41
      },
      "revId": "b398be50654e21a4a924b65c2f52361a83276104",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "41b0852a_8238c683",
        "filename": "src/chromiumos/tast/local/bundles/cros/network/virtualnet/virtualnet.go",
        "patchSetId": 3
      },
      "lineNbr": 91,
      "author": {
        "id": 1530382
      },
      "writtenOn": "2022-06-15T21:42:44Z",
      "side": 1,
      "message": "Hugo, the patch I sent up forces an address to an ip through dns when it tries to hit the gstatic site. I know you mentioned here that it should listen directly on veth interface. Is that more in line with the behavior of a real captive portal? If so, do you have recommendations on what we could do instead.",
      "parentUuid": "60750405_bf43f462",
      "range": {
        "startLine": 91,
        "startChar": 32,
        "endLine": 91,
        "endChar": 41
      },
      "revId": "b398be50654e21a4a924b65c2f52361a83276104",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "bfdecbe8_c3686dc9",
        "filename": "src/chromiumos/tast/local/bundles/cros/network/virtualnet/virtualnet.go",
        "patchSetId": 3
      },
      "lineNbr": 91,
      "author": {
        "id": 1364246
      },
      "writtenOn": "2022-06-16T02:23:07Z",
      "side": 1,
      "message": "Not sure if I understand the requirement correctly, just some thoughts:\nIt seems to me that the current code set up two subnets inside an Env (one for DHCP  and another for HTTP server), while actually we only have one interface inside that Env and thus only have one address, the two subnets sounds like an unusual setup to me. I guess we should make the HTTP server listening on the address which is on the in-interface of the Env.\n \nIf this is the case (HTTP server should listen on the interface IP which is used as the gateway in the DHCP subnet), I would suggest:\n1) In dnsmasq.go, Start() installs static ip (gateway ip) at first, and then uses this ip to populate the \"Address\" property in dnsmasq (i.e., \"/${AddressToForceIP}/${gateway ip}\"). We always want to force the domain to this gateway IP in this captive portal case IIUC.\n2) In CreateCaptivePortalEnv(), after starting the dnsmasq server, read the gateway ip by env.GetVethInAddrs(), and let HTTP server to listen on this ip (let it listen  on 0.0.0.0 should also work I assume). \n\nWDYT?",
      "parentUuid": "41b0852a_8238c683",
      "range": {
        "startLine": 91,
        "startChar": 32,
        "endLine": 91,
        "endChar": 41
      },
      "revId": "b398be50654e21a4a924b65c2f52361a83276104",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "1af3002f_2bec44bd",
        "filename": "src/chromiumos/tast/local/bundles/cros/network/virtualnet/virtualnet.go",
        "patchSetId": 3
      },
      "lineNbr": 91,
      "author": {
        "id": 1530382
      },
      "writtenOn": "2022-06-16T19:40:35Z",
      "side": 1,
      "message": "Great suggestion. I think my previous implementation came from a misunderstanding. Thanks so much for the suggestion. Let me know how it looks!",
      "parentUuid": "bfdecbe8_c3686dc9",
      "range": {
        "startLine": 91,
        "startChar": 32,
        "endLine": 91,
        "endChar": 41
      },
      "revId": "b398be50654e21a4a924b65c2f52361a83276104",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "aa00c242_1813414f",
        "filename": "src/chromiumos/tast/local/bundles/cros/network/virtualnet/virtualnet.go",
        "patchSetId": 3
      },
      "lineNbr": 91,
      "author": {
        "id": 1364246
      },
      "writtenOn": "2022-06-17T02:39:27Z",
      "side": 1,
      "message": "LGTM about setting up the Env now. Thanks for polishing the code!",
      "parentUuid": "1af3002f_2bec44bd",
      "range": {
        "startLine": 91,
        "startChar": 32,
        "endLine": 91,
        "endChar": 41
      },
      "revId": "b398be50654e21a4a924b65c2f52361a83276104",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    }
  ]
}