{
  "comments": [
    {
      "unresolved": true,
      "key": {
        "uuid": "31fa2b6d_c228ea88",
        "filename": "src/chromiumos/tast/local/bundles/cros/network/shill_captive_portal_http.go",
        "patchSetId": 3
      },
      "lineNbr": 69,
      "author": {
        "id": 1364246
      },
      "writtenOn": "2022-06-06T02:25:35Z",
      "side": 1,
      "message": "There might be several other reasons:\n- The veth service is not Connected in shill, so we need to wait for the service state changes (WaitForConnectedOrError() in shill.Service can be used);\n- Even if the service is Connected, it can be triggered by IPv6 and thus IPv4 may be still not ready, so access the IPv4 address in the netns may fail.\n\nPossible solutions for the second point are:\na) Polling the server (curl in this case) until it works (for example, see the routing.ExpectPingSuccessWithTimeout() func in this WIP patch: https://crrev.com/c/3689373) (or perhaps add a function like \"WaitIPv4Ready()\" which use ping to check the IPv4 availability before curl)\nb) Checking the statuc of IPv4 IPConfig object on this service;\nc) Checking the IPv4 address on this interface directly.\n\nBut I don\u0027t have a clear idea on which is the best here (perhaps a)?) now.",
      "range": {
        "startLine": 67,
        "startChar": 0,
        "endLine": 69,
        "endChar": 34
      },
      "revId": "b398be50654e21a4a924b65c2f52361a83276104",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "62462a05_53f7241e",
        "filename": "src/chromiumos/tast/local/bundles/cros/network/shill_captive_portal_http.go",
        "patchSetId": 3
      },
      "lineNbr": 69,
      "author": {
        "id": 1238096
      },
      "writtenOn": "2022-06-06T02:31:47Z",
      "side": 1,
      "message": "If the http request is done with a localhost connection in the test namespace, there shouldn\u0027t be any dependency on the shill state back into the host namespace.\n\n\u003e The curl command fails if the sleep is not here\n\nWhat is the exact failure message / failure code ?\n\n\u003e My assumption is the curl command starts before the http server goes online.\n\t\nAgreed that a first glance this looks like a race condition within the context of the test setup itself. BVut as Jie suggested we would prefer to resolve that with some sort of notification, or we need to poll multiple times, because a single sleep statement might still be not enough some % of the time.",
      "parentUuid": "31fa2b6d_c228ea88",
      "range": {
        "startLine": 67,
        "startChar": 0,
        "endLine": 69,
        "endChar": 34
      },
      "revId": "b398be50654e21a4a924b65c2f52361a83276104",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "a96b524b_3a2974fa",
        "filename": "src/chromiumos/tast/local/bundles/cros/network/shill_captive_portal_http.go",
        "patchSetId": 3
      },
      "lineNbr": 72,
      "author": {
        "id": 1238096
      },
      "writtenOn": "2022-06-05T16:22:21Z",
      "side": 1,
      "message": "This is not representative of what shill does when doing captive portal detection.\n\nIf the inside of the network namespace plays the role of the captive portal appliance, here you are simulating an http server listening only inside that appliance with a local process running on that appliance and connecting to the local http server.",
      "range": {
        "startLine": 72,
        "startChar": 13,
        "endLine": 72,
        "endChar": 128
      },
      "revId": "b398be50654e21a4a924b65c2f52361a83276104",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "04517db7_f42b045d",
        "filename": "src/chromiumos/tast/local/bundles/cros/network/virtualnet/httpserver/httpserver.go",
        "patchSetId": 3
      },
      "lineNbr": 21,
      "author": {
        "id": 1364246
      },
      "writtenOn": "2022-06-06T02:25:35Z",
      "side": 1,
      "message": "Just curious, what\u0027s our attitude to use Python in tests?",
      "range": {
        "startLine": 21,
        "startChar": 30,
        "endLine": 21,
        "endChar": 37
      },
      "revId": "b398be50654e21a4a924b65c2f52361a83276104",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "9d31182a_8de19d1c",
        "filename": "src/chromiumos/tast/local/bundles/cros/network/virtualnet/httpserver/httpserver.go",
        "patchSetId": 3
      },
      "lineNbr": 37,
      "author": {
        "id": 1238096
      },
      "writtenOn": "2022-06-05T16:22:21Z",
      "side": 1,
      "message": "Need to be updated ?",
      "range": {
        "startLine": 34,
        "startChar": 0,
        "endLine": 37,
        "endChar": 50
      },
      "revId": "b398be50654e21a4a924b65c2f52361a83276104",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "3dc6c827_85a0e032",
        "filename": "src/chromiumos/tast/local/bundles/cros/network/virtualnet/httpserver/httpserver.go",
        "patchSetId": 3
      },
      "lineNbr": 55,
      "author": {
        "id": 1238096
      },
      "writtenOn": "2022-06-05T16:22:21Z",
      "side": 1,
      "message": "I am not sure this is the correct setup to achieve here.\n\nThe http server running inside the network namespace created by the test should be listening on the veth interface connected to the one managed by shill on the other side. It should not listen on the localhost of that network namespace.",
      "range": {
        "startLine": 55,
        "startChar": 1,
        "endLine": 55,
        "endChar": 75
      },
      "revId": "b398be50654e21a4a924b65c2f52361a83276104",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "a36546a5_3ae5eccf",
        "filename": "src/chromiumos/tast/local/bundles/cros/network/virtualnet/virtualnet.go",
        "patchSetId": 3
      },
      "lineNbr": 91,
      "author": {
        "id": 1238096
      },
      "writtenOn": "2022-06-05T16:22:21Z",
      "side": 1,
      "message": "Unless you are pairing this with additional DNAT rules, the server inside the test network namespace has to listen on the veth interface. Or at least it should listen on inaddr_any.",
      "range": {
        "startLine": 91,
        "startChar": 32,
        "endLine": 91,
        "endChar": 41
      },
      "revId": "b398be50654e21a4a924b65c2f52361a83276104",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "64cf2891_5fa0bc45",
        "filename": "src/chromiumos/tast/local/bundles/cros/network/virtualnet/virtualnet.go",
        "patchSetId": 3
      },
      "lineNbr": 91,
      "author": {
        "id": 1364246
      },
      "writtenOn": "2022-06-06T02:25:35Z",
      "side": 1,
      "message": "JFYI, if you need the ipv4 address on the in-interface, I added a |VethInStaticIPv4Addr| variable in https://crrev.com/c/3686429 which can be used. That patch may be changed later though.",
      "parentUuid": "a36546a5_3ae5eccf",
      "range": {
        "startLine": 91,
        "startChar": 32,
        "endLine": 91,
        "endChar": 41
      },
      "revId": "b398be50654e21a4a924b65c2f52361a83276104",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    }
  ]
}